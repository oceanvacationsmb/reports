<!DOCTYPE html>
<html>
<head>
<title>Ocean Vacations - Reservation Report</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial;background:#f5f5f5;color:#000;display:flex}.sidebar{width:280px;background:#333;color:#fff;padding:20px;height:100vh;overflow-y:auto;position:fixed;left:0;top:0}.sidebar h3{margin-bottom:20px;font-size:16px;border-bottom:2px solid #fff;padding-bottom:10px}.section{margin-bottom:20px}.label{font-size:11px;font-weight:bold;color:#aaa;margin-bottom:5px;display:block}select,input{width:100%;padding:8px;margin:5px 0;border:1px solid #555;background:#444;color:#fff;border-radius:3px;font-size:11px}.btn{width:100%;padding:12px;margin:8px 0;border:none;font-weight:bold;border-radius:3px;cursor:pointer;font-size:12px;color:#fff;text-transform:uppercase}.btn-primary{background:#000}.btn-success{background:#28a745}.btn-warning{background:#ff9800}.btn-info{background:#17a2b8}.btn-danger{background:#dc3545}.main{margin-left:280px;padding:20px;width:calc(100% - 280px)}.page{background:#fff;padding:40px;border-radius:5px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}.invoice-header{display:flex;justify-content:space-between;margin-bottom:40px;border-bottom:2px solid #000;padding-bottom:30px}.company-info{font-size:11px;line-height:1.8}.company-name{font-size:20px;font-weight:bold;margin-bottom:5px}.report-title{text-align:center;font-size:32px;font-weight:bold;margin:40px 0 10px 0;letter-spacing:2px}.owner-name{text-align:center;font-size:28px;margin-bottom:40px;font-weight:bold;color:#000}table{width:100%;border-collapse:collapse;margin:20px 0;font-size:11px}th,td{border:1px solid #e0e0e0;padding:12px;text-align:left}th{background:#f5f5f5;color:#000;font-weight:bold;text-transform:uppercase}tr:nth-child(even){background:#fafafa}.action-buttons{display:flex;gap:10px;margin:20px 0;justify-content:center;flex-wrap:wrap}.action-buttons button{padding:10px 20px;font-size:12px;cursor:pointer;border:none;border-radius:3px;color:#fff;font-weight:bold;text-transform:uppercase}.back-btn{background:#666}.print-btn{background:#e74c3c}.property-section{margin:40px 0;padding:20px;border:1px solid #ddd;border-radius:5px;background:#fff}.property-title{font-size:14px;font-weight:bold;margin-bottom:15px;display:flex;align-items:center;text-transform:uppercase}.property-icon{font-size:18px;margin-right:10px}.summary-title{font-size:12px;font-weight:bold;text-transform:uppercase;text-align:center;margin:20px 0}.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin:20px 0}.summary-card{background:#f9f9f9;border:1px solid #ddd;padding:12px;text-align:center;border-radius:5px}.summary-label{font-size:10px;color:#666;font-weight:bold;text-transform:uppercase}.summary-value{font-size:14px;font-weight:bold;color:#000;margin-top:6px}.attachment{background:#f0f0f0;padding:10px;margin:10px 0;border-radius:3px;font-size:10px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}.attachment-left{flex:1}.attachment-actions{display:flex;gap:5px;flex-wrap:wrap}.modal{display:none;position:fixed;z-index:1001;left:50%;top:50%;transform:translate(-50%,-50%);width:90%;max-width:500px;background:#333;color:#fff;border-radius:8px;padding:30px;box-shadow:0 4px 20px rgba(0,0,0,0.3);max-height:90vh;overflow-y:auto}.modal.show{display:block}.modal-title{font-size:20px;font-weight:bold;margin-bottom:20px;text-transform:uppercase;text-align:center;border-bottom:2px solid #fff;padding-bottom:15px}.modal-field{margin-bottom:15px}.modal-label{font-size:11px;font-weight:bold;color:#aaa;margin-bottom:8px;display:block;text-transform:uppercase}.modal-input{width:100%;padding:10px;border:1px solid #555;background:#444;color:#fff;border-radius:3px;font-size:11px}.modal-actions{display:flex;gap:10px;margin-top:25px}.modal-actions button{flex:1;padding:12px;border:none;font-weight:bold;border-radius:3px;cursor:pointer;font-size:12px;color:#fff;text-transform:uppercase}.btn-add{background:#28a745}.btn-cancel{background:#666}.btn-save{background:#0066cc}.modal-overlay{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.7)}.modal-overlay.show{display:block}.copy-link-btn{background:#0066cc;color:#fff;padding:10px 15px;border:none;border-radius:3px;cursor:pointer;font-weight:bold;margin:10px 0;width:100%;text-transform:uppercase}.commission-box{background:#fff3cd;border:2px solid #ffc107;padding:15px;margin:15px 0;border-radius:5px}.commission-box-title{font-size:14px;font-weight:bold;color:#856404;margin-bottom:10px;text-transform:uppercase;text-align:center}.calc-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #ddd}.calc-row-total{display:flex;justify-content:space-between;padding:12px;background:#000;color:#fff;font-weight:bold}.pmc-transfer-box{background:#d4edda;border:2px solid #28a745;padding:15px;margin:15px 0;border-radius:5px}.pmc-transfer-title{font-size:14px;font-weight:bold;color:#155724;margin-bottom:10px;text-transform:uppercase;text-align:center}.pmc-transfer-amount{font-size:18px;font-weight:bold;color:#155724;text-align:center}.tax-table{width:100%;border-collapse:collapse;font-size:11px;margin-top:10px}.tax-table th{background:#333;color:#fff;font-weight:bold;text-align:center;border:1px solid #000;padding:8px}.tax-table td{border:1px solid #000;padding:8px;text-align:left}.tax-info{background:#e8f4f8;border:2px solid #17a2b8;padding:15px;margin:15px 0;border-radius:5px}.tax-info-title{font-size:14px;font-weight:bold;color:#0c5460;margin-bottom:10px;text-transform:uppercase;text-align:center}.section-title{font-size:12px;font-weight:bold;text-transform:uppercase;margin-top:20px;margin-bottom:10px;color:#000}.invoice-btn{background:#17a2b8;color:#fff;padding:3px 8px;border:none;border-radius:3px;cursor:pointer;font-size:9px;font-weight:bold}.btn-small{padding:5px 10px;font-size:9px;width:auto;margin:0;display:inline-block;text-transform:uppercase}.settings-header{color:#fff;margin:20px 0 10px 0;font-size:12px;font-weight:bold;text-transform:uppercase;border-top:2px solid #555;padding-top:15px}.token-status{padding:8px;margin:8px 0;border-radius:3px;text-align:center;font-size:11px;font-weight:bold}.token-active{background:#28a745;color:#fff}.token-inactive{background:#dc3545;color:#fff}@media print{.sidebar,.back-btn,.print-btn,.copy-link-btn{display:none}.main{margin-left:0;width:100%}.page{padding:20px}}
</style>
</head>
<body>
<div class="sidebar"><h3>üéØ OCEAN VACATIONS</h3>
<div id="tokenStatus" class="token-status token-inactive">üî¥ LOADING...</div>
<div class="section"><label class="label">SELECT OWNER</label><select id="ownerSelect" onchange="onOwnerChange()"><option value="">-- SELECT --</option></select></div>
<div class="section"><label class="label">MONTH</label><select id="monthSelect"></select></div>
<div class="section"><label class="label">YEAR</label><select id="yearSelect"></select></div>
<div class="section"><label class="label">UPLOAD CSV</label><input type="file" id="csvFile" accept=".csv"></div>
<button class="btn btn-primary" onclick="generateStatement()">‚ñ∂ STATEMENT</button>
<button class="btn btn-success" onclick="openAddExpense()" style="font-size:13px;font-weight:bold">üí∞ ADD EXPENSE</button>
<button class="btn btn-success" onclick="generateSummary()">üìä SUMMARY REPORT</button>
<div class="settings-header">‚öôÔ∏è SETTINGS</div>
<button class="btn btn-info" onclick="openOwners()" style="font-size:11px">‚öôÔ∏è OWNER SETTINGS</button>
<button class="btn btn-info" onclick="openTax()" style="font-size:11px">‚öôÔ∏è TAX SETTINGS</button>
<button class="btn btn-info" onclick="openVendorSettings()" style="font-size:11px">üè¢ VENDORS</button>
<hr style="border:1px solid #555;margin:20px 0">
<button class="btn btn-warning" onclick="setupToken()" style="font-size:11px">üîë GITHUB SETUP</button>
<button class="btn btn-warning" onclick="setupDropbox()" style="font-size:11px">üìÅ DROPBOX SETUP</button>
</div>

<div id="modalOverlay" class="modal-overlay" onclick="closeAll()"></div>

<div id="ownerModal" class="modal"><div><div class="modal-title">‚öôÔ∏è OWNER MANAGEMENT</div>
<div class="modal-field"><label class="modal-label">OWNER NAME</label><input type="text" id="ownerName" class="modal-input" placeholder="Owner Name"></div>
<div class="modal-field"><label class="modal-label">EMAIL</label><input type="email" id="ownerEmail" class="modal-input" placeholder="Email"></div>
<div class="modal-field"><label class="modal-label">COMMISSION %</label><input type="number" id="ownerComm" class="modal-input" placeholder="Commission %" step="0.01"></div>
<div class="modal-field"><label class="modal-label">SALES FEE %</label><input type="number" id="ownerSales" class="modal-input" placeholder="Sales Fee %" step="0.01"></div>
<div class="modal-field"><label class="modal-label">TYPE</label><select id="ownerType" class="modal-input"><option value="draft">DRAFT</option><option value="payout">PAYOUT</option></select></div>
<button class="btn btn-success" onclick="addOwner()" style="width:100%;margin-bottom:20px">‚ûï ADD OWNER</button>
<div id="ownersList" style="max-height:350px;overflow-y:auto;margin-bottom:20px"></div>
<div class="modal-actions"><button class="btn-save" onclick="saveOwnerData()">üíæ SAVE ALL</button><button class="btn-cancel" onclick="closeAll()">‚úó CLOSE</button></div>
</div></div>

<div id="taxModal" class="modal"><div><div class="modal-title">‚öôÔ∏è TAX SETTINGS</div>
<div id="taxContent" style="max-height:400px;overflow-y:auto;margin-bottom:20px"></div>
<div class="modal-actions"><button class="btn-save" onclick="saveTaxData()">üíæ SAVE ALL</button><button class="btn-cancel" onclick="closeAll()">‚úó CLOSE</button></div>
</div></div>

<div id="vendorSettingsModal" class="modal"><div><div class="modal-title">üè¢ VENDOR MANAGEMENT</div>
<div class="modal-field"><label class="modal-label">VENDOR NAME</label><input type="text" id="vendorNameInput" class="modal-input" placeholder="Vendor Name"></div>
<div class="modal-field"><label class="modal-label">PHONE/EMAIL</label><input type="text" id="vendorPhoneInput" class="modal-input" placeholder="Phone/Email"></div>
<button class="btn btn-success" onclick="addNewVendor()" style="width:100%;margin-bottom:20px">‚ûï ADD VENDOR</button>
<div id="vendorSettingsList" style="max-height:350px;overflow-y:auto;margin-bottom:20px"></div>
<div class="modal-actions"><button class="btn-save" onclick="saveVendorData()">üíæ SAVE ALL</button><button class="btn-cancel" onclick="closeAll()">‚úó CLOSE</button></div>
</div></div>

<div id="expenseModal" class="modal"><div><div class="modal-title">üí∞ ADD EXPENSE</div>
<div class="modal-field"><label class="modal-label">TYPE</label><select id="expenseType" class="modal-input"><option>MAINTENANCE</option><option>REPAIR</option><option>PURCHASE</option><option>SUPPLIES</option><option>SERVICE</option><option>POOL CLEANING</option><option>PEST CONTROL</option><option>CREDIT</option><option>ADJUSTMENT</option></select></div>
<div class="modal-field"><label class="modal-label">PROPERTY</label><select id="expenseProperty" class="modal-input"></select></div>
<div class="modal-field"><label class="modal-label">VENDOR</label><select id="expenseVendor" class="modal-input"></select></div>
<div class="modal-field"><label class="modal-label">AMOUNT</label><input type="number" id="expenseAmount" class="modal-input" placeholder="0.00" step="0.01"></div>
<div class="modal-field"><label class="modal-label">NOTES</label><input type="text" id="expenseNotes" class="modal-input" placeholder="Optional notes"></div>
<div class="modal-actions"><button class="btn-add" onclick="submitExpense()">‚úì ADD EXPENSE</button><button class="btn-cancel" onclick="closeAll()">‚úó CANCEL</button></div>
</div></div>

<div class="main"><div id="content" class="page"><div class="invoice-header"><div class="company-info"><div class="company-name">OCEAN VACATIONS</div><div>www.oceanvacationsmb.com</div><div>oceanvacationsmb@gmail.com</div><div>843-222-6516</div></div><div class="right-header"><div class="statement-date" id="statementDate"></div><div class="period-date" id="periodDate"></div></div></div><div class="report-title" id="reportTitle">RESERVATION REPORT</div><div class="owner-name" id="ownerTitle"></div><div id="mainContent"><div style="text-align:center;padding:40px;color:#666">Loading data from GitHub...</div></div></div></div>

<script>
const GITHUB_URL="https://raw.githubusercontent.com/oceanvacationsmb/reports/main/data.json";
const GITHUB_API="https://api.github.com/repos/oceanvacationsmb/reports/contents/data.json";
let gitHubData={},OWNERS={},vendors=[],expenses=[],csvData=[],propertySettings={},currentOwner="",masterTotals={},propertyTotals={},taxByProperty={},githubToken="";
const municipalities=["SC","MB","NMB","SSB","HC"];

function num(v){return parseFloat((v||"0").toString().replace(/[$,]/g,""))||0;}
function money(v){return"$"+(Number(v)||0).toFixed(2);}

function updateTokenStatus(){
  const status=document.getElementById("tokenStatus");
  if(githubToken){
    status.textContent="üü¢ TOKEN ACTIVE (ocean vacations)";
    status.className="token-status token-active";
  }else{
    status.textContent="üî¥ NO TOKEN";
    status.className="token-status token-inactive";
  }
}

function loadData(){
  fetch(GITHUB_URL+"?t="+Date.now())
    .then(r=>r.json())
    .then(data=>{
      gitHubData=data;
      OWNERS=data.owners||{};
      vendors=data.vendors||[];
      expenses=data.expenses||[];
      propertySettings=data.properties||{};
      githubToken=data.github_token||"";
      console.log("‚úì Data loaded from GitHub");
      console.log("Token:",githubToken?"FOUND":"NOT FOUND");
      init();
      updateTokenStatus();
    })
    .catch(e=>{
      console.error("Error loading data:",e);
      init();
      updateTokenStatus();
    });
}

function init(){
  buildOwners();
  buildMonths();
  buildYears();
  updateVendorDropdown();
  document.getElementById("mainContent").innerHTML="<div style='text-align:center;padding:40px;color:#666'>Ready to use! Select an owner and upload CSV to begin.</div>";
}

function buildOwners(){
  const sel=document.getElementById("ownerSelect");
  sel.innerHTML='<option value="">-- SELECT --</option>';
  Object.keys(OWNERS).sort().forEach(name=>{
    sel.innerHTML+="<option>"+name+"</option>";
  });
}

function buildMonths(){
  const sel=document.getElementById("monthSelect");
  const months=["JANUARY","FEBRUARY","MARCH","APRIL","MAY","JUNE","JULY","AUGUST","SEPTEMBER","OCTOBER","NOVEMBER","DECEMBER"];
  months.forEach((m,i)=>{
    sel.innerHTML+="<option value='"+(i+1)+"'>"+m+"</option>";
  });
  sel.value=new Date().getMonth()+1;
}

function buildYears(){
  const sel=document.getElementById("yearSelect");
  const y=new Date().getFullYear();
  for(let i=y-2;i<=y+2;i++){
    sel.innerHTML+="<option>"+i+"</option>";
  }
  sel.value=y;
}

function onOwnerChange(){
  currentOwner=document.getElementById("ownerSelect").value;
}

function openOwners(){
  const list=document.getElementById("ownersList");
  let html="";
  Object.keys(OWNERS).sort().forEach(name=>{
    const o=OWNERS[name];
    html+="<div style='background:#555;padding:15px;margin:10px 0;border-radius:3px'>";
    html+="<div style='font-weight:bold;color:#fff;margin-bottom:10px'>"+name+"</div>";
    html+="<label class='modal-label'>EMAIL</label>";
    html+="<input type='email' value='"+(o.email||"")+"' onchange=\"OWNERS['"+name+"'].email=this.value\" class='modal-input'>";
    html+="<label class='modal-label'>COMMISSION %</label>";
    html+="<input type='number' step='0.01' value='"+(o.percent*100)+"' onchange=\"OWNERS['"+name+"'].percent=this.value/100\" class='modal-input'>";
    html+="<label class='modal-label'>SALES FEE %</label>";
    html+="<input type='number' step='0.01' value='"+o.salesFeePercent+"' onchange=\"OWNERS['"+name+"'].salesFeePercent=this.value\" class='modal-input'>";
    html+="<label class='modal-label'>TYPE</label>";
    html+="<select onchange=\"OWNERS['"+name+"'].type=this.value\" class='modal-input'>";
    html+="<option value='draft' "+(o.type==='draft'?'selected':'')+">DRAFT</option>";
    html+="<option value='payout' "+(o.type==='payout'?'selected':'')+">PAYOUT</option>";
    html+="</select>";
    html+="<button class='btn btn-danger' onclick=\"deleteOwner('"+name+"')\" style='width:100%;margin-top:10px;padding:8px'>üóëÔ∏è DELETE OWNER</button>";
    html+="</div>";
  });
  list.innerHTML=html;
  openModal("ownerModal");
}

function addOwner(){
  const name=document.getElementById("ownerName").value.trim();
  const email=document.getElementById("ownerEmail").value.trim();
  const comm=parseFloat(document.getElementById("ownerComm").value)||0.12;
  const sales=parseFloat(document.getElementById("ownerSales").value)||5;
  const type=document.getElementById("ownerType").value;
  if(!name)return alert("Enter owner name");
  OWNERS[name]={email:email,percent:comm/100,salesFeePercent:sales,type:type};
  document.getElementById("ownerName").value="";
  document.getElementById("ownerEmail").value="";
  document.getElementById("ownerComm").value="";
  document.getElementById("ownerSales").value="";
  buildOwners();
  openOwners();
}

function deleteOwner(name){
  if(!confirm("Delete owner "+name+"?"))return;
  delete OWNERS[name];
  buildOwners();
  openOwners();
}

function saveOwnerData(){
  if(!githubToken)return alert("GitHub token not set. Click GitHub Setup first.");
  saveToGitHub("owner settings");
}

function openTax(){
  const content=document.getElementById("taxContent");
  let html="";
  Object.keys(OWNERS).sort().forEach(name=>{
    const o=propertySettings[name]||{};
    html+="<div style='background:#555;padding:15px;margin:10px 0;border-radius:3px'>";
    html+="<div style='font-weight:bold;color:#fff;margin-bottom:10px'>"+name+"</div>";
    municipalities.forEach(m=>{
      const checked=o[m]?"checked":"";
      html+="<label style='color:#fff;display:flex;align-items:center;margin:8px 0;cursor:pointer'>";
      html+="<input type='checkbox' "+checked+" onchange=\"if(!propertySettings['"+name+"'])propertySettings['"+name+"']={};propertySettings['"+name+"']['"+m+"']=this.checked\">";
      html+="<span style='margin-left:8px'>"+m+"</span>";
      html+="</label>";
    });
    html+="</div>";
  });
  content.innerHTML=html;
  openModal("taxModal");
}

function saveTaxData(){
  if(!githubToken)return alert("GitHub token not set. Click GitHub Setup first.");
  saveToGitHub("tax settings");
}

function openVendorSettings(){
  const list=document.getElementById("vendorSettingsList");
  let html="";
  vendors.forEach(v=>{
    html+="<div style='background:#555;padding:12px;margin:8px 0;border-radius:3px;display:flex;justify-content:space-between;align-items:center'>";
    html+="<div>";
    html+="<div style='color:#fff;font-weight:bold'>"+v.name+"</div>";
    html+="<div style='color:#aaa;font-size:10px'>"+v.phone+"</div>";
    html+="</div>";
    html+="<button class='btn btn-danger' onclick='deleteVendor("+v.id+")' style='padding:5px 10px;font-size:9px'>DELETE</button>";
    html+="</div>";
  });
  list.innerHTML=html||"<p style='color:#aaa'>NO VENDORS</p>";
  openModal("vendorSettingsModal");
}

function addNewVendor(){
  const name=document.getElementById("vendorNameInput").value.trim();
  const phone=document.getElementById("vendorPhoneInput").value.trim();
  if(!name)return alert("Enter vendor name");
  vendors.push({id:Date.now(),name:name,phone:phone});
  document.getElementById("vendorNameInput").value="";
  document.getElementById("vendorPhoneInput").value="";
  updateVendorDropdown();
  openVendorSettings();
}

function deleteVendor(id){
  vendors=vendors.filter(v=>v.id!==id);
  updateVendorDropdown();
  openVendorSettings();
}

function saveVendorData(){
  if(!githubToken)return alert("GitHub token not set. Click GitHub Setup first.");
  saveToGitHub("vendors");
}

function saveToGitHub(type){
  const data=JSON.stringify({owners:OWNERS,vendors:vendors,properties:propertySettings,expenses:expenses,github_token:githubToken},null,2);
  const content=btoa(unescape(encodeURIComponent(data)));
  
  fetch(GITHUB_API,{
    headers:{
      "Authorization":"token "+githubToken,
      "Accept":"application/vnd.github.v3+json"
    }
  })
  .then(r=>r.json())
  .then(file=>{
    if(file.message){
      alert("‚ùå Error: "+file.message);
      return;
    }
    
    return fetch(GITHUB_API,{
      method:"PUT",
      headers:{
        "Authorization":"token "+githubToken,
        "Content-Type":"application/json"
      },
      body:JSON.stringify({
        message:"Update "+type,
        content:content,
        sha:file.sha
      })
    })
    .then(r=>r.json())
    .then(result=>{
      if(result.message&&result.message.includes("error")){
        alert("‚ùå Save failed: "+result.message);
      }else{
        alert("‚úì "+type.toUpperCase()+" SAVED!");
        setTimeout(()=>loadData(),1000);
      }
    });
  })
  .catch(e=>{
    console.error("Error:",e);
    alert("‚ùå Error: "+e.message);
  });
}

function updateVendorDropdown(){
  const sel=document.getElementById("expenseVendor");
  sel.innerHTML="<option>-- SELECT --</option>";
  vendors.forEach(v=>{
    sel.innerHTML+="<option>"+v.name+"</option>";
  });
}

function openAddExpense(){
  if(!currentOwner)return alert("Select owner first");
  const prop=document.getElementById("expenseProperty");
  prop.innerHTML="<option>-- SELECT --</option>";
  Object.keys(propertyTotals).forEach(p=>{
    prop.innerHTML+="<option>"+p+"</option>";
  });
  openModal("expenseModal");
}

function submitExpense(){
  const type=document.getElementById("expenseType").value;
  const prop=document.getElementById("expenseProperty").value;
  const vendor=document.getElementById("expenseVendor").value;
  const amount=parseFloat(document.getElementById("expenseAmount").value);
  if(!currentOwner||!prop||!vendor||!amount)return alert("Fill all fields");
  expenses.push({id:Date.now(),owner:currentOwner,type:type,property:prop,vendor:vendor,amount:amount,notes:document.getElementById("expenseNotes").value});
  closeAll();
  saveToGitHub("expenses");
  if(csvData.length){processData();displayStatement();}
  alert("‚úì Expense added!");
}

function setupToken(){
  const token=prompt("PASTE YOUR GITHUB TOKEN:\n\n(Token name: 'ocean vacations')");
  if(!token)return;
  githubToken=token.trim();
  alert("‚úì Saving token to GitHub...");
  saveToGitHub("GitHub token");
}

function setupDropbox(){
  const token=prompt("DROPBOX ACCESS TOKEN:");
  if(token&&token.trim()){
    localStorage.setItem("dropbox_token",token.trim());
    alert("‚úì Dropbox token saved!");
  }
}

function generateStatement(){
  const file=document.getElementById("csvFile").files[0];
  if(!file||!currentOwner)return;
  const reader=new FileReader();
  reader.onload=e=>{
    csvData=Papa.parse(e.target.result,{header:true,skipEmptyLines:true}).data;
    const month=parseInt(document.getElementById("monthSelect").value);
    const year=parseInt(document.getElementById("yearSelect").value);
    updateHeaderDates();
    processData(month,year);
    displayStatement();
  };
  reader.readAsText(file);
}

function updateHeaderDates(){
  const month=parseInt(document.getElementById("monthSelect").value);
  const year=parseInt(document.getElementById("yearSelect").value);
  const months=["JANUARY","FEBRUARY","MARCH","APRIL","MAY","JUNE","JULY","AUGUST","SEPTEMBER","OCTOBER","NOVEMBER","DECEMBER"];
  const last=new Date(year,month,0).getDate();
  let nextMonth=month+1,nextYear=year;
  if(nextMonth>12){nextMonth=1;nextYear++;}
  document.getElementById("reportTitle").textContent="RESERVATION REPORT";
  document.getElementById("statementDate").innerHTML="STATEMENT DATE:<br><strong>"+months[nextMonth-1]+" 1ST "+nextYear+"</strong>";
  document.getElementById("periodDate").innerHTML="PERIOD: "+months[month-1]+" 1ST - "+last+"TH "+year;
  document.getElementById("ownerTitle").textContent=currentOwner.toUpperCase();
}

function processData(month,year){
  const t=OWNERS[currentOwner];
  propertyTotals={};
  masterTotals={gross:0,acc:0,clean:0,pmc:0,expenses:0,draft:0,owner:0,websiteFee:0};
  taxByProperty={};
  let byProp={};
  csvData.forEach(row=>{
    if(!row["CHECK-IN DATE"])return;
    const m=parseInt(row["CHECK-IN DATE"].split("-")[1]);
    const y=parseInt(row["CHECK-IN DATE"].split("-")[0]);
    if(m!==month||y!==year)return;
    const prop=row["LISTING'S NICKNAME"]||"Unknown";
    if(!byProp[prop])byProp[prop]=[];
    byProp[prop].push(row);
  });
  Object.keys(byProp).forEach(prop=>{
    let gross=0,acc=0,clean=0,pmc=0,websiteFee=0;
    byProp[prop].forEach(row=>{
      const g=num(row["TOTAL PAYOUT"]);
      const a=num(row["ACCOMMODATION FARE"])-num(row["MARKUP"]);
      const c=(row["STATUS"]||"").toLowerCase().includes("cancelled")?0:num(row["CLEANING FARE"]);
      const p=a*t.percent;
      let w=0;
      if(t.type==="draft"&&a>0){
        const code=row["CONFIRMATION CODE"]||"";
        const platform=row["PLATFORM"]||"";
        if(!code.toUpperCase().startsWith("HA")&&(platform.toLowerCase().includes("website")||platform.toLowerCase().includes("manual"))){
          w=g*0.01;
        }
      }
      gross+=g;
      acc+=a;
      clean+=c;
      pmc+=p;
      websiteFee+=w;
      if(t.type==="payout"){
        const cityTax=num(row["CITY TAX"])||0;
        const stateTax=num(row["STATE TAX"])||0;
        const countyTax=num(row["COUNTY TAX"])||0;
        const occupancyTax=num(row["OCCUPANCY TAX"])||0;
        if(cityTax>0||stateTax>0||countyTax>0||occupancyTax>0){
          if(!taxByProperty[prop])taxByProperty[prop]=0;
          taxByProperty[prop]+=g;
        }
      }
    });
    const exp=expenses.filter(e=>e.property===prop&&e.owner===currentOwner).reduce((sum,e)=>sum+e.amount,0);
    const draft=pmc+clean+websiteFee+exp;
    const owner=acc-pmc-exp;
    propertyTotals[prop]={gross:gross,acc:acc,clean:clean,pmc:pmc,websiteFee:websiteFee,expenses:exp,draft:draft,owner:owner,reservations:byProp[prop]};
    masterTotals.gross+=gross;
    masterTotals.acc+=acc;
    masterTotals.clean+=clean;
    masterTotals.pmc+=pmc;
    masterTotals.websiteFee+=websiteFee;
    masterTotals.expenses+=exp;
    masterTotals.draft+=draft;
    masterTotals.owner+=owner;
  });
}

function displayStatement(){
  const t=OWNERS[currentOwner];
  const type=t.type;
  let html="<div class='action-buttons'><button class='copy-link-btn' onclick='generateLink()'>üîó GENERATE & COPY LINK</button></div>";
  html+="<div class='summary-title'>FINANCIAL SUMMARY</div><div class='summary-grid'>";
  if(type==="draft"){
    html+="<div class='summary-card'><div class='summary-label'>GROSS PAYOUT</div><div class='summary-value'>"+money(masterTotals.gross)+"</div></div>";
    html+="<div class='summary-card'><div class='summary-label'>ACCOMMODATION</div><div class='summary-value'>"+money(masterTotals.acc)+"</div></div>";
    html+="<div class='summary-card'><div class='summary-label'>PMC</div><div class='summary-value'>"+money(masterTotals.pmc)+"</div></div>";
    html+="<div class='summary-card'><div class='summary-label'>CLEANING FEE</div><div class='summary-value'>"+money(masterTotals.clean)+"</div></div>";
    html+="<div class='summary-card'><div class='summary-label'>WEBSITE (1%)</div><div class='summary-value'>"+money(masterTotals.websiteFee)+"</div></div>";
    html+="<div class='summary-card'><div class='summary-label'>EXPENSES</div><div class='summary-value'>"+money(masterTotals.expenses)+"</div></div>";
    html+="<div class='summary-card' style='background:#000;color:#fff;border-color:#000'><div class='summary-label' style='color:#fff'>AMOUNT DUE</div><div class='summary-value' style='color:#fff'>"+money(masterTotals.draft)+"</div></div>";
  }else{
    html+="<div class='summary-card'><div class='summary-label'>ACCOMMODATION</div><div class='summary-value'>"+money(masterTotals.acc)+"</div></div>";
    html+="<div class='summary-card'><div class='summary-label'>PMC</div><div class='summary-value'>"+money(masterTotals.pmc)+"</div></div>";
    html+="<div class='summary-card'><div class='summary-label'>EXPENSES</div><div class='summary-value'>"+money(masterTotals.expenses)+"</div></div>";
    html+="<div class='summary-card' style='background:#000;color:#fff;border-color:#000'><div class='summary-label' style='color:#fff'>OWNER PAYOUT</div><div class='summary-value' style='color:#fff'>"+money(masterTotals.owner)+"</div></div>";
  }
  html+="</div>";
  Object.keys(propertyTotals).forEach(prop=>{
    const p=propertyTotals[prop];
    const r=type==="draft"?p.draft:p.owner;
    const exp=expenses.filter(e=>e.property===prop&&e.owner===currentOwner);
    html+="<div class='property-section'><div class='property-title'><span class='property-icon'>üè†</span>"+prop.toUpperCase()+"</div><div class='summary-grid'>";
    if(type==="draft"){
      html+="<div class='summary-card'><div class='summary-label'>GROSS PAYOUT</div><div class='summary-value'>"+money(p.gross)+"</div></div>";
      html+="<div class='summary-card'><div class='summary-label'>ACCOMMODATION</div><div class='summary-value'>"+money(p.acc)+"</div></div>";
      html+="<div class='summary-card'><div class='summary-label'>PMC</div><div class='summary-value'>"+money(p.pmc)+"</div></div>";
      html+="<div class='summary-card'><div class='summary-label'>CLEANING FEE</div><div class='summary-value'>"+money(p.clean)+"</div></div>";
      html+="<div class='summary-card'><div class='summary-label'>WEBSITE (1%)</div><div class='summary-value'>"+money(p.websiteFee)+"</div></div>";
      html+="<div class='summary-card'><div class='summary-label'>EXPENSES</div><div class='summary-value'>"+money(p.expenses)+"</div></div>";
      html+="<div class='summary-card' style='background:#000;color:#fff;border-color:#000'><div class='summary-label' style='color:#fff'>AMOUNT DUE</div><div class='summary-value' style='color:#fff'>"+money(r)+"</div></div>";
    }else{
      html+="<div class='summary-card'><div class='summary-label'>ACCOMMODATION</div><div class='summary-value'>"+money(p.acc)+"</div></div>";
      html+="<div class='summary-card'><div class='summary-label'>PMC</div><div class='summary-value'>"+money(p.pmc)+"</div></div>";
      html+="<div class='summary-card'><div class='summary-label'>EXPENSES</div><div class='summary-value'>"+money(p.expenses)+"</div></div>";
      html+="<div class='summary-card' style='background:#000;color:#fff;border-color:#000'><div class='summary-label' style='color:#fff'>OWNER PAYOUT</div><div class='summary-value' style='color:#fff'>"+money(r)+"</div></div>";
    }
    html+="</div><div style='margin-top:15px'><div class='section-title'>RESERVATIONS</div><table style='margin-top:10px'>";
    if(type==="draft"){
      html+="<tr><th>CODE</th><th>STAY</th><th>PLATFORM</th><th>ACCOMMODATION</th><th>PMC</th><th>CLEANING</th><th>WEBSITE</th><th>AMOUNT DUE</th></tr>";
      p.reservations.forEach(row=>{
        const a=num(row["ACCOMMODATION FARE"])-num(row["MARKUP"]);
        const g=num(row["TOTAL PAYOUT"]);
        const c=(row["STATUS"]||"").toLowerCase().includes("cancelled")?0:num(row["CLEANING FARE"]);
        const pm=a*t.percent;
        const w=a>0&&!row["CONFIRMATION CODE"].toUpperCase().startsWith("HA")&&(row["PLATFORM"]||"").toLowerCase().includes("website")?g*0.01:0;
        const checkin=row["CHECK-IN DATE"]?row["CHECK-IN DATE"].split("-").slice(1).join("/"):"";
        const checkout=row["CHECK-OUT DATE"]?row["CHECK-OUT DATE"].split("-").slice(1).join("/"):"";
        if(g===0)return;
        html+="<tr><td>"+row["CONFIRMATION CODE"].substring(0,8)+"</td><td>"+checkin+"-"+checkout+"</td><td>"+row["PLATFORM"]+"</td><td>"+money(a)+"</td><td>"+money(pm)+"</td><td>"+money(c)+"</td><td>"+money(w)+"</td><td>"+money(pm+c+w)+"</td></tr>";
      });
    }else{
      html+="<tr><th>CODE</th><th>STAY</th><th>PLATFORM</th><th>ACCOMMODATION</th><th>PMC</th><th>OWNER PAYOUT</th></tr>";
      p.reservations.forEach(row=>{
        const a=num(row["ACCOMMODATION FARE"])-num(row["MARKUP"]);
        const g=num(row["TOTAL PAYOUT"]);
        const pm=a*t.percent;
        const checkin=row["CHECK-IN DATE"]?row["CHECK-IN DATE"].split("-").slice(1).join("/"):"";
        const checkout=row["CHECK-OUT DATE"]?row["CHECK-OUT DATE"].split("-").slice(1).join("/"):"";
        if(g===0)return;
        html+="<tr><td>"+row["CONFIRMATION CODE"].substring(0,8)+"</td><td>"+checkin+"-"+checkout+"</td><td>"+row["PLATFORM"]+"</td><td>"+money(a)+"</td><td>"+money(pm)+"</td><td>"+money(a-pm)+"</td></tr>";
      });
    }
    html+="</table></div>";
    if(exp.length>0){
      html+="<div style='margin-top:15px'><div class='section-title'>EXPENSES</div>";
      exp.forEach(e=>{
        html+="<div class='attachment'><div class='attachment-left'><strong>"+e.type+"</strong> - "+e.vendor+": "+money(e.amount)+"</div><div class='attachment-actions'><button class='btn btn-danger btn-small' onclick='deleteExpense("+e.id+")'>DELETE</button></div></div>";
      });
      html+="</div>";
    }
    html+="</div>";
  });
  document.getElementById("mainContent").innerHTML=html;
}

function deleteExpense(id){
  if(!confirm("Delete?"))return;
  expenses=expenses.filter(e=>e.id!==id);
  saveToGitHub("expenses");
  if(csvData.length){processData();displayStatement();}
}

function generateLink(){
  const month=parseInt(document.getElementById("monthSelect").value);
  const year=parseInt(document.getElementById("yearSelect").value);
  const token=localStorage.getItem("dropbox_token");
  if(!token)return alert("Setup Dropbox first");
  const filename=currentOwner+"_"+month+"_"+year+"_"+Date.now()+".html";
  const html=document.getElementById("content").innerHTML;
  const fullHtml="<html><head><title>Statement - "+currentOwner+"</title><style>"+document.querySelector("style").innerHTML+"</style></head><body>"+html+"</body></html>";
  fetch("https://content.dropboxapi.com/2/files/upload",{
    method:"POST",
    headers:{"Authorization":"Bearer "+token,"Dropbox-API-Arg":JSON.stringify({path:"/statements/"+filename,mode:"add"})},
    body:fullHtml
  }).then(r=>{
    if(r.ok){
      fetch("https://www.dropboxapi.com/2/sharing/create_shared_link_with_settings",{
        method:"POST",
        headers:{"Authorization":"Bearer "+token,"Content-Type":"application/json"},
        body:JSON.stringify({path:"/statements/"+filename,settings:{requested_visibility:"public"}})
      }).then(r=>r.json()).then(data=>{
        const link=data.url.replace("?dl=0","?dl=1");
        showLinkGenerated(link);
      });
    }else alert("Upload failed");
  }).catch(e=>alert("Error: "+e.message));
}

function showLinkGenerated(link){
  const msg="<div style='background:#d4edda;border:2px solid #28a745;padding:15px;margin:20px 0;border-radius:5px;text-align:center'><h3 style='color:#155724'>‚úì STATEMENT GENERATED!</h3><p style='color:#155724;margin:10px 0'>Copy link and paste in Gmail:</p><button class='copy-link-btn' onclick=\"copyToClipboard('"+link+"')\">üìã COPY LINK TO CLIPBOARD</button><p style='font-size:12px;color:#155724;margin-top:10px;word-break:break-all'><code style='background:#fff;padding:5px;border-radius:3px'>"+link+"</code></p></div>";
  document.getElementById("mainContent").innerHTML+=msg;
}

function copyToClipboard(text){
  navigator.clipboard.writeText(text).then(()=>alert("‚úì Link copied!")).catch(()=>alert("Failed to copy"));
}

function generateSummary(){
  if(!csvData||csvData.length===0)return alert("Generate statement first");
  updateHeaderDates();
  document.getElementById("reportTitle").textContent="SUMMARY REPORT";
  const t=OWNERS[currentOwner];
  const type=t.type;
  const salesFee=masterTotals.pmc*(t.salesFeePercent/100);
  let html="<div class='action-buttons'><button class='back-btn' onclick='displayStatement()'>‚Üê BACK</button><button class='print-btn' onclick='window.print()'>üñ®Ô∏è PRINT</button></div><div class='summary-title'>SUMMARY & CALCULATIONS</div>";
  html+="<div class='commission-box'><div class='commission-box-title'>SALES COMMISSION DUE</div>";
  html+="<div class='calc-row'><span>TOTAL ACCOMMODATION</span><span>"+money(masterTotals.acc)+"</span></div>";
  html+="<div class='calc-row'><span>PMC % RATE</span><span>"+(t.percent*100).toFixed(2)+"%</span></div>";
  html+="<div class='calc-row' style='background:#fff;font-weight:bold'><span>TOTAL PMC</span><span>"+money(masterTotals.pmc)+"</span></div>";
  html+="<div class='calc-row'><span>SALES FEE %</span><span>"+t.salesFeePercent+"%</span></div>";
  html+="<div class='calc-row-total'><span>COMMISSION AMOUNT</span><span>"+money(salesFee)+"</span></div>";
  html+="</div>";
  if(type==="draft"){
    html+="<div class='commission-box'><div class='commission-box-title'>DRAFT OWNER BREAKDOWN</div>";
    html+="<div class='calc-row'><span>CLEANING FEES</span><span>"+money(masterTotals.clean)+"</span></div>";
    html+="<div class='calc-row'><span>WEBSITE FEE (1%)</span><span>"+money(masterTotals.websiteFee)+"</span></div>";
    html+="<div class='calc-row'><span>EXPENSES</span><span>"+money(masterTotals.expenses)+"</span></div>";
    html+="<div class='calc-row-total'><span>TOTAL AMOUNT DUE</span><span>"+money(masterTotals.draft)+"</span></div>";
    html+="</div>";
  }else{
    html+="<div class='commission-box'><div class='commission-box-title'>PAYOUT OWNER BREAKDOWN</div>";
    html+="<div class='calc-row'><span>ACCOMMODATION</span><span>"+money(masterTotals.acc)+"</span></div>";
    html+="<div class='calc-row'><span>PMC (DEDUCTION)</span><span>-"+money(masterTotals.pmc)+"</span></div>";
    html+="<div class='calc-row'><span>EXPENSES</span><span>-"+money(masterTotals.expenses)+"</span></div>";
    html+="<div class='calc-row-total'><span>OWNER NET PAYOUT</span><span>"+money(masterTotals.owner)+"</span></div>";
    html+="</div>";
    if(Object.keys(propertyTotals).some(prop=>propertySettings[prop]&&Object.values(propertySettings[prop]||{}).some(v=>v))){
      html+="<div class='tax-info'><div class='tax-info-title'>‚ö†Ô∏è TAX PAYMENT REQUIRED BY MUNICIPALITY</div>";
      html+="<table class='tax-table'><tr><th>PROPERTY</th><th>ACCOMMODATION</th><th>MUNICIPALITIES</th><th>AMOUNT TO REPORT</th></tr>";
      Object.keys(propertyTotals).forEach(prop=>{
        const p=propertyTotals[prop];
        const s=propertySettings[prop];
        if(!s||!Object.values(s||{}).some(v=>v))return;
        const muns=Object.keys(s||{}).filter(m=>s[m]).join(", ");
        html+="<tr><td>"+prop+"</td><td>"+money(p.acc)+"</td><td>"+muns+"</td><td class='tax-amount'>"+money(taxByProperty[prop]||0)+"</td></tr>";
      });
      html+="</table></div>";
    }
  }
  html+="<div class='pmc-transfer-box'><div class='pmc-transfer-title'>üí≥ PMC BANK TRANSFER</div><div class='pmc-transfer-amount'>"+money(masterTotals.pmc)+"</div><p style='text-align:center;margin-top:10px;font-size:11px'>Transfer amount to PMC bank</p></div>";
  document.getElementById("mainContent").innerHTML=html;
}

function openModal(id){
  document.getElementById("modalOverlay").classList.add("show");
  document.getElementById(id).classList.add("show");
}

function closeAll(){
  document.getElementById("modalOverlay").classList.remove("show");
  document.querySelectorAll(".modal").forEach(m=>m.classList.remove("show"));
}

loadData();
</script>
</body>
</html>
