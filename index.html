<!DOCTYPE html>
<html>
<head>
<title>Ocean Vacations - Reservation Report</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial;background:#f5f5f5;display:flex}.sidebar{width:280px;background:#333;color:#fff;padding:20px;height:100vh;overflow-y:auto;position:fixed;left:0;top:0}.sidebar h3{margin-bottom:20px;font-size:16px;border-bottom:2px solid #fff;padding-bottom:10px}.section{margin-bottom:20px}.label{font-size:11px;font-weight:bold;color:#aaa;margin-bottom:5px;display:block}select,input{width:100%;padding:8px;margin:5px 0;border:1px solid #555;background:#444;color:#fff;border-radius:3px;font-size:11px}.btn{width:100%;padding:12px;margin:8px 0;border:none;font-weight:bold;border-radius:3px;cursor:pointer;font-size:12px;color:#fff}.btn-primary{background:#000}.btn-success{background:#28a745}.btn-warning{background:#ff9800}.btn-info{background:#17a2b8}.btn-danger{background:#dc3545}.main{margin-left:280px;padding:20px;width:calc(100% - 280px)}.page{background:#fff;padding:40px;border-radius:5px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}.invoice-header{display:flex;justify-content:space-between;margin-bottom:40px;border-bottom:2px solid #000;padding-bottom:30px}.company-name{font-size:20px;font-weight:bold}.report-title{text-align:center;font-size:32px;font-weight:bold;margin:40px 0}.owner-name{text-align:center;font-size:28px;margin-bottom:40px;font-weight:bold}table{width:100%;border-collapse:collapse;margin:20px 0;font-size:11px}th,td{border:1px solid #e0e0e0;padding:12px;text-align:left}th{background:#f5f5f5;font-weight:bold}tr:nth-child(even){background:#fafafa}.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin:20px 0}.summary-card{background:#f9f9f9;border:1px solid #ddd;padding:12px;text-align:center;border-radius:5px}.summary-value{font-size:14px;font-weight:bold;margin-top:6px}.property-section{margin:40px 0;padding:20px;border:1px solid #ddd;border-radius:5px}.modal{display:none;position:fixed;z-index:1001;left:50%;top:50%;transform:translate(-50%,-50%);width:90%;max-width:500px;background:#333;color:#fff;border-radius:8px;padding:30px;max-height:90vh;overflow-y:auto}.modal.show{display:block}.modal-title{font-size:20px;font-weight:bold;margin-bottom:20px;border-bottom:2px solid #fff;padding-bottom:15px}.modal-field{margin-bottom:15px}.modal-label{font-size:11px;font-weight:bold;color:#aaa;margin-bottom:8px;display:block}.modal-input{width:100%;padding:10px;border:1px solid #555;background:#444;color:#fff;border-radius:3px;font-size:11px}.modal-actions{display:flex;gap:10px;margin-top:25px}.modal-actions button{flex:1;padding:12px;border:none;font-weight:bold;border-radius:3px;cursor:pointer;font-size:12px;color:#fff}.btn-add{background:#28a745}.btn-cancel{background:#666}.modal-overlay{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.7)}.modal-overlay.show{display:block}.copy-link-btn{background:#0066cc;color:#fff;padding:10px 15px;border:none;border-radius:3px;cursor:pointer;margin:10px 0;width:100%}.back-btn{background:#666}@media print{.sidebar,.back-btn,.copy-link-btn{display:none}.main{margin-left:0;width:100%}}
</style>
</head>
<body>
<div class="sidebar"><h3>üéØ OCEAN VACATIONS</h3>
<div class="section"><label class="label">Select Owner</label><select id="ownerSelect" onchange="onOwnerChange()"><option>--Select--</option></select></div>
<div class="section"><label class="label">Month</label><select id="monthSelect"></select></div>
<div class="section"><label class="label">Year</label><select id="yearSelect"></select></div>
<div class="section"><label class="label">Upload CSV</label><input type="file" id="csvFile" accept=".csv"></div>
<button class="btn btn-primary" onclick="generateStatement()">‚ñ∂ STATEMENT</button>
<button class="btn btn-success" onclick="generateSummary()">üìä Summary</button>
<button class="btn btn-warning" onclick="generateAnnual()">üìà Annual</button>
<hr style="border:1px solid #555;margin:20px 0">
<button class="btn btn-success" onclick="openAddExpense()" style="font-size:13px">üí∞ ADD EXPENSE</button>
<hr style="border:1px solid #555;margin:20px 0">
<h4 style="color:#fff;margin-bottom:10px">üè¢ Vendors</h4>
<input type="text" id="vendorName" placeholder="Name">
<input type="text" id="vendorPhone" placeholder="Phone">
<button class="btn btn-success" onclick="addVendor()" style="font-size:11px">Add Vendor</button>
<button class="btn btn-warning" onclick="showVendors()" style="font-size:11px">View</button>
<hr style="border:1px solid #555;margin:20px 0">
<button class="btn btn-info" onclick="openOwners()" style="font-size:11px">‚öôÔ∏è Owners</button>
<button class="btn btn-info" onclick="openTax()" style="font-size:11px">‚öôÔ∏è Tax</button>
<button class="btn btn-warning" onclick="setupToken()" style="font-size:11px">üîë GitHub</button>
<button class="btn btn-warning" onclick="setupDropbox()" style="font-size:11px">üìÅ Dropbox</button>
</div>

<div id="modalOverlay" class="modal-overlay" onclick="closeAll()"></div>

<div id="ownerModal" class="modal"><div><div class="modal-title">‚öôÔ∏è Owners</div>
<div class="modal-field"><label class="modal-label">Name</label><input type="text" id="ownerName" class="modal-input"></div>
<div class="modal-field"><label class="modal-label">Email</label><input type="email" id="ownerEmail" class="modal-input"></div>
<div class="modal-field"><label class="modal-label">Commission %</label><input type="number" id="ownerComm" class="modal-input" step="0.01"></div>
<div class="modal-field"><label class="modal-label">Sales Fee %</label><input type="number" id="ownerSales" class="modal-input" step="0.01"></div>
<div class="modal-field"><label class="modal-label">Type</label><select id="ownerType" class="modal-input"><option>draft</option><option>payout</option></select></div>
<button class="btn btn-success" onclick="addOwner()" style="width:100%;margin-bottom:20px">‚ûï Add</button>
<div id="ownersList" style="max-height:350px;overflow-y:auto;margin-bottom:20px"></div>
<div class="modal-actions"><button class="btn-cancel" onclick="closeAll()">‚úó Close</button></div>
</div></div>

<div id="taxModal" class="modal"><div><div class="modal-title">‚öôÔ∏è Tax</div>
<div id="taxContent" style="max-height:400px;overflow-y:auto;margin-bottom:20px"></div>
<div class="modal-actions"><button class="btn-cancel" onclick="closeAll()">‚úó Close</button></div>
</div></div>

<div id="vendorModal" class="modal"><div><div class="modal-title">üè¢ Vendors</div>
<div id="vendorsList" style="max-height:300px;overflow-y:auto;margin-bottom:20px"></div>
<div class="modal-actions"><button class="btn-cancel" onclick="closeAll()">‚úó Close</button></div>
</div></div>

<div id="expenseModal" class="modal"><div><div class="modal-title">üí∞ Add Expense</div>
<div class="modal-field"><label class="modal-label">Type</label><select id="expenseType" class="modal-input"><option>Maintenance</option><option>Repair</option><option>Purchase</option></select></div>
<div class="modal-field"><label class="modal-label">Property</label><select id="expenseProperty" class="modal-input"></select></div>
<div class="modal-field"><label class="modal-label">Vendor</label><select id="expenseVendor" class="modal-input"></select></div>
<div class="modal-field"><label class="modal-label">Amount</label><input type="number" id="expenseAmount" class="modal-input" step="0.01"></div>
<div class="modal-field"><label class="modal-label">Notes</label><input type="text" id="expenseNotes" class="modal-input"></div>
<div class="modal-actions"><button class="btn-add" onclick="submitExpense()">‚úì Add</button><button class="btn-cancel" onclick="closeAll()">‚úó Close</button></div>
</div></div>

<div class="main"><div id="content" class="page"><div class="invoice-header"><div><div class="company-name">OCEAN VACATIONS</div><div style="font-size:11px">oceanvacationsmb@gmail.com | 843-222-6516</div></div><div><div id="statementDate"></div><div id="periodDate"></div></div></div><div class="report-title">RESERVATION REPORT</div><div class="owner-name" id="ownerTitle"></div><div id="mainContent"><div style="text-align:center;padding:40px">Loading...</div></div></div></div>

<script>
let OWNERS={};
let vendors=[];
let expenses=[];
let csvData=[];
let propertySettings={};
let currentOwner="";
let masterTotals={gross:0,acc:0,clean:0,pmc:0,expenses:0,draft:0,owner:0,websiteFee:0};
let propertyTotals={};
const municipalities=["SC","MB","NMB","SSB","HC"];

function num(v){return parseFloat((v||"0").toString().replace(/[$,]/g,""))||0;}
function money(v){return"$"+(Number(v)||0).toFixed(2);}

function loadData(){
  fetch("https://raw.githubusercontent.com/oceanvacationsmb/reports/main/data.json?t="+Date.now())
    .then(r=>r.json())
    .then(data=>{
      OWNERS=data.owners||{};
      vendors=data.vendors||[];
      expenses=data.expenses||[];
      propertySettings=data.properties||{};
      init();
    })
    .catch(e=>{console.error(e);init();});
}

function init(){buildOwners();buildMonths();buildYears();document.getElementById("mainContent").innerHTML="<div style='text-align:center;padding:40px'>Ready!";}

function buildOwners(){const sel=document.getElementById("ownerSelect");sel.innerHTML="<option>--Select--</option>";Object.keys(OWNERS).sort().forEach(name=>{sel.innerHTML+="<option>"+name+"</option>";});}

function buildMonths(){const sel=document.getElementById("monthSelect");const months=["January","February","March","April","May","June","July","August","September","October","November","December"];months.forEach((m,i)=>{sel.innerHTML+="<option value='"+(i+1)+"'>"+m+"</option>";});sel.value=new Date().getMonth()+1;}

function buildYears(){const sel=document.getElementById("yearSelect");const y=new Date().getFullYear();for(let i=y-2;i<=y+2;i++){sel.innerHTML+="<option>"+i+"</option>";}sel.value=y;}

function onOwnerChange(){currentOwner=document.getElementById("ownerSelect").value;}

function openOwners(){const list=document.getElementById("ownersList");let html="";Object.keys(OWNERS).forEach(name=>{const o=OWNERS[name];html+="<div style='background:#555;padding:10px;margin:8px 0;border-radius:3px'><strong>"+name+"</strong><br><input type='email' value='"+(o.email||"")+"' placeholder='Email' class='modal-input' style='margin:5px 0'><input type='number' step='0.01' value='"+(o.percent*100)+"' placeholder='Commission %' class='modal-input' style='margin:5px 0'><select class='modal-input' style='margin:5px 0'><option "+(o.type==='draft'?'selected':'')+">draft</option><option "+(o.type==='payout'?'selected':'')+">payout</option></select><button class='btn btn-danger' onclick=\"deleteOwner('"+name+"')\" style='width:100%;margin-top:8px;padding:8px'>Delete</button></div>";});list.innerHTML=html;openModal("ownerModal");}

function addOwner(){const name=document.getElementById("ownerName").value;const email=document.getElementById("ownerEmail").value;const comm=parseFloat(document.getElementById("ownerComm").value)||0.12;const sales=parseFloat(document.getElementById("ownerSales").value)||5;const type=document.getElementById("ownerType").value;if(!name)return;OWNERS[name]={email:email,percent:comm/100,salesFeePercent:sales,type:type};document.getElementById("ownerName").value="";document.getElementById("ownerEmail").value="";document.getElementById("ownerComm").value="";document.getElementById("ownerSales").value="";saveData();buildOwners();openOwners();}

function deleteOwner(name){if(!confirm("Delete?"))return;delete OWNERS[name];saveData();buildOwners();openOwners();}

function openTax(){const content=document.getElementById("taxContent");let html="";Object.keys(OWNERS).forEach(name=>{html+="<div style='background:#555;padding:10px;margin:8px 0'><strong>"+name+"</strong><br>";municipalities.forEach(m=>{const checked=propertySettings[name]&&propertySettings[name][m]?"checked":"";html+="<label style='color:#fff'><input type='checkbox' "+checked+" onchange=\"if(!propertySettings['"+name+"'])propertySettings['"+name+"']={};propertySettings['"+name+"']['"+m+"']=this.checked\"> "+m+"</label> ";});html+="</div>";});content.innerHTML=html;openModal("taxModal");}

function addVendor(){const name=document.getElementById("vendorName").value;const phone=document.getElementById("vendorPhone").value;if(!name)return;vendors.push({id:Date.now(),name:name,phone:phone});document.getElementById("vendorName").value="";document.getElementById("vendorPhone").value="";saveData();alert("‚úì Added");}

function showVendors(){const list=document.getElementById("vendorsList");let html="";vendors.forEach(v=>{html+="<div style='background:#555;padding:10px;margin:8px 0;display:flex;justify-content:space-between'><div><strong style='color:#fff'>"+v.name+"</strong><br><span style='font-size:10px;color:#aaa'>"+v.phone+"</span></div><button class='btn btn-danger' onclick='deleteVendor("+v.id+")' style='padding:5px 10px;font-size:9px'>Delete</button></div>";});list.innerHTML=html;openModal("vendorModal");}

function deleteVendor(id){vendors=vendors.filter(v=>v.id!==id);saveData();showVendors();}

function openAddExpense(){if(!currentOwner)return;const prop=document.getElementById("expenseProperty");prop.innerHTML="<option>--Select--</option>";Object.keys(propertyTotals).forEach(p=>{prop.innerHTML+="<option>"+p+"</option>";});const vend=document.getElementById("expenseVendor");vend.innerHTML="<option>--Select--</option>";vendors.forEach(v=>{vend.innerHTML+="<option>"+v.name+"</option>";});openModal("expenseModal");}

function submitExpense(){const type=document.getElementById("expenseType").value;const property=document.getElementById("expenseProperty").value;const vendor=document.getElementById("expenseVendor").value;const amount=parseFloat(document.getElementById("expenseAmount").value);if(!currentOwner||!property||!vendor||!amount)return;expenses.push({id:Date.now(),owner:currentOwner,type:type,property:property,vendor:vendor,amount:amount,notes:document.getElementById("expenseNotes").value});closeAll();saveData();alert("‚úì Added");}

function setupToken(){const token=prompt("GitHub Token:");if(token){localStorage.setItem("github_token",token);loadData();}}

function setupDropbox(){const token=prompt("Dropbox Token:");if(token){localStorage.setItem("dropbox_token",token);}}

function saveData(){const token=localStorage.getItem("github_token");if(!token)return;const data=JSON.stringify({owners:OWNERS,vendors:vendors,properties:propertySettings,expenses:expenses},null,2);const content=btoa(unescape(encodeURIComponent(data)));fetch("https://api.github.com/repos/oceanvacationsmb/reports/contents/data.json",{headers:{"Authorization":"token "+token}}).then(r=>r.json()).then(file=>{fetch("https://api.github.com/repos/oceanvacationsmb/reports/contents/data.json",{method:"PUT",headers:{"Authorization":"token "+token,"Content-Type":"application/json"},body:JSON.stringify({message:"Update",content:content,sha:file.sha})});});}

function generateStatement(){const file=document.getElementById("csvFile").files[0];if(!file||!currentOwner)return;const reader=new FileReader();reader.onload=e=>{csvData=Papa.parse(e.target.result,{header:true,skipEmptyLines:true}).data;const month=parseInt(document.getElementById("monthSelect").value);const year=parseInt(document.getElementById("yearSelect").value);processData(month,year);displayStatement(month,year);};reader.readAsText(file);}

function processData(month,year){const t=OWNERS[currentOwner];propertyTotals={};masterTotals={gross:0,acc:0,clean:0,pmc:0,expenses:0,draft:0,owner:0,websiteFee:0};let a={};csvData.forEach(row=>{if(!row["CHECK-IN DATE"])return;const m=parseInt(row["CHECK-IN DATE"].split("-")[1]);const y=parseInt(row["CHECK-IN DATE"].split("-")[0]);if(m!==month||y!==year)return;const prop=row["LISTING'S NICKNAME"]||"Unknown";if(!a[prop])a[prop]=[];a[prop].push(row);});Object.keys(a).forEach(prop=>{let n=0,s=0,r=0,i=0,d=0,c=0;a[prop].forEach(row=>{const f=num(row["TOTAL PAYOUT"]);const l=num(row["ACCOMMODATION FARE"])-num(row["MARKUP"]);const h=(row["STATUS"]||"").toLowerCase().includes("cancelled")?0:num(row["CLEANING FARE"]);const u=l*t.percent;let b=0;if(t.type==="draft"&&l>0){const g=row["CONFIRMATION CODE"]||"";const p=row["PLATFORM"]||"";if(!g.toUpperCase().startsWith("HA")&&(p.toLowerCase().includes("website")||p.toLowerCase().includes("manual"))){b=f*0.01}}n+=f;s+=l;r+=h;i+=u;d+=b;c+=0;});const o=expenses.filter(e=>e.property===prop&&e.owner===currentOwner).reduce((sum,e)=>sum+e.amount,0);const l=i+r+d+o;const h=s-i-o;propertyTotals[prop]={gross:n,acc:s,clean:r,pmc:i,websiteFee:d,expenses:o,draft:l,owner:h,reservations:a[prop]};masterTotals.gross+=n;masterTotals.acc+=s;masterTotals.clean+=r;masterTotals.pmc+=i;masterTotals.websiteFee+=d;masterTotals.expenses+=o;masterTotals.draft+=l;masterTotals.owner+=h;});}

function displayStatement(month,year){const months=["January","February","March","April","May","June","July","August","September","October","November","December"];const t=OWNERS[currentOwner];const last=new Date(year,month,0).getDate();let next=month+1,nextYear=year;if(next>12){next=1;nextYear++;}document.getElementById("statementDate").innerHTML="<strong>"+months[next-1]+" 1, "+nextYear+"</strong>";document.getElementById("periodDate").innerHTML="<strong>"+months[month-1]+" 1-"+last+", "+year+"</strong>";document.getElementById("ownerTitle").textContent=currentOwner;let html="<button class='copy-link-btn' onclick='generateLink()'>üîó Generate Link</button>";html+="<div style='font-size:12px;font-weight:bold;text-align:center;margin:20px 0'>SUMMARY</div>";html+="<div class='summary-grid'>";if(t.type==="draft"){html+="<div class='summary-card'><div>Accommodation</div><div class='summary-value'>"+money(masterTotals.acc)+"</div></div>";html+="<div class='summary-card'><div>PMC</div><div class='summary-value'>"+money(masterTotals.pmc)+"</div></div>";html+="<div class='summary-card' style='background:#000;color:#fff'><div>DUE</div><div class='summary-value' style='color:#fff'>"+money(masterTotals.draft)+"</div></div>";}else{html+="<div class='summary-card'><div>Accommodation</div><div class='summary-value'>"+money(masterTotals.acc)+"</div></div>";html+="<div class='summary-card'><div>PMC</div><div class='summary-value'>"+money(masterTotals.pmc)+"</div></div>";html+="<div class='summary-card' style='background:#000;color:#fff'><div>PAYOUT</div><div class='summary-value' style='color:#fff'>"+money(masterTotals.owner)+"</div></div>";}html+="</div>";Object.keys(propertyTotals).forEach(prop=>{const p=propertyTotals[prop];html+="<div class='property-section'><div class='property-title'>"+prop.toUpperCase()+"</div><table><tr><th>Code</th><th>Check-in</th><th>Accommodation</th><th>PMC</th></tr>";p.reservations.forEach(row=>{const a=num(row["ACCOMMODATION FARE"])-num(row["MARKUP"]);const pmc=a*t.percent;html+="<tr><td>"+(row["CONFIRMATION CODE"]||"").substring(0,8)+"</td><td>"+(row["CHECK-IN DATE"]||"")+"</td><td>"+money(a)+"</td><td>"+money(pmc)+"</td></tr>";});html+="</table></div>";});document.getElementById("mainContent").innerHTML=html;}

function generateSummary(){document.getElementById("mainContent").innerHTML="<button class='back-btn' onclick='location.reload()'>‚Üê Back</button><h2 style='text-align:center'>COMMISSION: "+money(masterTotals.pmc)+"</h2>";}

function generateAnnual(){document.getElementById("mainContent").innerHTML="<button class='back-btn' onclick='location.reload()'>‚Üê Back</button><h2 style='text-align:center'>ANNUAL: "+money(masterTotals.acc)+"</h2>";}

function generateLink(){const token=localStorage.getItem("dropbox_token");if(!token)return alert("Setup Dropbox first");const html=document.getElementById("content").innerHTML;const name=currentOwner+"_"+Date.now()+".html";fetch("https://content.dropboxapi.com/2/files/upload",{method:"POST",headers:{"Authorization":"Bearer "+token,"Dropbox-API-Arg":JSON.stringify({path:"/statements/"+name,mode:"add"})},body:html}).then(r=>{if(r.ok){fetch("https://www.dropboxapi.com/2/sharing/create_shared_link_with_settings",{method:"POST",headers:{"Authorization":"Bearer "+token,"Content-Type":"application/json"},body:JSON.stringify({path:"/statements/"+name,settings:{requested_visibility:"public"}})}).then(r=>r.json()).then(data=>{const link=data.url.replace("?dl=0","?dl=1");document.getElementById("mainContent").innerHTML+="<div style='background:#d4edda;padding:15px;margin:20px 0;border-radius:5px;text-align:center'><h3 style='color:#155724'>‚úì Generated!</h3><button class='copy-link-btn' onclick=\"copyLink('"+link+"')\">üìã Copy</button><p style='font-size:11px;color:#155724;word-break:break-all'>"+link+"</p></div>";});}});}

function copyLink(link){navigator.clipboard.writeText(link).then(()=>alert("‚úì Copied"));}

function openModal(id){document.getElementById("modalOverlay").classList.add("show");document.getElementById(id).classList.add("show");}

function closeAll(){document.getElementById("modalOverlay").classList.remove("show");document.querySelectorAll(".modal").forEach(m=>m.classList.remove("show"));}

loadData();
</script>
</body>
</html>
