<!DOCTYPE html>
<html>
<head>
<title>Ocean Vacations - Reservation Report</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial;background:#f5f5f5;color:#000;display:flex}.sidebar{width:280px;background:#333;color:#fff;padding:20px;height:100vh;overflow-y:auto;position:fixed;left:0;top:0}.sidebar h3{margin-bottom:20px;font-size:16px;border-bottom:2px solid #fff;padding-bottom:10px}.section{margin-bottom:20px}.label{font-size:11px;font-weight:bold;color:#aaa;margin-bottom:5px;display:block}select,input{width:100%;padding:8px;margin:5px 0;border:1px solid #555;background:#444;color:#fff;border-radius:3px;font-size:11px}.btn{width:100%;padding:12px;margin:8px 0;border:none;font-weight:bold;border-radius:3px;cursor:pointer;font-size:12px;color:#fff;transition:all 0.3s}.btn-primary{background:#000}.btn-success{background:#28a745}.btn-warning{background:#ff9800}.btn-info{background:#17a2b8}.btn-danger{background:#dc3545}.main{margin-left:280px;padding:20px;width:calc(100% - 280px)}.page{background:#fff;padding:40px;border-radius:5px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}.invoice-header{display:flex;justify-content:space-between;margin-bottom:40px;border-bottom:2px solid #000;padding-bottom:30px}.company-info{font-size:11px;line-height:1.8}.company-name{font-size:20px;font-weight:bold;margin-bottom:5px}.report-title{text-align:center;font-size:32px;font-weight:bold;margin:40px 0 10px 0;letter-spacing:2px}.owner-name{text-align:center;font-size:28px;margin-bottom:40px;font-weight:bold;color:#000}table{width:100%;border-collapse:collapse;margin:20px 0;font-size:11px}th,td{border:1px solid #e0e0e0;padding:12px;text-align:left}th{background:#f5f5f5;color:#000;font-weight:bold;text-transform:uppercase}tr:nth-child(even){background:#fafafa}.action-buttons{display:flex;gap:10px;margin:20px 0;justify-content:center;flex-wrap:wrap}.action-buttons button{padding:10px 20px;font-size:12px;cursor:pointer;border:none;border-radius:3px;color:#fff;font-weight:bold}.back-btn{background:#666}.print-btn{background:#e74c3c}.property-section{margin:40px 0;padding:20px;border:1px solid #ddd;border-radius:5px;background:#fff}.property-title{font-size:14px;font-weight:bold;margin-bottom:15px;display:flex;align-items:center;text-transform:uppercase;text-align:center;justify-content:center}.property-icon{font-size:18px;margin-right:10px}.summary-title{font-size:12px;font-weight:bold;text-transform:uppercase;text-align:center;margin:20px 0}.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin:20px 0}.summary-card{background:#f9f9f9;border:1px solid #ddd;padding:12px;text-align:center;border-radius:5px}.summary-label{font-size:10px;color:#666;font-weight:bold;text-transform:uppercase}.summary-value{font-size:14px;font-weight:bold;color:#000;margin-top:6px}.attachment{background:#f0f0f0;padding:10px;margin:10px 0;border-radius:3px;font-size:10px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}.attachment-left{flex:1}.attachment-actions{display:flex;gap:5px;flex-wrap:wrap}.modal{display:none!important;position:fixed;z-index:1001;left:50%;top:50%;transform:translate(-50%,-50%);width:90%;max-width:500px;background:#333;color:#fff;border-radius:8px;padding:30px;box-shadow:0 4px 20px rgba(0,0,0,0.3);max-height:90vh;overflow-y:auto}.modal.show{display:block!important}.modal-title{font-size:20px;font-weight:bold;margin-bottom:20px;text-transform:uppercase;text-align:center;border-bottom:2px solid #fff;padding-bottom:15px}.modal-field{margin-bottom:18px}.modal-label{font-size:11px;font-weight:bold;color:#aaa;margin-bottom:8px;display:block;text-transform:uppercase}.modal-input{width:100%;padding:10px;border:1px solid #555;background:#444;color:#fff;border-radius:3px;font-size:11px}.modal-actions{display:flex;gap:10px;margin-top:25px}.modal-actions button{flex:1;padding:12px;border:none;font-weight:bold;border-radius:3px;cursor:pointer;font-size:12px;color:#fff}.btn-add{background:#28a745}.btn-cancel{background:#666}.file-upload-area{border:2px dashed #555;border-radius:3px;padding:15px;text-align:center;cursor:pointer;background:#444}.file-upload-area input{display:none}.file-name-display{font-size:10px;color:#28a745;margin-top:8px}.invoice-modal{display:none;position:fixed;z-index:1002;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center}.invoice-modal-content{background:#fff;border-radius:8px;max-width:90%;max-height:90vh;overflow:auto;box-shadow:0 4px 20px rgba(0,0,0,0.4);position:relative}.invoice-modal-close{position:absolute;top:15px;right:15px;font-size:28px;color:#333;cursor:pointer;font-weight:bold;z-index:10}.modal-scroll{max-height:300px;overflow-y:auto;margin:15px 0;padding:15px;background:#444;border-radius:3px}.modal-overlay{display:none!important;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.7)}.modal-overlay.show{display:block!important}.checkbox-group{display:flex;flex-wrap:wrap;gap:15px;align-items:center}.checkbox-item{display:flex;align-items:center;gap:8px}.checkbox-item input{width:18px;height:18px;cursor:pointer}.checkbox-item label{color:#fff;font-weight:bold;cursor:pointer;margin:0;font-size:12px}.section-title{font-size:12px;font-weight:bold;text-transform:uppercase;margin-top:20px;margin-bottom:10px;color:#000}.invoice-btn{background:#17a2b8;color:#fff;padding:3px 8px;border:none;border-radius:3px;cursor:pointer;font-size:9px;font-weight:bold}.copy-link-btn{background:#0066cc;color:#fff;padding:10px 15px;border:none;border-radius:3px;cursor:pointer;font-weight:bold;margin:10px 0;width:100%}.btn-small{padding:5px 10px;font-size:9px;width:auto;margin:0;display:inline-block}.commission-box{background:#fff3cd;border:2px solid #ffc107;padding:15px;margin:15px 0;border-radius:5px}.commission-box-title{font-size:14px;font-weight:bold;color:#856404;margin-bottom:10px;text-transform:uppercase;text-align:center}.calc-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #ddd}.calc-row-total{display:flex;justify-content:space-between;padding:12px;background:#000;color:#fff;font-weight:bold}.pmc-transfer-box{background:#d4edda;border:2px solid #28a745;padding:15px;margin:15px 0;border-radius:5px}.pmc-transfer-title{font-size:14px;font-weight:bold;color:#155724;margin-bottom:10px;text-transform:uppercase;text-align:center}.pmc-transfer-amount{font-size:18px;font-weight:bold;color:#155724;text-align:center}.tax-table{width:100%;border-collapse:collapse;font-size:11px;margin-top:10px}.tax-table th{background:#333;color:#fff;font-weight:bold;text-align:center;border:1px solid #000;padding:8px}.tax-table td{border:1px solid #000;padding:8px;text-align:left}.tax-info{background:#e8f4f8;border:2px solid #17a2b8;padding:15px;margin:15px 0;border-radius:5px}.tax-info-title{font-size:14px;font-weight:bold;color:#0c5460;margin-bottom:10px;text-transform:uppercase;text-align:center}@media print{.sidebar,.back-btn,.print-btn,.action-buttons,.copy-link-btn{display:none}.main{margin-left:0;width:100%}.page{padding:20px}}
</style>
</head>
<body>
<div class="sidebar"><h3>üéØ OCEAN VACATIONS</h3>
<div class="section"><label class="label">Select Owner</label><select id="ownerSelect" onchange="onOwnerChange()"><option value="">-- Select Owner --</option></select></div>
<div class="section"><label class="label">Month</label><select id="monthSelect"></select></div>
<div class="section"><label class="label">Year</label><select id="yearSelect"></select></div>
<div class="section"><label class="label">Upload CSV</label><input type="file" id="csvFile" accept=".csv"></div>
<button class="btn btn-primary" onclick="generateStatement()">‚ñ∂ STATEMENT</button>
<button class="btn btn-success" onclick="generateSummary()">üìä View Summary</button>
<button class="btn btn-warning" onclick="generateAnnual()">üìà Annual Report</button>
<hr style="border:1px solid #555;margin:20px 0">
<button class="btn btn-success" onclick="openAddExpenseModal()" style="font-size:13px;font-weight:bold">üí∞ ADD EXPENSE</button>
<hr style="border:1px solid #555;margin:20px 0">
<h4 style="color:#fff;margin-bottom:10px">üè¢ Vendors</h4>
<input type="text" id="vendorName" placeholder="Vendor name">
<input type="text" id="vendorPhone" placeholder="Phone/Email">
<button class="btn btn-success" onclick="addVendor()" style="font-size:11px">Add Vendor</button>
<button class="btn btn-warning" onclick="showVendorModal()" style="font-size:11px">View/Manage</button>
<hr style="border:1px solid #555;margin:20px 0">
<button class="btn btn-info" onclick="openOwnerSettings()" style="font-size:11px">‚öôÔ∏è Owner Settings</button>
<button class="btn btn-info" onclick="openPropertySettings()" style="font-size:11px">‚öôÔ∏è Tax Settings</button>
<button class="btn btn-warning" onclick="setupGitHub()" style="font-size:11px">üîë GitHub Setup</button>
<button class="btn btn-warning" onclick="setupDropbox()" style="font-size:11px">üìÅ Dropbox Setup</button>
</div>

<div id="modalOverlay" class="modal-overlay"></div>

<div id="addExpenseModal" class="modal"><div><div class="modal-title">üí∞ Add Expense</div>
<div class="modal-field"><label class="modal-label">Type</label><select id="newExpenseType" class="modal-input"><option>Maintenance</option><option>Repair</option><option>Purchase</option><option>Supplies</option><option>Service</option><option>Pool Cleaning</option><option>Pest Control</option><option>Credit</option><option>Adjustment</option></select></div>
<div class="modal-field"><label class="modal-label">Property</label><select id="newExpenseProperty" class="modal-input"></select></div>
<div class="modal-field"><label class="modal-label">Vendor</label><select id="newExpenseVendor" class="modal-input"></select></div>
<div class="modal-field"><label class="modal-label">Amount</label><input type="number" id="newExpenseAmount" class="modal-input" placeholder="0.00" step="0.01"></div>
<div class="modal-field"><label class="modal-label">Notes</label><input type="text" id="newExpenseNotes" class="modal-input" placeholder="Optional"></div>
<div class="modal-field"><label class="modal-label">Invoice</label><label class="file-upload-area" onclick="document.getElementById('newExpenseFile').click()">üìé Click<input type="file" id="newExpenseFile" accept=".pdf,.jpg,.jpeg,.png"></label><div class="file-name-display" id="fileNameDisplay"></div></div>
<div class="modal-actions"><button class="btn-add" onclick="submitNewExpense()">‚úì Add</button><button class="btn-cancel" onclick="closeModal('addExpenseModal')">‚úó Close</button></div>
</div></div>

<div id="vendorModal" class="modal"><div><div class="modal-title">üè¢ Vendors</div>
<div class="modal-field"><label class="modal-label">Name</label><input type="text" id="vendorNameNew" class="modal-input" placeholder="Vendor name"></div>
<div class="modal-field"><label class="modal-label">Phone</label><input type="text" id="vendorPhoneNew" class="modal-input" placeholder="Phone/Email"></div>
<button class="btn btn-success" onclick="addVendorFromModal()" style="width:100%;margin-bottom:20px">‚ûï Add</button>
<div class="modal-scroll" id="vendorListModal"></div>
<div class="modal-actions"><button class="btn-cancel" onclick="closeModal('vendorModal')">‚úó Close</button></div>
</div></div>

<div id="ownerSettingsModal" class="modal"><div><div class="modal-title">‚öôÔ∏è Owner Management</div>
<div class="modal-field"><label class="modal-label">Owner Name</label><input type="text" id="newOwnerName" class="modal-input" placeholder="Owner Name"></div>
<div class="modal-field"><label class="modal-label">Email</label><input type="email" id="newOwnerEmail" class="modal-input" placeholder="Email"></div>
<div class="modal-field"><label class="modal-label">Commission %</label><input type="number" id="newOwnerPercent" class="modal-input" placeholder="Commission %" step="0.01"></div>
<div class="modal-field"><label class="modal-label">Sales Fee %</label><input type="number" id="newOwnerSales" class="modal-input" placeholder="Sales Fee %" step="0.01"></div>
<div class="modal-field"><label class="modal-label">Type</label><select id="newOwnerType" class="modal-input"><option value="draft">Draft</option><option value="payout">Payout</option></select></div>
<button class="btn btn-success" onclick="addNewOwner()" style="width:100%;margin-bottom:20px">‚ûï Add</button>
<div class="modal-scroll" id="ownerSettingsContent"></div>
<div class="modal-actions"><button class="btn-add" onclick="saveOwnerSettingsToGitHub()">üíæ Save</button><button class="btn-cancel" onclick="closeModal('ownerSettingsModal')">‚úó Close</button></div>
</div></div>

<div id="propertySettingsModal" class="modal"><div><div class="modal-title">‚öôÔ∏è Tax Settings</div>
<div class="modal-scroll" id="propertySettingsContent"></div>
<div class="modal-actions"><button class="btn-add" onclick="savePropertySettingsToGitHub()">üíæ Save</button><button class="btn-cancel" onclick="closeModal('propertySettingsModal')">‚úó Close</button></div>
</div></div>

<div id="editExpenseModal" class="modal"><div><div class="modal-title">‚úèÔ∏è Edit</div>
<div class="modal-field"><label class="modal-label">Type</label><select id="editExpenseType" class="modal-input"><option>Maintenance</option><option>Repair</option><option>Purchase</option><option>Supplies</option><option>Service</option><option>Pool Cleaning</option><option>Pest Control</option></select></div>
<div class="modal-field"><label class="modal-label">Vendor</label><select id="editExpenseVendor" class="modal-input"></select></div>
<div class="modal-field"><label class="modal-label">Amount</label><input type="number" id="editExpenseAmount" class="modal-input" placeholder="Amount" step="0.01"></div>
<div class="modal-field"><label class="modal-label">Notes</label><input type="text" id="editExpenseNotes" class="modal-input" placeholder="Notes"></div>
<div class="modal-actions"><button class="btn-add" onclick="saveEditedExpense()">Save</button><button class="btn-cancel" onclick="closeModal('editExpenseModal')">Close</button></div>
</div></div>

<div id="invoiceModal" class="invoice-modal"><div class="invoice-modal-content"><span class="invoice-modal-close" onclick="closeInvoiceModal()">&times;</span><div id="invoiceContent"></div></div></div>

<div class="main"><div id="content" class="page"><div class="invoice-header"><div class="company-info"><div class="company-name">OCEAN VACATIONS</div><div>www.oceanvacationsmb.com</div><div>oceanvacationsmb@gmail.com</div><div>843-222-6516</div></div><div class="right-header"><div class="statement-date" id="statementDate"></div><div class="period-date" id="periodDate"></div></div></div><div class="report-title">RESERVATION REPORT</div><div class="owner-name" id="ownerTitle"></div><div id="mainContent"><div style="text-align:center;padding:40px;color:#666">Select owner and upload CSV to begin.</div></div></div></div>

<script>
const GITHUB_URL="https://raw.githubusercontent.com/oceanvacationsmb/reports/main/data.json";
let gitHubData={},vendors=[],expenses=[],csvData=[],properties=[],propertySettings={},ownerSettings={},currentOwner="",masterTotals={},propertyTotals={},taxByProperty={},editingExpenseId=null,selectedFile=null;
const municipalities=["SC","MB","NMB","SSB","HC"];
const OWNERS={"ERAN":{percent:0.12,type:"draft",salesFeePercent:5,email:""},"GHO":{percent:0.10,type:"payout",salesFeePercent:5,email:""},"1463 Basin Trail":{percent:0.12,type:"payout",salesFeePercent:5,email:""},"113B-15S Surfside Beach":{percent:0.12,type:"payout",salesFeePercent:5,email:""},"113B-13N Surfside Beach":{percent:0.12,type:"payout",salesFeePercent:5,email:""},"115C-15N Surfside Beach":{percent:0.12,type:"payout",salesFeePercent:5,email:""},"2131 Sanibel Myrtle Beach":{percent:0.15,type:"payout",salesFeePercent:5,email:""},"1552 Elizabeth Ln Myrtle Beach":{percent:0.15,type:"payout",salesFeePercent:5,email:""},"469C White River RD Myrtle Beach":{percent:0.12,type:"payout",salesFeePercent:5,email:""},"4631-301 Wild Iris Drive Myrtle Beach":{percent:0.12,type:"payout",salesFeePercent:5,email:""},"4679-204 Wild Iris Drive Myrtle Beach":{percent:0.12,type:"payout",salesFeePercent:5,email:""},"508-1/2 33rd Ave North Myrtle Beach":{percent:0.15,type:"payout",salesFeePercent:10,email:""},"214-2S 2nd Ave S. North Myrtle Beach":{percent:0.12,type:"payout",salesFeePercent:10,email:""}};

async function loadDataFromGitHub(){try{const r=await fetch(GITHUB_URL+"?t="+Date.now());if(!r.ok)throw new Error(r.status);gitHubData=await r.json();if(gitHubData.owners)Object.keys(gitHubData.owners).forEach(e=>{OWNERS[e]=Object.assign({},OWNERS[e]||{},gitHubData.owners[e]);ownerSettings[e]=gitHubData.owners[e]});if(gitHubData.vendors)vendors=gitHubData.vendors;if(gitHubData.properties)Object.keys(gitHubData.properties).forEach(e=>{propertySettings[e]=gitHubData.properties[e]});if(gitHubData.expenses)expenses=gitHubData.expenses;buildOwnerDropdown();buildMonthDropdown();buildYearDropdown();updateVendorList()}catch(e){console.error(e);buildOwnerDropdown();buildMonthDropdown();buildYearDropdown()}}

function setupGitHub(){const t=localStorage.getItem("github_token")||"";const n=prompt("GitHub Token:",t);if(n&&n.trim()){localStorage.setItem("github_token",n.trim());loadDataFromGitHub();alert("‚úì Saved!")}}

function setupDropbox(){const t=localStorage.getItem("dropbox_token")||"";const n=prompt("Dropbox Access Token:",t);if(n&&n.trim()){localStorage.setItem("dropbox_token",n.trim());alert("‚úì Saved!")}}

async function saveToGitHub(a){const t=localStorage.getItem("github_token");if(!t)return false;try{const n=JSON.stringify(a,null,2);const e=btoa(unescape(encodeURIComponent(n)));const i=await fetch("https://api.github.com/repos/oceanvacationsmb/reports/contents/data.json",{headers:{"Authorization":"token "+t}});if(!i.ok)throw new Error("fail");const s=await i.json();const r=await fetch("https://api.github.com/repos/oceanvacationsmb/reports/contents/data.json",{method:"PUT",headers:{"Authorization":"token "+t,"Content-Type":"application/json"},body:JSON.stringify({message:"Update "+new Date().toLocaleString(),content:e,sha:s.sha,branch:"main"})});return r.ok}catch(e){return false}}

function buildOwnerDropdown(){const e=document.getElementById("ownerSelect");e.innerHTML='<option value="">-- Select --</option>';Object.keys(OWNERS).sort().forEach(n=>{const t=document.createElement("option");t.value=n;t.text=n;e.appendChild(t)})}

function buildMonthDropdown(){const e=document.getElementById("monthSelect");const n=["January","February","March","April","May","June","July","August","September","October","November","December"];n.forEach((t,a)=>{const s=document.createElement("option");s.value=a+1;s.text=t;e.appendChild(s)});e.value=new Date().getMonth()+1}

function buildYearDropdown(){const e=document.getElementById("yearSelect");const n=new Date().getFullYear();for(let t=n-2;t<=n+2;t++){const a=document.createElement("option");a.value=t;a.text=t;e.appendChild(a)}e.value=n}

function onOwnerChange(){currentOwner=document.getElementById("ownerSelect").value}

function getMonthName(e){const n=["January","February","March","April","May","June","July","August","September","October","November","December"];return n[e-1]}

function updateHeaderDates(){const e=parseInt(document.getElementById("monthSelect").value);const n=parseInt(document.getElementById("yearSelect").value);const t=new Date(n,e,0).getDate();let a=e+1,s=n;if(a>12){a=1;s++}document.getElementById("statementDate").innerHTML="Statement Date:<br><strong>"+getMonthName(a)+" 1st, "+s+"</strong>";document.getElementById("periodDate").innerHTML="Period: "+getMonthName(e)+" 1-"+t+", "+n;document.getElementById("ownerTitle").textContent=currentOwner}

function openOwnerSettings(){const e=document.getElementById("ownerSettingsContent");let n="";Object.keys(OWNERS).sort().forEach(t=>{const a=OWNERS[t];n+="<div style='background:#555;padding:10px;margin:8px 0;border-radius:3px'><div style='font-weight:bold;color:#fff;margin-bottom:8px'>"+t+"</div><input type='email' value='"+(a.email||"")+"' onchange=\"OWNERS['"+t+"'].email=this.value;ownerSettings['"+t+"'].email=this.value\" class='modal-input' placeholder='Email' style='margin-bottom:8px'><select onchange=\"OWNERS['"+t+"'].type=this.value;ownerSettings['"+t+"'].type=this.value\" class='modal-input' style='margin-bottom:8px'><option value='draft' "+(a.type==='draft'?'selected':'')+"‚Äã>Draft</option><option value='payout' "+(a.type==='payout'?'selected':'')+"‚Äã>Payout</option></select><input type='number' step='0.01' value='"+(a.percent*100)+"' onchange=\"OWNERS['"+t+"'].percent=this.value/100;ownerSettings['"+t+"'].percent=this.value/100\" class='modal-input' placeholder='%' style='margin-bottom:8px'><input type='number' step='0.01' value='"+a.salesFeePercent+"' onchange=\"OWNERS['"+t+"'].salesFeePercent=parseFloat(this.value);ownerSettings['"+t+"'].salesFeePercent=parseFloat(this.value)\" class='modal-input' placeholder='Sales %'><button class='btn btn-danger btn-small' onclick=\"delete OWNERS['"+t+"'];delete ownerSettings['"+t+"'];openOwnerSettings()\" style='width:100%;margin-top:8px'>Delete</button></div>"});e.innerHTML=n;openModal("ownerSettingsModal")}

function addNewOwner(){const e=document.getElementById("newOwnerName").value.trim();const n=document.getElementById("newOwnerEmail").value.trim();const t=parseFloat(document.getElementById("newOwnerPercent").value)||0.12;const a=parseFloat(document.getElementById("newOwnerSales").value)||5;const s=document.getElementById("newOwnerType").value;if(!e)return;OWNERS[e]={percent:t/100,type:s,salesFeePercent:a,email:n};ownerSettings[e]={percent:t/100,type:s,salesFeePercent:a,email:n};document.getElementById("newOwnerName").value="";document.getElementById("newOwnerEmail").value="";document.getElementById("newOwnerPercent").value="";document.getElementById("newOwnerSales").value="";openOwnerSettings();buildOwnerDropdown()}

async function saveOwnerSettingsToGitHub(){const e=Object.assign({},gitHubData,{owners:ownerSettings});await saveToGitHub(e);buildOwnerDropdown();alert("‚úì Saved")}

function openPropertySettings(){const e=document.getElementById("propertySettingsContent");let n="";Object.keys(OWNERS).forEach(t=>{n+="<div style='background:#555;padding:10px;margin:8px 0;border-radius:3px'><div style='font-weight:bold;color:#fff;margin-bottom:10px'>"+t+"</div><div class='checkbox-group'>";municipalities.forEach(a=>{n+="<div class='checkbox-item'><input type='checkbox' id='m_"+t+"_"+a+"' onchange=\"if(!propertySettings['"+t+"'])propertySettings['"+t+"']={municipalities:{}};propertySettings['"+t+"'].municipalities['"+a+"']=this.checked\"><label for='m_"+t+"_"+a+"'>"+a+"</label></div>"});n+="</div></div>"});e.innerHTML=n;openModal("propertySettingsModal")}

async function savePropertySettingsToGitHub(){const e=Object.assign({},gitHubData,{properties:propertySettings});await saveToGitHub(e);alert("‚úì Saved")}

async function addVendor(){const e=document.getElementById("vendorName").value.trim();const n=document.getElementById("vendorPhone").value.trim();if(!e)return;vendors.push({id:Date.now(),name:e,phone:n});updateVendorList();document.getElementById("vendorName").value="";document.getElementById("vendorPhone").value="";const t=Object.assign({},gitHubData,{vendors:vendors});await saveToGitHub(t);alert("‚úì Added")}

function addVendorFromModal(){const e=document.getElementById("vendorNameNew").value.trim();const n=document.getElementById("vendorPhoneNew").value.trim();if(!e)return;vendors.push({id:Date.now(),name:e,phone:n});updateVendorList();document.getElementById("vendorNameNew").value="";document.getElementById("vendorPhoneNew").value="";const t=Object.assign({},gitHubData,{vendors:vendors});saveToGitHub(t);showVendorModal()}

async function deleteVendor(e){vendors=vendors.filter(n=>n.id!==e);updateVendorList();const n=Object.assign({},gitHubData,{vendors:vendors});await saveToGitHub(n);showVendorModal()}

function updateVendorList(){const e=document.getElementById("newExpenseVendor");const n=document.getElementById("editExpenseVendor");e.innerHTML="<option>--Select--</option>";n.innerHTML="<option>--Select--</option>";vendors.forEach(t=>{e.innerHTML+="<option>"+t.name+"</option>";n.innerHTML+="<option>"+t.name+"</option>"})}

function showVendorModal(){const e=document.getElementById("vendorListModal");let n="";vendors.forEach(t=>{n+="<div style='background:#555;padding:10px;margin:5px 0;border-radius:3px;display:flex;justify-content:space-between;align-items:center'><div><div style='color:#fff;font-weight:bold'>"+t.name+"</div><div style='color:#aaa;font-size:10px'>"+t.phone+"</div></div><button onclick='deleteVendor("+t.id+")' class='btn btn-danger btn-small'>Delete</button></div>"});e.innerHTML=n;openModal("vendorModal")}

function openAddExpenseModal(){if(!currentOwner)return;properties=[];csvData.forEach(e=>{const n=e["LISTING'S NICKNAME"]||"Unknown";if(!properties.includes(n))properties.push(n)});const e=document.getElementById("newExpenseProperty");e.innerHTML="<option>--Select--</option>";properties.forEach(n=>{e.innerHTML+="<option>"+n+"</option>"});openModal("addExpenseModal")}

function openModal(e){document.getElementById("modalOverlay").classList.add("show");document.getElementById(e).classList.add("show")}

function closeModal(e){document.getElementById(e).classList.remove("show");const n=["addExpenseModal","vendorModal","ownerSettingsModal","propertySettingsModal","editExpenseModal"];if(!n.some(n=>document.getElementById(n).classList.contains("show"))){document.getElementById("modalOverlay").classList.remove("show")}}

document.addEventListener("change",e=>{if(e.target.id==="newExpenseFile"){selectedFile=e.target.files[0];document.getElementById("fileNameDisplay").textContent=selectedFile?"‚úì "+selectedFile.name:""}});

async function submitNewExpense(){const e=document.getElementById("newExpenseType").value;const n=document.getElementById("newExpenseProperty").value;const t=document.getElementById("newExpenseVendor").value;const a=parseFloat(document.getElementById("newExpenseAmount").value);if(!currentOwner||!n||!t||!a)return;const s={id:Date.now(),owner:currentOwner,type:e,property:n,vendor:t,amount:a,notes:document.getElementById("newExpenseNotes").value,invoice:null};if(selectedFile){const r=new FileReader();r.onload=async()=>{const i=await uploadToDropbox(selectedFile);s.invoice={filename:selectedFile.name,dropboxLink:i};expenses.push(s);await saveToGitHub(Object.assign({},gitHubData,{expenses}));closeModal("addExpenseModal");alert("‚úì Added")};r.readAsArrayBuffer(selectedFile)}else{expenses.push(s);await saveToGitHub(Object.assign({},gitHubData,{expenses}));closeModal("addExpenseModal");alert("‚úì Added")}}

async function uploadToDropbox(e){const n=localStorage.getItem("dropbox_token");if(!n)return null;try{const t=new FileReader();t.onload=async()=>{const a=await fetch("https://content.dropboxapi.com/2/files/upload",{method:"POST",headers:{"Authorization":"Bearer "+n,"Dropbox-API-Arg":JSON.stringify({path:"/statements/"+Date.now()+"_"+e.name,mode:"add"})},body:t.result});if(a.ok){const s=await fetch("https://www.dropboxapi.com/2/sharing/create_shared_link_with_settings",{method:"POST",headers:{"Authorization":"Bearer "+n,"Content-Type":"application/json"},body:JSON.stringify({path:"/statements/"+Date.now()+"_"+e.name,settings:{requested_visibility:"public"}})});if(s.ok){const r=await s.json();return r.url.replace("?dl=0","?dl=1")}}};t.readAsArrayBuffer(e)}catch(e){return null}}

function openInvoiceModal(e){const n=expenses.find(n=>n.id===e);if(!n||!n.invoice)return;document.getElementById("invoiceContent").innerHTML='<iframe src="'+n.invoice.dropboxLink+'" style="width:100%;height:100vh;border:none"></iframe>';document.getElementById("invoiceModal").style.display="flex"}

function closeInvoiceModal(){document.getElementById("invoiceModal").style.display="none"}

function openEditExpense(e){const n=expenses.find(n=>n.id===e);if(!n)return;editingExpenseId=e;document.getElementById("editExpenseType").value=n.type;document.getElementById("editExpenseVendor").value=n.vendor;document.getElementById("editExpenseAmount").value=n.amount;document.getElementById("editExpenseNotes").value=n.notes;openModal("editExpenseModal")}

async function saveEditedExpense(){if(!editingExpenseId)return;const e=expenses.find(n=>n.id===editingExpenseId);e.type=document.getElementById("editExpenseType").value;e.vendor=document.getElementById("editExpenseVendor").value;e.amount=parseFloat(document.getElementById("editExpenseAmount").value);e.notes=document.getElementById("editExpenseNotes").value;await saveToGitHub(Object.assign({},gitHubData,{expenses}));closeModal("editExpenseModal");alert("‚úì Saved")}

async function deleteExpense(e){expenses=expenses.filter(n=>n.id!==e);await saveToGitHub(Object.assign({},gitHubData,{expenses}));if(csvData.length)displayStatement()}

function money(e){return"$"+(Number(e)||0).toFixed(2)}

function num(e){return parseFloat((e||"0").toString().replace(/[$,]/g,""))||0}

async function generateStatement(){const e=document.getElementById("csvFile").files[0];if(!e||!currentOwner)return;updateHeaderDates();const n=new FileReader();n.onload=t=>{csvData=Papa.parse(t.target.result,{header:true,skipEmptyLines:true}).data;processData();displayStatement()};n.readAsText(e)}

function processData(){const e=parseInt(document.getElementById("monthSelect").value);const n=parseInt(document.getElementById("yearSelect").value);const t=OWNERS[currentOwner];propertyTotals={};masterTotals={gross:0,acc:0,clean:0,pmc:0,expenses:0,draft:0,owner:0,websiteFee:0};let a={};csvData.forEach(t=>{if(!t["CHECK-IN DATE"])return;let s=parseInt(t["CHECK-IN DATE"].split("-")[1]),r=parseInt(t["CHECK-IN DATE"].split("-")[0]);if(s!==e||r!==n)return;let i=t["LISTING'S NICKNAME"]||"Unknown";if(!a[i])a[i]=[];a[i].push(t)});Object.keys(a).forEach(e=>{let n=0,s=0,r=0,i=0,d=0;a[e].forEach(e=>{let a=num(e["TOTAL PAYOUT"]),c=num(e["ACCOMMODATION FARE"])-num(e["MARKUP"]),o=(e["STATUS"]||"").toLowerCase().includes("cancelled")?0:num(e["CLEANING FARE"]),l=c*t.percent;n+=a;s+=c;r+=o;i+=l;d+=(c>0&&!e["CONFIRMATION CODE"].toUpperCase().startsWith("HA")&&(e["PLATFORM"]||"").toLowerCase().includes("website")?a*0.01:0)});let c=expenses.filter(n=>n.property===e&&n.owner===currentOwner).reduce((e,n)=>e+n.amount,0);propertyTotals[e]={gross:n,acc:s,clean:r,pmc:i,websiteFee:d,expenses:c,draft:i+r+d+c,owner:s-i-c,reservations:a[e]};masterTotals.gross+=n;masterTotals.acc+=s;masterTotals.clean+=r;masterTotals.pmc+=i;masterTotals.websiteFee+=d;masterTotals.expenses+=c;masterTotals.draft+=i+r+d+c;masterTotals.owner+=s-i-c})}

function displayStatement(){const e=OWNERS[currentOwner].type;let n="<div class='action-buttons'><button class='copy-link-btn' onclick='generateAndShareLink()'>üîó Generate Link</button></div>";n+="<div class='summary-title'>FINANCIAL SUMMARY</div><div class='summary-grid'>";if(e==="draft"){n+="<div class='summary-card'><div class='summary-label'>Gross</div><div class='summary-value'>"+money(masterTotals.gross)+"</div></div><div class='summary-card'><div class='summary-label'>Accommodation</div><div class='summary-value'>"+money(masterTotals.acc)+"</div></div><div class='summary-card'><div class='summary-label'>PMC</div><div class='summary-value'>"+money(masterTotals.pmc)+"</div></div><div class='summary-card'><div class='summary-label'>Cleaning</div><div class='summary-value'>"+money(masterTotals.clean)+"</div></div><div class='summary-card'><div class='summary-label'>Website</div><div class='summary-value'>"+money(masterTotals.websiteFee)+"</div></div><div class='summary-card'><div class='summary-label'>Expenses</div><div class='summary-value'>"+money(masterTotals.expenses)+"</div></div><div class='summary-card' style='background:#000;color:#fff'><div class='summary-label' style='color:#fff'>DUE</div><div class='summary-value' style='color:#fff'>"+money(masterTotals.draft)+"</div></div>"}else{n+="<div class='summary-card'><div class='summary-label'>Accommodation</div><div class='summary-value'>"+money(masterTotals.acc)+"</div></div><div class='summary-card'><div class='summary-label'>PMC</div><div class='summary-value'>"+money(masterTotals.pmc)+"</div></div><div class='summary-card'><div class='summary-label'>Expenses</div><div class='summary-value'>"+money(masterTotals.expenses)+"</div></div><div class='summary-card' style='background:#000;color:#fff'><div class='summary-label' style='color:#fff'>PAYOUT</div><div class='summary-value' style='color:#fff'>"+money(masterTotals.owner)+"</div></div>"}n+="</div>";Object.keys(propertyTotals).forEach(t=>{const a=propertyTotals[t];n+="<div class='property-section'><div class='property-title'><span class='property-icon'>üè†</span>"+t.toUpperCase()+"</div><table><tr><th>Code</th><th>Stay</th><th>Accommodation</th><th>PMC</th></tr>";a.reservations.forEach(t=>{const s=num(t["ACCOMMODATION FARE"])-num(t["MARKUP"]),r=s*OWNERS[currentOwner].percent;n+="<tr><td>"+(t["CONFIRMATION CODE"]||"").substring(0,8)+"</td><td>"+(t["CHECK-IN DATE"]||"")+"</td><td>"+money(s)+"</td><td>"+money(r)+"</td></tr>"});const s=expenses.filter(n=>n.property===t&&n.owner===currentOwner);n+="</table>";if(s.length>0){n+="<div class='section-title'>EXPENSES</div>";s.forEach(e=>{n+="<div class='attachment'><div class='attachment-left'><strong>"+e.type+"</strong> - "+e.vendor+": "+money(e.amount)+"</div><div class='attachment-actions'>";if(e.invoice)n+="<button class='invoice-btn' onclick='openInvoiceModal("+e.id+")'>üìÑ</button>";n+="<button onclick='openEditExpense("+e.id+")' class='btn btn-info btn-small'>Edit</button><button onclick='deleteExpense("+e.id+")' class='btn btn-danger btn-small'>Delete</button></div></div>"})}n+="</div>"});document.getElementById("mainContent").innerHTML=n}

async function generateAndShareLink(){const e=parseInt(document.getElementById("monthSelect").value);const n=parseInt(document.getElementById("yearSelect").value);const t=localStorage.getItem("dropbox_token");if(!t){alert("Setup Dropbox first");return}const a=currentOwner+"_"+e+"_"+n+"_"+Date.now()+".html";const s=document.getElementById("content").innerHTML;const r="<html><head><title>Statement</title><style>"+document.querySelector("style").innerHTML+"</style></head><body>"+s+"</body></html>";try{const i=await fetch("https://content.dropboxapi.com/2/files/upload",{method:"POST",headers:{"Authorization":"Bearer "+t,"Dropbox-API-Arg":JSON.stringify({path:"/statements/"+a,mode:"add"})},body:r});if(i.ok){const s=await fetch("https://www.dropboxapi.com/2/sharing/create_shared_link_with_settings",{method:"POST",headers:{"Authorization":"Bearer "+t,"Content-Type":"application/json"},body:JSON.stringify({path:"/statements/"+a,settings:{requested_visibility:"public"}})});if(s.ok){const n=await s.json();const t=n.url.replace("?dl=0","?dl=1");document.getElementById("mainContent").innerHTML+="<div style='background:#d4edda;padding:15px;margin:20px 0;border-radius:5px;text-align:center'><h3 style='color:#155724'>‚úì Generated!</h3><button class='copy-link-btn' onclick=\"copyToClipboard('"+t+"')\">üìã Copy Link</button><p style='font-size:11px;color:#155724;word-break:break-all'>"+t+"</p></div>"}}else alert("Error creating link")}else alert("Upload failed")}catch(e){alert("Error: "+e.message)}}

function copyToClipboard(e){navigator.clipboard.writeText(e).then(()=>alert("‚úì Copied")).catch(()=>alert("Failed"))}

async function generateSummary(){if(!csvData.length)return;updateHeaderDates();const e=OWNERS[currentOwner];const n=masterTotals.pmc*(e.salesFeePercent/100);let t="<button class='back-btn' onclick='displayStatement()'>‚Üê Back</button><div class='commission-box'><div class='commission-box-title'>Commission Calculation</div><div class='calc-row'><span>Accommodation</span><span>"+money(masterTotals.acc)+"</span></div><div class='calc-row'><span>Rate</span><span>"+(e.percent*100).toFixed(2)+"%</span></div><div class='calc-row-total'><span>PMC</span><span>"+money(masterTotals.pmc)+"</span></div><div class='calc-row'><span>Sales Fee</span><span>"+e.salesFeePercent+"%</span></div><div class='calc-row-total'><span>Commission</span><span>"+money(n)+"</span></div></div><div class='pmc-transfer-box'><div class='pmc-transfer-title'>üí≥ PMC Transfer</div><div class='pmc-transfer-amount'>"+money(masterTotals.pmc)+"</div></div>";document.getElementById("mainContent").innerHTML=t}

async function generateAnnual(){if(OWNERS[currentOwner].type!=="payout")return;let e="<button class='back-btn' onclick='displayStatement()'>‚Üê Back</button><div class='summary-title'>ANNUAL</div><table><tr><td>Accommodation</td><td>"+money(masterTotals.acc)+"</td></tr><tr><td>PMC</td><td>"+money(masterTotals.pmc)+"</td></tr><tr><td>Expenses</td><td>"+money(masterTotals.expenses)+"</td></tr><tr style='background:#000;color:#fff'><td>NET</td><td>"+money(masterTotals.owner)+"</td></tr></table>";document.getElementById("mainContent").innerHTML=e}

loadDataFromGitHub();
</script>
</body>
</html>
