<!DOCTYPE html>
<html>
<head>
<title>Ocean Vacations - Reservation Report</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial;background:#f5f5f5;color:#000;display:flex}.sidebar{width:280px;background:#333;color:#fff;padding:20px;height:100vh;overflow-y:auto;position:fixed;left:0;top:0}.sidebar h3{margin-bottom:20px;font-size:16px;border-bottom:2px solid #fff;padding-bottom:10px}.section{margin-bottom:20px}.label{font-size:11px;font-weight:bold;color:#aaa;margin-bottom:5px;display:block}select,input{width:100%;padding:8px;margin:5px 0;border:1px solid #555;background:#444;color:#fff;border-radius:3px;font-size:11px}.btn{width:100%;padding:12px;margin:8px 0;border:none;font-weight:bold;border-radius:3px;cursor:pointer;font-size:12px;color:#fff;transition:all 0.3s}.btn-primary{background:#000}.btn-success{background:#28a745}.btn-warning{background:#ff9800}.btn-info{background:#17a2b8}.btn-danger{background:#dc3545}.main{margin-left:280px;padding:20px;width:calc(100% - 280px)}.page{background:#fff;padding:40px;border-radius:5px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}.invoice-header{display:flex;justify-content:space-between;margin-bottom:40px;border-bottom:2px solid #000;padding-bottom:30px}.company-info{font-size:11px;line-height:1.8}.company-name{font-size:20px;font-weight:bold;margin-bottom:5px}.report-title{text-align:center;font-size:32px;font-weight:bold;margin:40px 0 10px 0;letter-spacing:2px}.owner-name{text-align:center;font-size:28px;margin-bottom:40px;font-weight:bold;color:#000}table{width:100%;border-collapse:collapse;margin:20px 0;font-size:11px}th,td{border:1px solid #e0e0e0;padding:12px;text-align:left}th{background:#f5f5f5;color:#000;font-weight:bold;text-transform:uppercase}tr:nth-child(even){background:#fafafa}.action-buttons{display:flex;gap:10px;margin:20px 0;justify-content:center;flex-wrap:wrap}.action-buttons button{padding:10px 20px;font-size:12px;cursor:pointer;border:none;border-radius:3px;color:#fff;font-weight:bold}.back-btn{background:#666}.print-btn{background:#e74c3c}.save-btn{background:#28a745}.property-section{margin:40px 0;padding:20px;border:1px solid #ddd;border-radius:5px;background:#fff}.property-title{font-size:14px;font-weight:bold;margin-bottom:15px;display:flex;align-items:center;text-transform:uppercase;text-align:center;justify-content:center}.property-icon{font-size:18px;margin-right:10px}.summary-title{font-size:12px;font-weight:bold;text-transform:uppercase;text-align:center;margin:20px 0}.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin:20px 0}.summary-card{background:#f9f9f9;border:1px solid #ddd;padding:12px;text-align:center;border-radius:5px}.summary-label{font-size:10px;color:#666;font-weight:bold;text-transform:uppercase}.summary-value{font-size:14px;font-weight:bold;color:#000;margin-top:6px}.attachment{background:#f0f0f0;padding:10px;margin:10px 0;border-radius:3px;font-size:10px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}.attachment-left{flex:1}.attachment-actions{display:flex;gap:5px;flex-wrap:wrap}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5)}.modal-content{background:#fff;margin:10% auto;padding:20px;border:1px solid #888;width:80%;max-width:600px;border-radius:5px;max-height:80vh;overflow-y:auto}.modal-close{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}.popup-modal{display:none;position:fixed;z-index:1001;left:50%;top:50%;transform:translate(-50%,-50%);width:90%;max-width:500px;background:#333;color:#fff;border-radius:8px;padding:30px;box-shadow:0 4px 20px rgba(0,0,0,0.3);max-height:90vh;overflow-y:auto}.popup-title{font-size:20px;font-weight:bold;margin-bottom:20px;text-transform:uppercase;text-align:center;border-bottom:2px solid #fff;padding-bottom:15px}.popup-field{margin-bottom:18px}.popup-label{font-size:11px;font-weight:bold;color:#aaa;margin-bottom:8px;display:block;text-transform:uppercase}.popup-input{width:100%;padding:10px;border:1px solid #555;background:#444;color:#fff;border-radius:3px;font-size:11px}.popup-actions{display:flex;gap:10px;margin-top:25px}.popup-actions button{flex:1;padding:12px;border:none;font-weight:bold;border-radius:3px;cursor:pointer;font-size:12px;color:#fff}.btn-add{background:#28a745}.btn-cancel{background:#666}.file-upload-area{border:2px dashed #555;border-radius:3px;padding:15px;text-align:center;cursor:pointer;background:#444}.file-upload-area input{display:none}.file-name-display{font-size:10px;color:#28a745;margin-top:8px}.invoice-modal{display:none;position:fixed;z-index:1002;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center}.invoice-modal-content{background:#fff;border-radius:8px;max-width:90%;max-height:90vh;overflow:auto;box-shadow:0 4px 20px rgba(0,0,0,0.4);position:relative}.invoice-modal-close{position:absolute;top:15px;right:15px;font-size:28px;color:#333;cursor:pointer;font-weight:bold;z-index:10}.tax-table{width:100%;border-collapse:collapse;font-size:11px;margin-top:10px}.tax-table th{background:#333;color:#fff;font-weight:bold;text-align:center;border:1px solid #000;padding:8px}.tax-table td{border:1px solid #000;padding:8px;text-align:left}.tax-info{background:#e8f4f8;border:2px solid #17a2b8;padding:15px;margin:15px 0;border-radius:5px}.tax-info-title{font-size:14px;font-weight:bold;color:#0c5460;margin-bottom:10px;text-transform:uppercase;text-align:center}.section-title{font-size:12px;font-weight:bold;text-transform:uppercase;margin-top:20px;margin-bottom:10px;color:#000}.checkbox-group{display:flex;flex-wrap:wrap;gap:15px;align-items:center}.checkbox-item{display:flex;align-items:center;gap:8px}.checkbox-item input{width:18px;height:18px;cursor:pointer}.checkbox-item label{color:#000;font-weight:bold;cursor:pointer;margin:0;font-size:12px}.btn-small{padding:5px 10px;font-size:9px;width:auto;margin:0;display:inline-block}.calc-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #ddd}.calc-row-total{display:flex;justify-content:space-between;padding:12px;background:#000;color:#fff;font-weight:bold}.commission-box{background:#fff3cd;border:2px solid #ffc107;padding:15px;margin:15px 0;border-radius:5px}.commission-box-title{font-size:14px;font-weight:bold;color:#856404;margin-bottom:10px;text-transform:uppercase;text-align:center}.pmc-transfer-box{background:#d4edda;border:2px solid #28a745;padding:15px;margin:15px 0;border-radius:5px}.pmc-transfer-title{font-size:14px;font-weight:bold;color:#155724;margin-bottom:10px;text-transform:uppercase;text-align:center}.pmc-transfer-amount{font-size:18px;font-weight:bold;color:#155724;text-align:center}.invoice-btn{background:#17a2b8;color:#fff;padding:3px 8px;border:none;border-radius:3px;cursor:pointer;font-size:9px;font-weight:bold}.copy-link-btn{background:#0066cc;color:#fff;padding:10px 15px;border:none;border-radius:3px;cursor:pointer;font-weight:bold;margin:10px 0;width:100%}.copy-link-btn:hover{background:#0052a3}.popup-scroll{max-height:400px;overflow-y:auto;margin:20px 0;padding:15px;background:#444;border-radius:3px}.vendor-item{background:#555;padding:12px;margin:8px 0;border-radius:3px;display:flex;justify-content:space-between;align-items:center}.vendor-info{flex:1}.vendor-name{font-weight:bold;color:#fff}.vendor-phone{font-size:10px;color:#aaa;margin-top:5px}@media print{.sidebar,.back-btn,.print-btn,.save-btn,.action-buttons,.copy-link-btn{display:none}.main{margin-left:0;width:100%}.page{padding:20px}}
</style>
</head>
<body>
<div class="sidebar"><h3>üéØ OCEAN VACATIONS</h3>
<div class="section"><label class="label">Select Owner</label><select id="ownerSelect" onchange="onOwnerChange()"><option value="">-- Select Owner --</option></select></div>
<div class="section"><label class="label">Month</label><select id="monthSelect"></select></div>
<div class="section"><label class="label">Year</label><select id="yearSelect"></select></div>
<div class="section"><label class="label">Upload CSV</label><input type="file" id="csvFile" accept=".csv"></div>
<button class="btn btn-primary" onclick="generateStatement()">‚ñ∂ STATEMENT</button>
<button class="btn btn-success" onclick="generateSummary()">üìä View Summary</button>
<button class="btn btn-warning" onclick="generateAnnual()">üìà Annual Report</button>
<hr style="border:1px solid #555;margin:20px 0">
<button class="btn btn-success" onclick="openAddExpenseModal()" style="font-size:13px;font-weight:bold">üí∞ ADD EXPENSE</button>
<hr style="border:1px solid #555;margin:20px 0">
<h4 style="color:#fff;margin-bottom:10px">üè¢ Vendors</h4>
<input type="text" id="vendorName" placeholder="Vendor name">
<input type="text" id="vendorPhone" placeholder="Phone/Email">
<button class="btn btn-success" onclick="addVendor()" style="font-size:11px">Add Vendor</button>
<button class="btn btn-warning" onclick="showVendorModal()" style="font-size:11px">View/Manage</button>
<hr style="border:1px solid #555;margin:20px 0">
<button class="btn btn-info" onclick="openOwnerSettings()" style="font-size:11px">‚öôÔ∏è Owner Settings</button>
<button class="btn btn-info" onclick="openPropertySettings()" style="font-size:11px">‚öôÔ∏è Tax Settings</button>
<button class="btn btn-warning" onclick="setupGitHub()" style="font-size:11px">üîë GitHub Setup</button>
<button class="btn btn-warning" onclick="setupDropbox()" style="font-size:11px">üìÅ Dropbox Setup</button>
</div>

<div id="addExpenseModal" class="popup-modal"><div><div class="popup-title">üí∞ Add Expense</div>
<div class="popup-field"><label class="popup-label">Type</label><select id="newExpenseType" class="popup-input"><option>Maintenance</option><option>Repair</option><option>Purchase</option><option>Supplies</option><option>Service</option><option>Pool Cleaning</option><option>Pest Control</option><option>Credit</option><option>Adjustment</option></select></div>
<div class="popup-field"><label class="popup-label">Property</label><select id="newExpenseProperty" class="popup-input"></select></div>
<div class="popup-field"><label class="popup-label">Vendor</label><select id="newExpenseVendor" class="popup-input"></select></div>
<div class="popup-field"><label class="popup-label">Amount</label><input type="number" id="newExpenseAmount" class="popup-input" placeholder="0.00" step="0.01"></div>
<div class="popup-field"><label class="popup-label">Notes</label><input type="text" id="newExpenseNotes" class="popup-input" placeholder="Optional notes"></div>
<div class="popup-field"><label class="popup-label">Invoice (Optional)</label><label class="file-upload-area" onclick="document.getElementById('newExpenseFile').click()">üìé Click to upload<input type="file" id="newExpenseFile" accept=".pdf,.jpg,.jpeg,.png"></label><div class="file-name-display" id="fileNameDisplay"></div></div>
<div class="popup-actions"><button class="btn-add" onclick="submitNewExpense()">‚úì Add Expense</button><button class="btn-cancel" onclick="closeAddExpenseModal()">‚úó Cancel</button></div>
</div></div>

<div id="vendorModal" class="popup-modal"><div><div class="popup-title">üè¢ Manage Vendors</div>
<div class="popup-field"><label class="popup-label">Vendor Name</label><input type="text" id="vendorNameNew" class="popup-input" placeholder="Vendor name"></div>
<div class="popup-field"><label class="popup-label">Phone/Email</label><input type="text" id="vendorPhoneNew" class="popup-input" placeholder="Phone/Email"></div>
<button class="btn btn-success" onclick="addVendorFromModal()" style="width:100%;margin-bottom:20px">‚ûï Add Vendor</button>
<div class="popup-scroll" id="vendorListModal"></div>
<div class="popup-actions"><button class="btn-cancel" onclick="closeVendorModal()" style="flex:1">‚úó Close</button></div>
</div></div>

<div id="ownerSettingsModal" class="popup-modal"><div><div class="popup-title">‚öôÔ∏è Owner Management</div>
<div class="popup-field"><label class="popup-label">Owner Name</label><input type="text" id="newOwnerName" class="popup-input" placeholder="Owner Name"></div>
<div class="popup-field"><label class="popup-label">Email</label><input type="email" id="newOwnerEmail" class="popup-input" placeholder="Email"></div>
<div class="popup-field"><label class="popup-label">Commission %</label><input type="number" id="newOwnerPercent" class="popup-input" placeholder="Commission %" step="0.01"></div>
<div class="popup-field"><label class="popup-label">Sales Fee %</label><input type="number" id="newOwnerSales" class="popup-input" placeholder="Sales Fee %" step="0.01"></div>
<div class="popup-field"><label class="popup-label">Type</label><select id="newOwnerType" class="popup-input"><option value="draft">Draft</option><option value="payout">Payout</option></select></div>
<button class="btn-add" onclick="addNewOwner()" style="width:100%;margin-bottom:20px">‚ûï Add Owner</button>
<div class="popup-scroll" id="ownerSettingsContent"></div>
<div class="popup-actions"><button class="btn-add" onclick="saveOwnerSettingsToGitHub()" style="flex:1">üíæ Save</button><button class="btn-cancel" onclick="closeOwnerSettings()" style="flex:1">‚úó Close</button></div>
</div></div>

<div id="propertySettingsModal" class="popup-modal"><div><div class="popup-title">‚öôÔ∏è Tax Settings</div>
<div class="popup-scroll" id="propertySettingsContent"></div>
<div class="popup-actions"><button class="btn-add" onclick="savePropertySettingsToGitHub()" style="flex:1">üíæ Save</button><button class="btn-cancel" onclick="closePropertySettings()" style="flex:1">‚úó Close</button></div>
</div></div>

<div id="editExpenseModal" class="popup-modal"><div><div class="popup-title">‚úèÔ∏è Edit Expense</div>
<div class="popup-field"><label class="popup-label">Type</label><select id="editExpenseType" class="popup-input"><option>Maintenance</option><option>Repair</option><option>Purchase</option><option>Supplies</option><option>Service</option><option>Pool Cleaning</option><option>Pest Control</option><option>Credit</option><option>Adjustment</option></select></div>
<div class="popup-field"><label class="popup-label">Vendor</label><select id="editExpenseVendor" class="popup-input"></select></div>
<div class="popup-field"><label class="popup-label">Amount</label><input type="number" id="editExpenseAmount" class="popup-input" placeholder="Amount" step="0.01"></div>
<div class="popup-field"><label class="popup-label">Notes</label><input type="text" id="editExpenseNotes" class="popup-input" placeholder="Notes"></div>
<div class="popup-actions"><button class="btn-add" onclick="saveEditedExpense()">Save Changes</button><button class="btn-cancel" onclick="closeEditExpense()">Cancel</button></div>
</div></div>

<div id="invoiceModal" class="invoice-modal"><div class="invoice-modal-content"><span class="invoice-modal-close" onclick="closeInvoiceModal()">&times;</span><div id="invoiceContent"></div></div></div>

<div class="main"><div id="content" class="page"><div class="invoice-header"><div class="company-info"><div class="company-name">OCEAN VACATIONS</div><div>www.oceanvacationsmb.com</div><div>oceanvacationsmb@gmail.com</div><div>843-222-6516</div></div><div class="right-header"><div class="statement-date" id="statementDate"></div><div class="period-date" id="periodDate"></div></div></div><div class="report-title">RESERVATION REPORT</div><div class="owner-name" id="ownerTitle"></div><div id="mainContent"><div style="text-align:center;padding:40px;color:#666">Ready to use! Select an owner and upload CSV to begin.</div></div></div></div>

<script>
const GITHUB_URL="https://raw.githubusercontent.com/oceanvacationsmb/reports/main/data.json";
let gitHubData={},vendors=[],expenses=[],csvData=[],properties=[],propertySettings={},ownerSettings={},currentOwner="",masterTotals={},propertyTotals={},taxByProperty={},savedReports=[],editingExpenseId=null,selectedFile=null;
const municipalities=["SC","MB","NMB","SSB","HC"];
const OWNERS={"ERAN":{percent:0.12,type:"draft",salesFeePercent:5,email:""},"GHO":{percent:0.10,type:"payout",salesFeePercent:5,email:""},"1463 Basin Trail":{percent:0.12,type:"payout",salesFeePercent:5,email:""},"113B-15S Surfside Beach":{percent:0.12,type:"payout",salesFeePercent:5,email:""},"113B-13N Surfside Beach":{percent:0.12,type:"payout",salesFeePercent:5,email:""},"115C-15N Surfside Beach":{percent:0.12,type:"payout",salesFeePercent:5,email:""},"2131 Sanibel Myrtle Beach":{percent:0.15,type:"payout",salesFeePercent:5,email:""},"1552 Elizabeth Ln Myrtle Beach":{percent:0.15,type:"payout",salesFeePercent:5,email:""},"469C White River RD Myrtle Beach":{percent:0.12,type:"payout",salesFeePercent:5,email:""},"4631-301 Wild Iris Drive Myrtle Beach":{percent:0.12,type:"payout",salesFeePercent:5,email:""},"4679-204 Wild Iris Drive Myrtle Beach":{percent:0.12,type:"payout",salesFeePercent:5,email:""},"508-1/2 33rd Ave North Myrtle Beach":{percent:0.15,type:"payout",salesFeePercent:10,email:""},"214-2S 2nd Ave S. North Myrtle Beach":{percent:0.12,type:"payout",salesFeePercent:10,email:""}};

async function loadDataFromGitHub(){try{const r=await fetch(GITHUB_URL+"?t="+Date.now());if(!r.ok)throw new Error("HTTP "+r.status);gitHubData=await r.json();gitHubData.owners&&Object.keys(gitHubData.owners).forEach(e=>{if(!OWNERS[e])OWNERS[e]={};OWNERS[e]=Object.assign({},OWNERS[e],gitHubData.owners[e]);ownerSettings[e]=gitHubData.owners[e]});gitHubData.vendors&&(vendors=gitHubData.vendors);gitHubData.properties&&Object.keys(gitHubData.properties).forEach(e=>{propertySettings[e]=gitHubData.properties[e]});gitHubData.expenses&&(expenses=gitHubData.expenses);gitHubData.reports&&(savedReports=gitHubData.reports);buildOwnerDropdown();buildMonthDropdown();buildYearDropdown();updateVendorList()}catch(e){console.error(e);buildOwnerDropdown();buildMonthDropdown();buildYearDropdown()}}

function setupGitHub(){const t=localStorage.getItem("github_token")||"";const n=prompt("GitHub Token:",t);if(n&&n.trim()){localStorage.setItem("github_token",n.trim());loadDataFromGitHub();alert("‚úì GitHub token saved!")}}

function setupDropbox(){const t=prompt("Enter Dropbox Access Token:");if(t&&t.trim()){localStorage.setItem("dropbox_token",t.trim());alert("‚úì Dropbox token saved! You can now generate links.")}}

async function saveToGitHub(a){const t=localStorage.getItem("github_token");if(!t){return false}try{const n=JSON.stringify(a,null,2);const e=btoa(unescape(encodeURIComponent(n)));const i=await fetch("https://api.github.com/repos/oceanvacationsmb/reports/contents/data.json",{headers:{"Authorization":"token "+t}});if(!i.ok)throw new Error("fetch fail");const s=await i.json();const r=await fetch("https://api.github.com/repos/oceanvacationsmb/reports/contents/data.json",{method:"PUT",headers:{"Authorization":"token "+t,"Content-Type":"application/json"},body:JSON.stringify({message:"Update: "+new Date().toLocaleString(),content:e,sha:s.sha,branch:"main"})});if(!r.ok)throw new Error("save fail");gitHubData=a;return true}catch(e){console.error(e);return false}}

function buildOwnerDropdown(){const e=document.getElementById("ownerSelect");e.innerHTML='<option value="">-- Select Owner --</option>';Object.keys(OWNERS).sort().forEach(n=>{const t=document.createElement("option");t.value=n;t.textContent=n;e.appendChild(t)})}

function buildMonthDropdown(){const e=document.getElementById("monthSelect");const n=["January","February","March","April","May","June","July","August","September","October","November","December"];n.forEach((t,a)=>{const s=document.createElement("option");s.value=a+1;s.textContent=t;e.appendChild(s)});e.value=new Date().getMonth()+1}

function buildYearDropdown(){const e=document.getElementById("yearSelect");const n=new Date().getFullYear();for(let t=n-2;t<=n+2;t++){const a=document.createElement("option");a.value=t;a.textContent=t;e.appendChild(a)}e.value=n}

function onOwnerChange(){currentOwner=document.getElementById("ownerSelect").value;if(currentOwner)updatePropertySelect()}

function getMonthName(e){const n=["January","February","March","April","May","June","July","August","September","October","November","December"];return n[e-1]}

function getNextMonth(e,n){let t=e+1;let a=n;if(t>12){t=1;a++}return{month:t,year:a}}

function updateHeaderDates(){const e=parseInt(document.getElementById("monthSelect").value);const n=parseInt(document.getElementById("yearSelect").value);const t=getNextMonth(e,n);const a=new Date(n,e,0).getDate();document.getElementById("statementDate").innerHTML="Statement Date:<br><strong>"+getMonthName(t.month)+" 1st "+t.year+"</strong>";document.getElementById("periodDate").innerHTML="Period: "+getMonthName(e)+" 1st - "+a+"th "+n;document.getElementById("ownerTitle").textContent=currentOwner.toUpperCase()}

function openOwnerSettings(){const e=document.getElementById("ownerSettingsModal");const n=document.getElementById("ownerSettingsContent");let t="";Object.keys(OWNERS).sort().forEach(a=>{const s=OWNERS[a];const r=s.type==="draft";t+="<div style='background:#555;padding:12px;margin:8px 0;border-radius:3px;border-left:4px solid #28a745'><div style='font-weight:bold;color:#fff;margin-bottom:8px'>"+a+"</div><input type='email' value='"+(s.email||"")+"' onchange=\"updateOwnerLocal('"+a+"','email',this.value)\" class='popup-input' placeholder='Email' style='margin-bottom:8px'><select onchange=\"updateOwnerLocal('"+a+"','type',this.value)\" class='popup-input' style='margin-bottom:8px'><option value='draft' "+(r?"selected":"")+">Draft</option><option value='payout' "+(r?"":"selected")+">Payout</option></select><input type='number' step='0.01' value='"+(s.percent*100).toFixed(2)+"' onchange=\"updateOwnerLocal('"+a+"','percent',this.value/100)\" class='popup-input' placeholder='Commission %' style='margin-bottom:8px'><input type='number' step='0.01' value='"+s.salesFeePercent.toFixed(2)+"' onchange=\"updateOwnerLocal('"+a+"','salesFeePercent',parseFloat(this.value))\" class='popup-input' placeholder='Sales Fee %' style='margin-bottom:8px'><button class='btn btn-danger btn-small' onclick=\"deleteOwner('"+a+"')\" style='width:100%'>üóëÔ∏è Delete</button></div>"});n.innerHTML=t;e.style.display="block"}

function updateOwnerLocal(e,n,t){if(!ownerSettings[e]){ownerSettings[e]={}}ownerSettings[e][n]=t;OWNERS[e][n]=t}

function addNewOwner(){const e=document.getElementById("newOwnerName").value.trim();const n=document.getElementById("newOwnerEmail").value.trim();const t=parseFloat(document.getElementById("newOwnerPercent").value)||0.12;const a=parseFloat(document.getElementById("newOwnerSales").value)||5;const s=document.getElementById("newOwnerType").value;if(!e){alert("Enter owner name");return}OWNERS[e]={percent:t/100,type:s,salesFeePercent:a,email:n};ownerSettings[e]={percent:t/100,type:s,salesFeePercent:a,email:n};document.getElementById("newOwnerName").value="";document.getElementById("newOwnerEmail").value="";document.getElementById("newOwnerPercent").value="";document.getElementById("newOwnerSales").value="";openOwnerSettings();buildOwnerDropdown()}

function deleteOwner(e){if(confirm("Delete owner "+e+"?")){delete OWNERS[e];delete ownerSettings[e];openOwnerSettings();buildOwnerDropdown()}}

async function saveOwnerSettingsToGitHub(){const e=Object.assign({},gitHubData,{owners:ownerSettings});const n=await saveToGitHub(e);if(n){gitHubData=e;closeOwnerSettings();buildOwnerDropdown();alert("‚úì Saved!")}}

function closeOwnerSettings(){document.getElementById("ownerSettingsModal").style.display="none"}

function openPropertySettings(){const e=document.getElementById("propertySettingsModal");const n=document.getElementById("propertySettingsContent");let t="";Object.keys(OWNERS).sort().forEach(a=>{const s=propertySettings[a]||{name:a,municipalities:{}};t+="<div style='background:#555;padding:12px;margin:8px 0;border-radius:3px;border-left:4px solid #28a745'><div style='font-weight:bold;color:#fff;margin-bottom:10px'>"+a+"</div><div class='checkbox-group'>";municipalities.forEach(r=>{t+="<div class='checkbox-item'><input type='checkbox' id='mun_"+a+"_"+r+"' "+(s.municipalities&&s.municipalities[r]?"checked":"")+` onchange="updateMunicipalityLocal('`+a+`','`+r+`',this.checked)"><label for='mun_`+a+`_`+r+`'>`+r+"</label></div>"});t+="</div></div>"});n.innerHTML=t;e.style.display="block"}

function updateMunicipalityLocal(e,n,t){if(!propertySettings[e])propertySettings[e]={name:e,municipalities:{}};if(!propertySettings[e].municipalities)propertySettings[e].municipalities={};propertySettings[e].municipalities[n]=t}

async function savePropertySettingsToGitHub(){const e=Object.assign({},gitHubData,{properties:propertySettings});const n=await saveToGitHub(e);if(n){gitHubData=e;closePropertySettings();alert("‚úì Saved!")}}

function closePropertySettings(){document.getElementById("propertySettingsModal").style.display="none"}

async function addVendor(){const e=document.getElementById("vendorName").value.trim();const n=document.getElementById("vendorPhone").value.trim();if(!e){alert("Enter name");return}const t={id:Date.now(),name:e,phone:n};vendors.push(t);updateVendorList();document.getElementById("vendorName").value="";document.getElementById("vendorPhone").value="";const a=Object.assign({},gitHubData,{vendors:vendors});await saveToGitHub(a);alert("‚úì Vendor added!")}

function addVendorFromModal(){const e=document.getElementById("vendorNameNew").value.trim();const n=document.getElementById("vendorPhoneNew").value.trim();if(!e){alert("Enter name");return}const t={id:Date.now(),name:e,phone:n};vendors.push(t);updateVendorList();document.getElementById("vendorNameNew").value="";document.getElementById("vendorPhoneNew").value="";const a=Object.assign({},gitHubData,{vendors:vendors});saveToGitHub(a);showVendorModal()}

async function deleteVendor(e){vendors=vendors.filter(n=>n.id!==e);updateVendorList();const n=Object.assign({},gitHubData,{vendors:vendors});await saveToGitHub(n);showVendorModal()}

function updateVendorList(){const e=document.getElementById("newExpenseVendor");const n=document.getElementById("editExpenseVendor");e.innerHTML="<option value=''>-- Select Vendor --</option>";n.innerHTML="<option value=''>-- Select Vendor --</option>";vendors.forEach(t=>{const a=document.createElement("option");a.value=t.name;a.textContent=t.name;e.appendChild(a);const s=a.cloneNode(true);n.appendChild(s)})}

function showVendorModal(){const e=document.getElementById("vendorModal");const n=document.getElementById("vendorListModal");if(vendors.length===0){n.innerHTML="<p style='color:#aaa'>No vendors</p>"}else{let t="";vendors.forEach(a=>{t+="<div class='vendor-item'><div class='vendor-info'><div class='vendor-name'>"+a.name+"</div><div class='vendor-phone'>"+a.phone+"</div></div><button onclick='deleteVendor("+a.id+")' class='btn btn-danger btn-small'>Delete</button></div>"});n.innerHTML=t}e.style.display="block"}

function closeVendorModal(){document.getElementById("vendorModal").style.display="none"}

function updatePropertySelect(){const e=document.getElementById("newExpenseProperty");e.innerHTML="<option value=''>-- Select Property --</option>";properties.forEach(n=>{const t=document.createElement("option");t.value=n;t.textContent=n;e.appendChild(t)})}

function openAddExpenseModal(){if(!currentOwner){alert("Select owner first");return}if(properties.length===0){alert("Generate statement first");return}selectedFile=null;document.getElementById("newExpenseType").value="Maintenance";document.getElementById("newExpenseProperty").value="";document.getElementById("newExpenseVendor").value="";document.getElementById("newExpenseAmount").value="";document.getElementById("newExpenseNotes").value="";document.getElementById("newExpenseFile").value="";document.getElementById("fileNameDisplay").textContent="";document.getElementById("addExpenseModal").style.display="block"}

function closeAddExpenseModal(){document.getElementById("addExpenseModal").style.display="none";selectedFile=null}

document.addEventListener("change",function(e){if(e.target.id==="newExpenseFile"){selectedFile=e.target.files[0];const n=document.getElementById("fileNameDisplay");if(selectedFile){n.textContent="‚úì File: "+(selectedFile.type.includes("pdf")?"PDF":"Image");n.style.color="#28a745"}else{n.textContent=""}}});

async function submitNewExpense(){const e=document.getElementById("newExpenseType").value;const n=document.getElementById("newExpenseProperty").value;const t=document.getElementById("newExpenseVendor").value;const a=parseFloat(document.getElementById("newExpenseAmount").value);const s=document.getElementById("newExpenseNotes").value;if(!currentOwner||!n||!t||!a){alert("Fill all fields");return}const r={id:Date.now(),owner:currentOwner,type:e,property:n,vendor:t,amount:a,notes:s,invoice:null};if(selectedFile){const i=new FileReader();i.onload=async function(e){const d=await uploadInvoiceToDropbox(selectedFile);r.invoice={filename:selectedFile.name,dropboxLink:d};expenses.push(r);const c=Object.assign({},gitHubData,{expenses:expenses});await saveToGitHub(c);closeAddExpenseModal();if(csvData&&csvData.length>0){processData();displayStatement()}alert("‚úì Expense added with invoice!")};i.readAsArrayBuffer(selectedFile)}else{expenses.push(r);const a=Object.assign({},gitHubData,{expenses:expenses});await saveToGitHub(a);closeAddExpenseModal();if(csvData&&csvData.length>0){processData();displayStatement()}alert("‚úì Expense added!")}}

async function uploadInvoiceToDropbox(file){const token=localStorage.getItem("dropbox_token");if(!token){alert("Setup Dropbox first");return null}try{const reader=new FileReader();reader.onload=async function(e){const bytes=e.target.result;const resp=await fetch("https://content.dropboxapi.com/2/files/upload",{method:"POST",headers:{"Authorization":"Bearer "+token,"Dropbox-API-Arg":JSON.stringify({path:"/statements/invoices/"+Date.now()+"_"+file.name,mode:"add"}), "Content-Type":"application/octet-stream"},body:bytes});if(resp.ok){const share=await fetch("https://www.dropboxapi.com/2/sharing/create_shared_link_with_settings",{method:"POST",headers:{"Authorization":"Bearer "+token,"Content-Type":"application/json"},body:JSON.stringify({path:"/statements/invoices/"+Date.now()+"_"+file.name,settings:{requested_visibility:"public"}})});if(share.ok){const data=await share.json();return data.url.replace("?dl=0","?dl=1")}}return null};reader.readAsArrayBuffer(file)}catch(e){console.error(e);return null}}

function openInvoiceModal(e){const n=expenses.find(n=>n.id===e);if(!n||!n.invoice)return;const t=document.getElementById("invoiceContent");if(n.invoice.dropboxLink){t.innerHTML='<iframe src="'+n.invoice.dropboxLink+'" style="width:100%;height:100vh;border:none"></iframe>'}else{t.innerHTML="<p>Invoice not available</p>"}document.getElementById("invoiceModal").style.display="flex"}

function closeInvoiceModal(){document.getElementById("invoiceModal").style.display="none"}

function openEditExpense(e){const n=expenses.find(n=>n.id===e);if(!n)return;editingExpenseId=e;document.getElementById("editExpenseType").value=n.type;document.getElementById("editExpenseVendor").value=n.vendor;document.getElementById("editExpenseAmount").value=n.amount;document.getElementById("editExpenseNotes").value=n.notes;document.getElementById("editExpenseModal").style.display="block"}

async function saveEditedExpense(){if(editingExpenseId===null)return;const e=expenses.findIndex(n=>n.id===editingExpenseId);if(e===-1)return;expenses[e].type=document.getElementById("editExpenseType").value;expenses[e].vendor=document.getElementById("editExpenseVendor").value;expenses[e].amount=parseFloat(document.getElementById("editExpenseAmount").value);expenses[e].notes=document.getElementById("editExpenseNotes").value;const n=Object.assign({},gitHubData,{expenses:expenses});await saveToGitHub(n);closeEditExpense();if(csvData&&csvData.length>0){processData();displayStatement()}}

function closeEditExpense(){document.getElementById("editExpenseModal").style.display="none";editingExpenseId=null}

async function deleteExpense(e){if(confirm("Delete?")){expenses=expenses.filter(n=>n.id!==e);const n=Object.assign({},gitHubData,{expenses:expenses});await saveToGitHub(n);if(csvData&&csvData.length>0){processData();displayStatement()}}}

function money(e){return"$"+(Number(e)||0).toFixed(2)}

function num(e){return parseFloat((e||"0").toString().replace(/[$,]/g,""))||0}

async function generateStatement(){const e=document.getElementById("csvFile").files[0];if(!e){alert("Upload CSV");return}if(!currentOwner){alert("Select owner");return}updateHeaderDates();const n=new FileReader();n.onload=t=>{csvData=Papa.parse(t.target.result,{header:true,skipEmptyLines:true}).data;processData();displayStatement()};n.readAsText(e)}

function processData(){const e=parseInt(document.getElementById("monthSelect").value);const n=parseInt(document.getElementById("yearSelect").value);const t=OWNERS[currentOwner];const a=t.percent;const s=t.type;propertyTotals={};masterTotals={gross:0,acc:0,clean:0,pmc:0,expenses:0,draft:0,owner:0,websiteFee:0};taxByProperty={};properties=[];let r={};csvData.forEach(t=>{if(!t["CHECK-IN DATE"])return;let a=parseInt(t["CHECK-IN DATE"].split("-")[1]);let s=parseInt(t["CHECK-IN DATE"].split("-")[0]);if(a!==e||s!==n)return;let i=t["LISTING'S NICKNAME"]||"Unknown";if(!properties.includes(i))properties.push(i);if(!r[i])r[i]=[];r[i].push(t)});updatePropertySelect();Object.keys(r).forEach(e=>{let n=0,t=0,i=0,d=0,c=0,o=0;r[e].forEach(r=>{let f=num(r["TOTAL PAYOUT"]);let l=num(r["ACCOMMODATION FARE"])-num(r["MARKUP"]);let h=(r["STATUS"]||"").toLowerCase();let u=h.includes("cancelled")?0:num(r["CLEANING FARE"]);let b=l*a;let m=0;if(s==="draft"&&l>0){let g=r["CONFIRMATION CODE"]||"";let p=r["PLATFORM"]||"";if(!g.toUpperCase().startsWith("HA")&&(p.toLowerCase().includes("website")||p.toLowerCase().includes("manual"))){m=f*0.01}}n+=f;t+=l;i+=u;d+=b;c+=m;if(s==="payout"){let g=num(r["CITY TAX"])||0;let p=num(r["STATE TAX"])||0;let S=num(r["COUNTY TAX"])||0;let y=num(r["OCCUPANCY TAX"])||0;if(g>0||p>0||S>0||y>0){if(!taxByProperty[e])taxByProperty[e]=0;taxByProperty[e]+=f}}});let f=expenses.filter(n=>n.property===e&&n.owner===currentOwner).reduce((e,n)=>e+n.amount,0);let l=d+i+c+f;let h=t-d-f;propertyTotals[e]={gross:n,acc:t,clean:i,pmc:d,websiteFee:c,expenses:f,draft:l,owner:h,reservations:r[e]};masterTotals.gross+=n;masterTotals.acc+=t;masterTotals.clean+=i;masterTotals.pmc+=d;masterTotals.websiteFee+=c;masterTotals.expenses+=f;masterTotals.draft+=l;masterTotals.owner+=h})}

function displayStatement(){const e=OWNERS[currentOwner];const n=e.type;let t="<div class='action-buttons'><button class='copy-link-btn' onclick='generateAndShareLink()'>üîó Generate & Copy Link</button></div>";t+="<div class='summary-title'>FINANCIAL SUMMARY</div><div class='summary-grid'>";if(n==="draft"){t+="<div class='summary-card'><div class='summary-label'>Gross Payout</div><div class='summary-value'>"+money(masterTotals.gross)+"</div></div><div class='summary-card'><div class='summary-label'>Accommodation</div><div class='summary-value'>"+money(masterTotals.acc)+"</div></div><div class='summary-card'><div class='summary-label'>PMC</div><div class='summary-value'>"+money(masterTotals.pmc)+"</div></div><div class='summary-card'><div class='summary-label'>Cleaning Fee</div><div class='summary-value'>"+money(masterTotals.clean)+"</div></div><div class='summary-card'><div class='summary-label'>Website (1%)</div><div class='summary-value'>"+money(masterTotals.websiteFee)+"</div></div><div class='summary-card'><div class='summary-label'>Expenses</div><div class='summary-value'>"+money(masterTotals.expenses)+"</div></div><div class='summary-card' style='background:#000;color:#fff;border-color:#000'><div class='summary-label' style='color:#fff'>AMOUNT DUE</div><div class='summary-value' style='color:#fff'>"+money(masterTotals.draft)+"</div></div>"}else{t+="<div class='summary-card'><div class='summary-label'>Accommodation</div><div class='summary-value'>"+money(masterTotals.acc)+"</div></div><div class='summary-card'><div class='summary-label'>PMC</div><div class='summary-value'>"+money(masterTotals.pmc)+"</div></div><div class='summary-card'><div class='summary-label'>Expenses</div><div class='summary-value'>"+money(masterTotals.expenses)+"</div></div><div class='summary-card' style='background:#000;color:#fff;border-color:#000'><div class='summary-label' style='color:#fff'>OWNER PAYOUT</div><div class='summary-value' style='color:#fff'>"+money(masterTotals.owner)+"</div></div>"}t+="</div>";Object.keys(propertyTotals).forEach(a=>{let s=propertyTotals[a];let r=n==="draft"?s.draft:s.owner;let i=expenses.filter(e=>e.property===a&&e.owner===currentOwner);t+="<div class='property-section'><div class='property-title'><span class='property-icon'>üè†</span>"+a.toUpperCase()+"</div><div class='summary-grid'>";if(n==="draft"){t+="<div class='summary-card'><div class='summary-label'>Gross Payout</div><div class='summary-value'>"+money(s.gross)+"</div></div><div class='summary-card'><div class='summary-label'>Accommodation</div><div class='summary-value'>"+money(s.acc)+"</div></div><div class='summary-card'><div class='summary-label'>PMC</div><div class='summary-value'>"+money(s.pmc)+"</div></div><div class='summary-card'><div class='summary-label'>Cleaning Fee</div><div class='summary-value'>"+money(s.clean)+"</div></div><div class='summary-card'><div class='summary-label'>Website (1%)</div><div class='summary-value'>"+money(s.websiteFee)+"</div></div><div class='summary-card'><div class='summary-label'>Expenses</div><div class='summary-value'>"+money(s.expenses)+"</div></div><div class='summary-card' style='background:#000;color:#fff;border-color:#000'><div class='summary-label' style='color:#fff'>AMOUNT DUE</div><div class='summary-value' style='color:#fff'>"+money(r)+"</div></div>"}else{t+="<div class='summary-card'><div class='summary-label'>Accommodation</div><div class='summary-value'>"+money(s.acc)+"</div></div><div class='summary-card'><div class='summary-label'>PMC</div><div class='summary-value'>"+money(s.pmc)+"</div></div><div class='summary-card'><div class='summary-label'>Expenses</div><div class='summary-value'>"+money(s.expenses)+"</div></div><div class='summary-card' style='background:#000;color:#fff;border-color:#000'><div class='summary-label' style='color:#fff'>OWNER PAYOUT</div><div class='summary-value' style='color:#fff'>"+money(r)+"</div></div>"}t+="</div><div style='margin-top:15px'><div class='section-title'>RESERVATIONS</div><table style='margin-top:10px'>";if(n==="draft"){t+="<tr><th>Code</th><th>Stay</th><th>Platform</th><th>Accommodation</th><th>PMC</th><th>Cleaning</th><th>Website</th><th>Amount Due</th></tr>";s.reservations.forEach(a=>{let r=num(a["ACCOMMODATION FARE"])-num(a["MARKUP"]);let i=num(a["TOTAL PAYOUT"]);let d=(a["STATUS"]||"").toLowerCase();let c=d.includes("cancelled")?0:num(a["CLEANING FARE"]);let o=e.percent;let f=r*o;let l=a["CONFIRMATION CODE"]||"";let h=a["PLATFORM"]||"N/A";let u=l.toUpperCase().startsWith("HA");let b=r>0&&!u&&(h.toLowerCase().includes("website")||h.toLowerCase().includes("manual"))?i*0.01:0;let m=a["CHECK-IN DATE"]?a["CHECK-IN DATE"].split("-").slice(1).join("/"):"";let g=a["CHECK-OUT DATE"]?a["CHECK-OUT DATE"].split("-").slice(1).join("/"):"";if(i===0)return;t+="<tr><td>"+l.substring(0,8)+"</td><td>"+m+"-"+g+"</td><td>"+h+"</td><td>"+money(r)+"</td><td>"+money(f)+"</td><td>"+money(c)+"</td><td>"+money(b)+"</td><td>"+money(f+c+b)+"</td></tr>"})}else{t+="<tr><th>Code</th><th>Stay</th><th>Platform</th><th>Accommodation</th><th>PMC</th><th>Owner Payout</th></tr>";s.reservations.forEach(a=>{let r=num(a["ACCOMMODATION FARE"])-num(a["MARKUP"]);let i=num(a["TOTAL PAYOUT"]);let d=e.percent;let c=r*d;let o=a["CONFIRMATION CODE"]||"";let f=a["PLATFORM"]||"N/A";let l=a["CHECK-IN DATE"]?a["CHECK-IN DATE"].split("-").slice(1).join("/"):"";let h=a["CHECK-OUT DATE"]?a["CHECK-OUT DATE"].split("-").slice(1).join("/"):"";if(i===0)return;t+="<tr><td>"+o.substring(0,8)+"</td><td>"+l+"-"+h+"</td><td>"+f+"</td><td>"+money(r)+"</td><td>"+money(c)+"</td><td>"+money(r-c)+"</td></tr>"})}t+="</table></div>";if(i.length>0){t+="<div style='margin-top:15px'><div class='section-title'>EXPENSES</div>";i.forEach(e=>{let n="";if(e.invoice){n=" <button class='invoice-btn' onclick='openInvoiceModal("+e.id+")'>üìÑ INVOICE</button>"}t+="<div class='attachment'><div class='attachment-left'><strong>"+e.type+"</strong> - "+e.vendor+": "+money(e.amount);if(e.notes)t+="<br><span style='color:#666'>Notes: "+e.notes+"</span>";t+="</div><div class='attachment-actions'>"+n+"<button onclick='openEditExpense("+e.id+")' class='btn btn-info btn-small'>‚úèÔ∏è Edit</button><button onclick='deleteExpense("+e.id+")' class='btn btn-danger btn-small'>Delete</button></div></div>"});t+="</div>"}t+="</div>"});document.getElementById("mainContent").innerHTML=t}

async function generateAndShareLink(){const month=parseInt(document.getElementById("monthSelect").value);const year=parseInt(document.getElementById("yearSelect").value);const token=localStorage.getItem("dropbox_token");if(!token){alert("‚ùå Dropbox token not found!\n\nClick üìÅ Dropbox Setup and paste your access token");return}const filename=currentOwner+"_"+month+"_"+year+"_"+Date.now()+".html";const html=document.getElementById("content").innerHTML;const fullHtml="<html><head><title>Statement - "+currentOwner+"</title><style>"+document.querySelector("style").innerHTML+"</style></head><body>"+html+"</body></html>";try{const resp=await fetch("https://content.dropboxapi.com/2/files/upload",{method:"POST",headers:{"Authorization":"Bearer "+token,"Dropbox-API-Arg":JSON.stringify({path:"/statements/"+filename,mode:"add",autorename:true}),"Content-Type":"text/plain"},body:fullHtml});if(resp.ok){const share=await fetch("https://www.dropboxapi.com/2/sharing/create_shared_link_with_settings",{method:"POST",headers:{"Authorization":"Bearer "+token,"Content-Type":"application/json"},body:JSON.stringify({path:"/statements/"+filename,settings:{requested_visibility:"public"}})});if(share.ok){const data=await share.json();const link=data.url.replace("?dl=0","?dl=1");showLinkGenerated(link);return}else{const err=await share.text();alert("‚ùå Error creating link:\n"+err)}}else{const err=await resp.text();alert("‚ùå Upload failed:\n"+err)}}catch(e){alert("‚ùå Error:\n"+e.message)}}

function showLinkGenerated(link){const msg="<div style='background:#d4edda;border:2px solid #28a745;padding:15px;margin:20px 0;border-radius:5px;text-align:center'><h3 style='color:#155724'>‚úì Statement Generated!</h3><p style='color:#155724;margin:10px 0'>Copy link and paste in Gmail:</p><button class='copy-link-btn' onclick=\"copyToClipboard('"+link+"')\">üìã Copy Link to Clipboard</button><p style='font-size:12px;color:#155724;margin-top:10px;word-break:break-all'><code style='background:#fff;padding:5px;border-radius:3px'>"+link+"</code></p></div>";document.getElementById("mainContent").innerHTML+=msg}

function copyToClipboard(text){navigator.clipboard.writeText(text).then(()=>{alert("‚úì Link copied!")}).catch(()=>{alert("Failed to copy")})}

async function generateSummary(){if(!csvData||csvData.length===0){alert("Generate statement first");return}updateHeaderDates();const e=OWNERS[currentOwner];const n=e.type;const t=e.salesFeePercent;const a=masterTotals.pmc*(t/100);let s="<div class='action-buttons'><button class='back-btn' onclick='generateStatement()'>‚Üê Back</button><button class='print-btn' onclick='window.print()'>üñ®Ô∏è Print</button></div><div class='summary-title'>SUMMARY & CALCULATIONS</div>";s+="<div class='commission-box'><div class='commission-box-title'>Sales Commission Due</div><div class='calc-row'><span>Total Accommodation</span><span>"+money(masterTotals.acc)+"</span></div><div class='calc-row'><span>PMC % Rate</span><span>"+(e.percent*100).toFixed(2)+"%</span></div><div class='calc-row' style='background:#fff;font-weight:bold'><span>Total PMC</span><span>"+money(masterTotals.pmc)+"</span></div><div class='calc-row'><span>Sales Fee %</span><span>"+t+"%</span></div><div class='calc-row-total'><span>Commission Amount</span><span>"+money(a)+"</span></div></div>";if(n==="draft"){s+="<div class='commission-box'><div class='commission-box-title'>Draft Owner Breakdown</div><div class='calc-row'><span>Cleaning Fees</span><span>"+money(masterTotals.clean)+"</span></div><div class='calc-row'><span>Website Fee (1%)</span><span>"+money(masterTotals.websiteFee)+"</span></div><div class='calc-row'><span>Expenses</span><span>"+money(masterTotals.expenses)+"</span></div><div class='calc-row-total'><span>Total Amount Due</span><span>"+money(masterTotals.draft)+"</span></div></div>"}else{s+="<div class='commission-box'><div class='commission-box-title'>Payout Owner Breakdown</div><div class='calc-row'><span>Accommodation</span><span>"+money(masterTotals.acc)+"</span></div><div class='calc-row'><span>PMC (Deduction)</span><span>-"+money(masterTotals.pmc)+"</span></div><div class='calc-row'><span>Expenses</span><span>-"+money(masterTotals.expenses)+"</span></div><div class='calc-row-total'><span>Owner Net Payout</span><span>"+money(masterTotals.owner)+"</span></div></div>";if(Object.keys(propertyTotals).some(e=>propertySettings[e]&&propertySettings[e].municipalities&&Object.values(propertySettings[e].municipalities).some(e=>e))){s+="<div class='tax-info'><div class='tax-info-title'>‚ö†Ô∏è Tax Payment Required By Municipality</div><table class='tax-table'><tr><th>PROPERTY</th><th>ACCOMMODATION</th><th>MUNICIPALITIES</th><th>AMOUNT TO REPORT</th></tr>";Object.keys(propertyTotals).forEach(e=>{const n=propertyTotals[e];const t=propertySettings[e];if(!t||!t.municipalities||!Object.values(t.municipalities).some(e=>e))return;const a=Object.keys(t.municipalities||{}).filter(e=>t.municipalities[e]).join(", ");s+="<tr><td>"+e+"</td><td>"+money(n.acc)+"</td><td>"+a+"</td><td class='tax-amount'>"+money(taxByProperty[e]||0)+"</td></tr>"});s+="</table></div>"}}s+="<div class='pmc-transfer-box'><div class='pmc-transfer-title'>üí≥ PMC Bank Transfer</div><div class='pmc-transfer-amount'>"+money(masterTotals.pmc)+"</div><p style='text-align:center;margin-top:10px;font-size:11px'>Transfer amount to PMC bank</p></div>";document.getElementById("mainContent").innerHTML=s}

async function generateAnnual(){const e=OWNERS[currentOwner];if(e.type!=="payout"){alert("Payout owners only");return}updateHeaderDates();let n="<div class='action-buttons'><button class='back-btn' onclick='generateStatement()'>‚Üê Back</button></div><div class='summary-title'>ANNUAL SUMMARY</div><div style='background:#f9f9f9;padding:20px;border-radius:5px'><table><tr><td style='font-weight:bold'>Total Accommodation</td><td style='text-align:right'>"+money(masterTotals.acc)+"</td></tr><tr><td style='font-weight:bold'>PMC Charged</td><td style='text-align:right'>"+money(masterTotals.pmc)+"</td></tr><tr><td style='font-weight:bold'>Total Expenses</td><td style='text-align:right'>"+money(masterTotals.expenses)+"</td></tr><tr style='background:#000;color:#fff'><td style='font-weight:bold;color:#fff'>NET ANNUAL</td><td style='text-align:right;color:#fff'>"+money(masterTotals.
