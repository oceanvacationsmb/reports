<!DOCTYPE html>
<html>
<head>
<title>Reservation Report</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial;background:#f5f5f5;color:#000;display:flex}
.sidebar{width:250px;background:#333;color:#fff;padding:20px;height:100vh;overflow-y:auto;position:fixed;left:0;top:0}
.sidebar h3{margin-bottom:20px;font-size:16px;border-bottom:2px solid #fff;padding-bottom:10px}
.sidebar-section{margin-bottom:20px}
.sidebar-label{font-size:12px;font-weight:bold;color:#aaa;margin-bottom:5px;display:block}
.sidebar-control{margin-bottom:12px}
.sidebar-control select,.sidebar-control input{width:100%;padding:8px;border:1px solid #555;background:#444;color:#fff;border-radius:3px;font-size:12px}
.sidebar-control button{width:100%;padding:10px;margin-top:5px;font-weight:bold;border:none;cursor:pointer;border-radius:3px;font-size:13px}
.run-btn{background:#000;color:#fff}
.run-btn:hover{background:#222}
.summary-btn{background:#28a745;color:#fff;margin-top:10px}
.summary-btn:hover{background:#218838}
.pdf-btn{background:#444;color:#fff;margin-top:10px}
.pdf-btn:hover{background:#555}
.print-btn{background:#ff6b6b;color:#fff;margin-top:5px;font-size:11px}
.print-btn:hover{background:#ee5a52}
.history-btn{background:#9b59b6;color:#fff;margin-top:5px;font-size:11px}
.history-btn:hover{background:#8e44ad}
.save-btn{background:#007bff;color:#fff;margin-top:5px;font-size:12px}
.save-btn:hover{background:#0056b3}
.delete-btn{background:#dc3545;color:#fff;font-size:11px;padding:5px 8px;border:none;cursor:pointer;border-radius:2px;margin-left:5px}
.delete-btn:hover{background:#c82333}
.add-btn{background:#28a745;color:#fff;font-size:11px;padding:5px 8px;border:none;cursor:pointer;border-radius:2px;margin-top:5px;width:100%}
.add-btn:hover{background:#218838}
.settings-toggle{background:#666;color:#fff;padding:10px;border:none;cursor:pointer;width:100%;text-align:left;font-weight:bold;border-radius:3px;margin-bottom:10px;font-size:14px}
.settings-toggle:hover{background:#777}
.settings-box{display:none;background:#444;padding:15px;border-radius:3px;margin-top:10px;max-height:600px;overflow-y:auto}
.settings-box.open{display:block}
.expense-box{display:none;background:#444;padding:15px;border-radius:3px;margin-top:10px;max-height:600px;overflow-y:auto}
.expense-box.open{display:block}
.vendor-box{display:none;background:#444;padding:15px;border-radius:3px;margin-top:10px;max-height:600px;overflow-y:auto}
.vendor-box.open{display:block}
.owner-item{background:#555;padding:12px;margin-bottom:10px;border-radius:3px;font-size:11px;border:1px solid #666}
.owner-item-name{font-weight:bold;color:#fff;margin-bottom:8px;font-size:12px}
.owner-item-control{margin-bottom:8px}
.owner-item-label{font-size:10px;color:#bbb;display:block;margin-bottom:3px}
.owner-item-control input,.owner-item-control select{width:100%;padding:5px;background:#666;color:#fff;border:1px solid #777;border-radius:2px;font-size:10px}
.owner-item-control input:focus,.owner-item-control select:focus{outline:none;border-color:#fff}
.checkbox-group{display:flex;flex-wrap:wrap;gap:8px;margin-top:5px}
.checkbox-item{display:flex;align-items:center;gap:4px}
.checkbox-item input[type="checkbox"]{width:14px;height:14px;cursor:pointer}
.checkbox-item label{color:#fff;font-size:10px;cursor:pointer}
.vendor-item{background:#555;padding:10px;margin-bottom:8px;border-radius:3px;font-size:10px;display:flex;justify-content:space-between;align-items:center}
.vendor-name{font-weight:bold;color:#fff}
.expense-item{background:#555;padding:10px;margin-bottom:8px;border-radius:3px;font-size:10px}
.main-content{margin-left:250px;padding:15px;width:calc(100% - 250px)}
.page-break{page-break-after:always}
.header{display:flex;justify-content:space-between;margin-bottom:12px}
.company{font-size:18px;font-weight:900}
.company-info{font-size:9px;line-height:1.4}
.title{text-align:center;font-size:18px;font-weight:900;margin-top:6px}
.owner{text-align:center;font-size:14px;font-weight:bold;margin-top:3px;margin-bottom:4px}
.period{text-align:center;font-size:10px;margin-bottom:6px}
.section-title{font-size:14px;font-weight:bold;margin-top:6px;margin-bottom:6px}
.summary-box{border:2px solid #000;padding:10px;margin:8px 0;background:#fafafa;border-radius:5px}
.summary-box-master{border:2px solid #000;padding:6px;margin:6px 0;background:#fafafa;border-radius:5px}
.summary-header{font-weight:bold;font-size:11px;margin-bottom:8px;color:#333;text-align:center}
.summary-header-master{font-weight:bold;font-size:10px;margin-bottom:6px;color:#333;text-align:center}
.summary{display:flex;justify-content:space-around;font-size:9px;gap:6px;flex-wrap:wrap}
.summary-master{display:flex;justify-content:space-around;font-size:8px;gap:4px;flex-wrap:wrap}
.summary-item{text-align:center;flex:1;min-width:100px}
.summary-item-master{text-align:center;flex:1;min-width:80px}
.summary-item-label{display:block;font-size:8px;font-weight:bold;color:#333;margin-bottom:3px}
.summary-item-label-master{display:block;font-size:7px;font-weight:bold;color:#333;margin-bottom:2px}
.summary-item-amount{display:block;font-size:11px;font-weight:bold;color:#000}
.summary-item-amount-master{display:block;font-size:9px;font-weight:bold;color:#000}
.property{margin-top:12px;background:#fff;padding:10px;border-radius:5px;border:1px solid #ddd}
.property-title{font-size:12px;font-weight:bold;margin-bottom:2px}
.property-period{font-size:9px;color:#666;margin-bottom:6px}
.property-notes{font-size:9px;color:#333;margin-bottom:6px;padding:8px;background:#fafafa;border-left:3px solid #007bff}
table{width:100%;border-collapse:collapse;font-size:7px;margin-top:6px;background:#fff}
th,td{border:1px solid #ddd;padding:2px;text-align:center;word-wrap:break-word;overflow-wrap:break-word}
th{background:#333;color:#fff;font-weight:bold}
tr:nth-child(even){background:#f9f9f9}
.hidden{display:none}
.summary-page{background:#fff;padding:20px;border-radius:5px}
.summary-page-header{font-size:24px;font-weight:bold;text-align:center;margin-bottom:10px}
.summary-page-period{font-size:11px;text-align:center;margin-bottom:20px;color:#666}
.summary-section{background:#f9f9f9;border:2px solid #000;padding:15px;margin:15px 0;border-radius:5px}
.summary-section-title{font-size:14px;font-weight:bold;margin-bottom:10px;color:#333}
.summary-line{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #ddd;font-size:12px}
.summary-line-value{font-weight:bold;color:#000}
.tax-table{width:100%;border-collapse:collapse;font-size:11px;margin-top:10px}
.tax-table th,.tax-table td{border:1px solid #000;padding:6px;text-align:left}
.tax-table th{background:#333;color:#fff;font-weight:bold}
.tax-table tr:nth-child(even){background:#f9f9f9}
.tax-table .tax-amount{text-align:right;font-weight:bold}
.back-btn{background:#666;color:#fff;padding:10px 20px;border:none;cursor:pointer;border-radius:3px;font-weight:bold;margin-bottom:20px}
.back-btn:hover{background:#555}
.save-success{background:#d4edda;color:#155724;padding:10px;border-radius:3px;margin-bottom:10px;display:none}
.warning-section{background:#fff3cd;border:2px solid #ffc104;padding:15px;margin:15px 0;border-radius:5px}
.warning-title{font-size:14px;font-weight:bold;color:#856404;margin-bottom:10px}
.history-list{background:#fff;border:1px solid #ddd;border-radius:5px;max-height:300px;overflow-y:auto;margin-top:10px}
.history-item{padding:10px;border-bottom:1px solid #eee;cursor:pointer;font-size:11px;display:flex;justify-content:space-between;align-items:center}
.history-item:hover{background:#f9f9f9}
.history-item-date{font-weight:bold;color:#333}
.history-item-details{font-size:10px;color:#666}
.file-input-label{background:#666;color:#fff;padding:5px 8px;border-radius:2px;cursor:pointer;font-size:10px;display:inline-block}
.file-input-label:hover{background:#777}
.file-name{color:#fff;font-size:10px;margin-top:3px}
@media print{
.sidebar,.finish-btn,.add-row button,.back-btn,.save-btn,.print-btn,.delete-btn{display:none}
.main-content{margin-left:0;width:100%;padding:10px}
}
</style>
</head>

<body>

<div class="sidebar">
<h3>üéØ REPORT CONTROLS</h3>

<div class="sidebar-section">
<label class="sidebar-label">Select Owner</label>
<div class="sidebar-control">
<select id="owner" onchange="updateSettingsDisplay()"></select>
</div>
</div>

<div class="sidebar-section">
<label class="sidebar-label">Select Month</label>
<div class="sidebar-control">
<select id="month"></select>
</div>
</div>

<div class="sidebar-section">
<label class="sidebar-label">Select Year</label>
<div class="sidebar-control">
<select id="year"></select>
</div>
</div>

<div class="sidebar-section">
<label class="sidebar-label">Upload CSV File</label>
<div class="sidebar-control">
<input type="file" id="fileInput" accept=".csv">
</div>
</div>

<button class="run-btn" onclick="runReport()">‚ñ∂ Run Owner Statement</button>
<button class="summary-btn" onclick="runSummary()">üìä View Summary</button>
<button class="pdf-btn" onclick="downloadPDF()">üì• Download PDF</button>
<button class="print-btn" onclick="printSummary()">üñ®Ô∏è Print Summary</button>
<button class="history-btn" onclick="viewHistory()">üìã View History</button>

<button class="settings-toggle" onclick="toggleSettings()">‚öôÔ∏è Owner Settings</button>
<div class="settings-box" id="settingsBox">
<div class="save-success" id="saveSuccess">‚úì Settings saved!</div>
<h4 style="color:#fff;margin-bottom:10px" id="settingsTitle">Owner Settings</h4>
<div id="ownersList"></div>
<button class="save-btn" onclick="saveSettings()">üíæ Save Settings</button>
</div>

<button class="settings-toggle" onclick="toggleExpense()">üí∞ Expenses & Credits</button>
<div class="expense-box" id="expenseBox">
<div class="save-success" id="expenseSaveSuccess">‚úì Expense saved!</div>
<h4 style="color:#fff;margin-bottom:10px">Add Expense/Credit</h4>
<div class="owner-item-control">
<label class="owner-item-label">Type</label>
<select id="expenseType">
<option value="Maintenance">Maintenance</option>
<option value="Repair">Repair</option>
<option value="Purchase">Purchase</option>
<option value="Supplies">Supplies</option>
<option value="Service">Service</option>
<option value="Pool Cleaning">Pool Cleaning</option>
<option value="Pest Control">Pest Control</option>
<option value="Credit">Credit</option>
<option value="Adjustment">Adjustment</option>
</select>
</div>
<div class="owner-item-control">
<label class="owner-item-label">Property</label>
<select id="expenseProperty"></select>
</div>
<div class="owner-item-control">
<label class="owner-item-label">Vendor</label>
<select id="expenseVendor"></select>
</div>
<div class="owner-item-control">
<label class="owner-item-label">Amount ($)</label>
<input type="number" id="expenseAmount" step="0.01" min="0" placeholder="0.00">
</div>
<div class="owner-item-control">
<label class="owner-item-label">Notes</label>
<input type="text" id="expenseNotes" placeholder="Optional notes">
</div>
<div class="owner-item-control">
<label class="owner-item-label">Attach PDF (Optional)</label>
<label class="file-input-label">
üìé Choose File
<input type="file" id="expensePDF" accept=".pdf" style="display:none" onchange="showFileName()">
</label>
<div class="file-name" id="fileName"></div>
</div>
<button class="add-btn" onclick="addExpense()">‚ûï Add Expense/Credit</button>
<h4 style="color:#fff;margin-top:15px;margin-bottom:10px">Recent Expenses</h4>
<div id="expensesList"></div>
</div>

<button class="settings-toggle" onclick="toggleVendors()">üè¢ Vendors</button>
<div class="vendor-box" id="vendorBox">
<div class="save-success" id="vendorSaveSuccess">‚úì Vendor saved!</div>
<h4 style="color:#fff;margin-bottom:10px">Add/Edit Vendors</h4>
<div class="owner-item-control">
<label class="owner-item-label">Vendor Name</label>
<input type="text" id="vendorName" placeholder="Enter vendor name">
</div>
<div class="owner-item-control">
<label class="owner-item-label">Contact</label>
<input type="text" id="vendorContact" placeholder="Phone or email">
</div>
<button class="add-btn" onclick="addVendor()">‚ûï Add Vendor</button>
<h4 style="color:#fff;margin-top:15px;margin-bottom:10px">Vendor List</h4>
<div id="vendorsList"></div>
</div>

</div>

<div class="main-content">
<div id="report"></div>
<div id="summaryPage" class="summary-page hidden"></div>
<div id="historyPage" class="summary-page hidden"></div>
</div>

<script>

// Initialize IndexedDB
let db;
const dbName="OceanVacationsDB";
const dbVersion=1;

function initDB(){
return new Promise((resolve,reject)=>{
const request=indexedDB.open(dbName,dbVersion);

request.onerror=()=>reject("DB failed to open");
request.onsuccess=()=>{
db=request.result;
resolve();
};

request.onupgradeneeded=(e)=>{
db=e.target.result;
if(!db.objectStoreNames.contains("owners")){
db.createObjectStore("owners",{keyPath:"name"});
}
if(!db.objectStoreNames.contains("vendors")){
db.createObjectStore("vendors",{keyPath:"id"});
}
if(!db.objectStoreNames.contains("expenses")){
db.createObjectStore("expenses",{keyPath:"id"});
}
if(!db.objectStoreNames.contains("statements")){
db.createObjectStore("statements",{keyPath:"id"});
}
};
});
}

async function loadFromDB(){
const owners_data=await getFromDB("owners");
const vendors_data=await getFromDB("vendors");
const expenses_data=await getFromDB("expenses");
const statements_data=await getFromDB("statements");

owners=owners_data.length>0?Object.fromEntries(owners_data.map(o=>[o.name,o.data])):owners;
vendors=vendors_data.map(v=>v.data||v);
expenses=expenses_data.map(e=>e.data||e);
statementHistory=statements_data.map(s=>s.data||s);

updateVendorSelects();
updateExpensesList();
updateVendorsList();
}

function getFromDB(store){
return new Promise((resolve)=>{
const transaction=db.transaction([store],"readonly");
const objectStore=transaction.objectStore(store);
const request=objectStore.getAll();
request.onsuccess=()=>resolve(request.result);
});
}

function saveToDBStore(store,key,data){
return new Promise((resolve)=>{
const transaction=db.transaction([store],"readwrite");
const objectStore=transaction.objectStore(store);
objectStore.put({...data,id:key||data.id||Date.now()});
transaction.oncomplete=()=>resolve();
});
}

function deleteFromDB(store,key){
return new Promise((resolve)=>{
const transaction=db.transaction([store],"readwrite");
const objectStore=transaction.objectStore(store);
objectStore.delete(key);
transaction.oncomplete=()=>resolve();
});
}

let owners={
"ERAN":{percent:0.12,type:"draft",salesFeePercent:5,municipalities:{}},
"GHO":{percent:0.10,type:"payout",salesFeePercent:5,municipalities:{SC:false,MB:false,NMB:false,SSB:false,HC:false}},
"1463 Basin Trail":{percent:0.12,type:"payout",salesFeePercent:5,municipalities:{SC:false,MB:false,NMB:false,SSB:false,HC:false}},
"113B-15S Surfside Beach":{percent:0.12,type:"payout",salesFeePercent:5,municipalities:{SC:false,MB:false,NMB:false,SSB:false,HC:false}},
"113B-13N Surfside Beach":{percent:0.12,type:"payout",salesFeePercent:5,municipalities:{SC:false,MB:false,NMB:false,SSB:false,HC:false}},
"115C-15N Surfside Beach":{percent:0.12,type:"payout",salesFeePercent:5,municipalities:{SC:false,MB:false,NMB:false,SSB:false,HC:false}},
"2131 Sanibel Myrtle Beach":{percent:0.15,type:"payout",salesFeePercent:5,municipalities:{SC:false,MB:false,NMB:false,SSB:false,HC:false}},
"1552 Elizabeth Ln Myrtle Beach":{percent:0.15,type:"payout",salesFeePercent:5,municipalities:{SC:false,MB:false,NMB:false,SSB:false,HC:false}},
"469C White River RD Myrtle Beach":{percent:0.12,type:"payout",salesFeePercent:5,municipalities:{SC:false,MB:false,NMB:false,SSB:false,HC:false}},
"4631-301 Wild Iris Drive Myrtle Beach":{percent:0.12,type:"payout",salesFeePercent:5,municipalities:{SC:false,MB:false,NMB:false,SSB:false,HC:false}},
"4679-204 Wild Iris Drive Myrtle Beach":{percent:0.12,type:"payout",salesFeePercent:5,municipalities:{SC:false,MB:false,NMB:false,SSB:false,HC:false}},
"508-1/2 33rd Ave North Myrtle Beach":{percent:0.15,type:"payout",salesFeePercent:10,municipalities:{SC:false,MB:false,NMB:false,SSB:false,HC:false}},
"214-2S 2nd Ave S. North Myrtle Beach":{percent:0.12,type:"payout",salesFeePercent:10,municipalities:{SC:false,MB:false,NMB:false,SSB:false,HC:false}}
};

let vendors=[];
let expenses=[];
let statementHistory=[];
let lastSummaryHTML="";
let csvData=[];
let properties=[];

function saveSettings(){
Object.entries(owners).forEach(([name,data])=>{
saveToDBStore("owners",name,{name,data});
});
const btn=document.getElementById("saveSuccess");
btn.style.display="block";
setTimeout(()=>{btn.style.display="none"},3000);
}

function saveVendors(){
vendors.forEach(v=>{
saveToDBStore("vendors",v.id,v);
});
const btn=document.getElementById("vendorSaveSuccess");
btn.style.display="block";
setTimeout(()=>{btn.style.display="none"},3000);
updateVendorSelects();
}

function saveExpenses(){
expenses.forEach(e=>{
saveToDBStore("expenses",e.id,e);
});
const btn=document.getElementById("expenseSaveSuccess");
btn.style.display="block";
setTimeout(()=>{btn.style.display="none"},3000);
}

function saveStatementHistory(){
statementHistory.forEach(s=>{
saveToDBStore("statements",s.id,s);
});
}

function showFileName(){
const file=document.getElementById("expensePDF").files[0];
if(file){
document.getElementById("fileName").textContent=`‚úì ${file.name}`;
}
}

function addVendor(){
const name=document.getElementById("vendorName").value.trim();
const contact=document.getElementById("vendorContact").value.trim();

if(!name){alert("Please enter vendor name");return;}

vendors.push({id:Date.now(),name:name,contact:contact});
saveVendors();

document.getElementById("vendorName").value="";
document.getElementById("vendorContact").value="";
}

function deleteVendor(id){
if(confirm("Delete this vendor?")){
vendors=vendors.filter(v=>v.id!==id);
deleteFromDB("vendors",id);
updateVendorsList();
updateVendorSelects();
}
}

function updateVendorSelects(){
const select=document.getElementById("expenseVendor");
select.innerHTML='<option value="">-- Select Vendor --</option>';
vendors.forEach(v=>select.innerHTML+=`<option value="${v.name}">${v.name}</option>`);
}

function updateVendorsList(){
const list=document.getElementById("vendorsList");
if(vendors.length===0){
list.innerHTML='<div style="color:#aaa;font-size:10px">No vendors yet</div>';
return;
}
list.innerHTML=vendors.map(v=>`
<div class="vendor-item">
<div>
<div class="vendor-name">${v.name}</div>
<div style="color:#aaa;font-size:9px">${v.contact||'No contact'}</div>
</div>
<button class="delete-btn" onclick="deleteVendor(${v.id})">üóë</button>
</div>
`).join("");
}

function updatePropertySelects(){
const select=document.getElementById("expenseProperty");
select.innerHTML='<option value="">-- Select Property --</option>';
properties.forEach(p=>select.innerHTML+=`<option value="${p}">${p}</option>`);
}

function addExpense(){
const type=document.getElementById("expenseType").value;
const property=document.getElementById("expenseProperty").value;
const vendor=document.getElementById("expenseVendor").value;
const amount=parseFloat(document.getElementById("expenseAmount").value);
const notes=document.getElementById("expenseNotes").value;
const owner=document.getElementById("owner").value;
const fileInput=document.getElementById("expensePDF");

if(!property||!vendor||!amount){alert("Please fill in all required fields");return;}

const expense={
id:Date.now(),
owner:owner,
type:type,
property:property,
vendor:vendor,
amount:amount,
notes:notes,
pdf:null
};

// Read PDF file if provided
if(fileInput.files.length>0){
const file=fileInput.files[0];
const reader=new FileReader();
reader.onload=(e)=>{
expense.pdf={
name:file.name,
data:e.target.result
};
expenses.push(expense);
saveExpenses();
resetExpenseForm();
};
reader.readAsArrayBuffer(file);
}else{
expenses.push(expense);
saveExpenses();
resetExpenseForm();
}
}

function resetExpenseForm(){
document.getElementById("expenseType").value="Maintenance";
document.getElementById("expenseProperty").value="";
document.getElementById("expenseVendor").value="";
document.getElementById("expenseAmount").value="";
document.getElementById("expenseNotes").value="";
document.getElementById("expensePDF").value="";
document.getElementById("fileName").textContent="";
}

function deleteExpense(id){
if(confirm("Delete this expense?")){
expenses=expenses.filter(e=>e.id!==id);
deleteFromDB("expenses",id);
updateExpensesList();
}
}

function getExpensesForProperty(property){
return expenses.filter(e=>e.property===property && e.owner===document.getElementById("owner").value);
}

function updateExpensesList(){
const list=document.getElementById("expensesList");
const owner=document.getElementById("owner").value;
const ownerExpenses=expenses.filter(e=>e.owner===owner).sort((a,b)=>new Date(b.id)-new Date(a.id)).slice(0,10);

if(ownerExpenses.length===0){
list.innerHTML='<div style="color:#aaa;font-size:10px">No expenses</div>';
return;
}

list.innerHTML=ownerExpenses.map(e=>`
<div class="expense-item">
<div style="display:flex;justify-content:space-between;align-items:center;width:100%">
<div style="flex:1">
<div style="font-weight:bold;color:#fff">${e.type} - ${e.vendor}</div>
<div style="color:#aaa;font-size:9px">Property: ${e.property}</div>
<div style="color:#aaa;font-size:9px">${e.notes}</div>
${e.pdf?`<div style="color:#4CAF50;font-size:9px">üìé ${e.pdf.name}</div>`:""}
</div>
<div style="text-align:right">
<div style="color:#fff;font-weight:bold;font-size:11px">$${e.amount.toFixed(2)}</div>
<button class="delete-btn" onclick="deleteExpense(${e.id})">üóë</button>
</div>
</div>
</div>
`).join("");
}

function updateSettingsDisplay(){
const selectedOwner=document.getElementById("owner").value;
const ownerData=owners[selectedOwner];
const isDraft=ownerData.type==="draft";

updateExpensesList();

let html=`
<div class="owner-item">
<div class="owner-item-name">üë§ ${selectedOwner}</div>
<div class="owner-item-control">
<label class="owner-item-label">Commission (%)</label>
<input type="number" step="0.01" min="0" max="100" value="${(ownerData.percent*100).toFixed(2)}" onchange="updateOwner('${selectedOwner}','percent',this.value/100)">
</div>
<div class="owner-item-control">
<label class="owner-item-label">Type</label>
<select onchange="updateOwner('${selectedOwner}','type',this.value)">
<option value="draft" ${ownerData.type==='draft'?'selected':''}>Draft</option>
<option value="payout" ${ownerData.type==='payout'?'selected':''}>Payout</option>
</select>
</div>
<div class="owner-item-control">
<label class="owner-item-label">Sales Person Fee (%)</label>
<input type="number" step="0.01" min="0" max="100" value="${(ownerData.salesFeePercent).toFixed(2)}" onchange="updateOwner('${selectedOwner}','salesFeePercent',this.value)">
</div>
`;

if(!isDraft){
html+=`
<div class="owner-item-control">
<label class="owner-item-label">Tax Reporting Municipalities</label>
<div class="checkbox-group">
<div class="checkbox-item">
<input type="checkbox" id="mun_SC" ${ownerData.municipalities?.SC?'checked':''} onchange="updateMunicipality('${selectedOwner}','SC',this.checked)">
<label for="mun_SC">SC</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="mun_MB" ${ownerData.municipalities?.MB?'checked':''} onchange="updateMunicipality('${selectedOwner}','MB',this.checked)">
<label for="mun_MB">MB</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="mun_NMB" ${ownerData.municipalities?.NMB?'checked':''} onchange="updateMunicipality('${selectedOwner}','NMB',this.checked)">
<label for="mun_NMB">NMB</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="mun_SSB" ${ownerData.municipalities?.SSB?'checked':''} onchange="updateMunicipality('${selectedOwner}','SSB',this.checked)">
<label for="mun_SSB">SSB</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="mun_HC" ${ownerData.municipalities?.HC?'checked':''} onchange="updateMunicipality('${selectedOwner}','HC',this.checked)">
<label for="mun_HC">HC</label>
</div>
</div>
</div>
`;
}

html+=`</div>`;

document.getElementById("ownersList").innerHTML=html;
document.getElementById("settingsTitle").textContent=`${selectedOwner} - Settings`;
}

function updateOwner(name,field,value){
if(field==='percent'){
owners[name].percent=parseFloat(value);
}else if(field==='type'){
owners[name].type=value;
updateSettingsDisplay();
}else if(field==='salesFeePercent'){
owners[name].salesFeePercent=parseFloat(value)||0;
}
}

function updateMunicipality(owner,municipality,checked){
if(!owners[owner].municipalities){
owners[owner].municipalities={};
}
owners[owner].municipalities[municipality]=checked;
}

function toggleSettings(){
document.getElementById("settingsBox").classList.toggle("open");
}

function toggleExpense(){
document.getElementById("expenseBox").classList.toggle("open");
}

function toggleVendors(){
document.getElementById("vendorBox").classList.toggle("open");
}

function viewHistory(){
const owner=document.getElementById("owner").value;

let html=`
<button class="back-btn" onclick="goBackFromHistory()">‚Üê Back</button>
<h2 style="text-align:center;margin-bottom:20px">Statement History - ${owner}</h2>
<div class="history-list">
`;

const ownerHistory=statementHistory.filter(s=>s.owner===owner).sort((a,b)=>new Date(b.date)-new Date(a.date));

if(ownerHistory.length===0){
html+=`<div style="padding:20px;text-align:center;color:#666">No statements generated yet</div>`;
}else{
ownerHistory.forEach(s=>{
html+=`
<div class="history-item">
<div>
<div style="font-weight:bold;color:#333">${s.month}/${s.year}</div>
<div style="color:#666;font-size:10px">Generated: ${new Date(s.date).toLocaleString()}</div>
<div style="color:#666;font-size:10px">Payout: $${s.payout.toFixed(2)}</div>
</div>
<button class="delete-btn" onclick="deleteStatement(${s.id})">üóë Delete</button>
</div>
`;
});
}

html+=`</div>`;

document.getElementById("report").classList.add("hidden");
document.getElementById("summaryPage").classList.add("hidden");
document.getElementById("historyPage").classList.remove("hidden");
document.getElementById("historyPage").innerHTML=html;
}

function deleteStatement(id){
if(confirm("Delete this statement from history?")){
statementHistory=statementHistory.filter(s=>s.id!==id);
deleteFromDB("statements",id);
viewHistory();
}
}

function goBackFromHistory(){
document.getElementById("historyPage").classList.add("hidden");
document.getElementById("report").classList.remove("hidden");
}

const ownerSelect=document.getElementById("owner");
Object.keys(owners).forEach(o=>ownerSelect.innerHTML+=`<option>${o}</option>`);

const monthSelect=document.getElementById("month");
const yearSelect=document.getElementById("year");
const now=new Date();

for(let m=1;m<=12;m++){
monthSelect.innerHTML+=`<option value="${m}">${new Date(0,m-1).toLocaleString('default',{month:'long'})}</option>`;
}
monthSelect.value=now.getMonth()+1;

for(let y=now.getFullYear()-2;y<=now.getFullYear()+2;y++){
yearSelect.innerHTML+=`<option>${y}</option>`;
}
yearSelect.value=now.getFullYear();

function num(v){return parseFloat((v||"0").toString().replace(/[$,]/g,""))||0}
function money(x){return "$"+(Number(x)||0).toFixed(2)}
function stay(i,o){if(!i||!o)return"";let a=i.split("-"),b=o.split("-");return a[1]+"/"+a[2]+" - "+b[1]+"/"+b[2]}
function lastDay(y,m){return new Date(y,m,0).getDate()}

let propertyTotals={};
let masterTotals={};

async function runReport(){
document.getElementById("report").classList.remove("hidden");
document.getElementById("summaryPage").classList.add("hidden");
document.getElementById("historyPage").classList.add("hidden");

propertyTotals={};
masterTotals={gross:0,acc:0,clean:0,pmc:0,expenses:0,draft:0,owner:0,websiteFee:0};

const file=document.getElementById("fileInput").files[0];
if(!file)return;

const text=await file.text();
csvData=Papa.parse(text,{header:true,skipEmptyLines:true}).data;

const owner=ownerSelect.value;
const percent=owners[owner].percent;
const type=owners[owner].type;
const month=parseInt(monthSelect.value);
const year=parseInt(yearSelect.value);
const endDay=lastDay(year,month);

const statementDate=new Date(year,month,1);
const paymentDate=new Date(year,month,5);

let grouped={};
properties=[];

csvData.forEach(r=>{
if(!r["CHECK-IN DATE"])return;
let m=parseInt(r["CHECK-IN DATE"].split("-")[1]);
let y=parseInt(r["CHECK-IN DATE"].split("-")[0]);
if(m!==month||y!==year)return;

let listing=r["LISTING'S NICKNAME"]||"Unknown";
if(!properties.includes(listing)) properties.push(listing);
if(!grouped[listing])grouped[listing]=[];
grouped[listing].push(r);
});

updatePropertySelects();

let reportHTML="";

reportHTML+=`
<div class="header">
<div>
<div class="company">OCEAN VACATIONS</div>
<div class="company-info">
www.oceanvacationsmb.com<br>
oceanvacationsmb@gmail.com<br>
843-222-6516
</div>
</div>
<div style="text-align:right;font-size:9px">
Statement Date: ${statementDate.toLocaleDateString()}<br>
Payment Date: ${paymentDate.toLocaleDateString()}
</div>
</div>

<div class="title">RESERVATION REPORT</div>
<div class="owner">${owner}</div>
<div class="period"><strong>PERIOD:</strong> ${month}/1/${year} - ${month}/${endDay}/${year}</div>
`;

Object.keys(grouped).forEach(listing=>{

let pGross=0,pAcc=0,pClean=0,pPMC=0,pDraft=0,pOwner=0,pWebsiteFee=0,pExpenses=0;

grouped[listing].forEach(r=>{
let payout=num(r["TOTAL PAYOUT"]);
let acc=num(r["ACCOMMODATION FARE"])-num(r["MARKUP"]);
let clean=num(r["CLEANING FARE"]);
let pmc=acc*percent;
let draft=pmc+clean;
let ownerPay=acc-pmc;

let websiteFee=0;
if(type==="draft"){
let confirmationCode=r["CONFIRMATION CODE"]||"";
let isVRBO=confirmationCode.toUpperCase().startsWith("HA");
let platform=r["PLATFORM"]||"";
let platformLower=platform.toLowerCase();

if(!isVRBO && platformLower.includes("website")){
websiteFee=payout*0.01;
pWebsiteFee+=websiteFee;
}
}

pGross+=payout;
pAcc+=acc;
pClean+=clean;
pPMC+=pmc;
pDraft+=draft+websiteFee;
pOwner+=ownerPay;
});

// Add property expenses
const propertyExpenses=getExpensesForProperty(listing);
propertyExpenses.forEach(e=>{
pExpenses+=e.amount;
});

propertyTotals[listing]={gross:pGross,acc:pAcc,clean:pClean,pmc:pPMC,draft:pDraft,owner:pOwner,websiteFee:pWebsiteFee,expenses:pExpenses};

masterTotals.gross+=pGross;
masterTotals.acc+=pAcc;
masterTotals.clean+=pClean;
masterTotals.pmc+=pPMC;
masterTotals.draft+=pDraft;
masterTotals.owner+=pOwner;
masterTotals.websiteFee+=pWebsiteFee;
masterTotals.expenses+=pExpenses;
});

reportHTML+=`
<div class="summary-box-master">
<div class="summary-header-master">SUMMARY</div>
<div class="summary-master">
${type==="draft"
?`
<div class="summary-item-master"><span class="summary-item-label-master">GROSS PAYOUT</span><span class="summary-item-amount-master">${money(masterTotals.gross)}</span></div>
<div class="summary-item-master"><span class="summary-item-label-master">NET ACCOMMODATION</span><span class="summary-item-amount-master">${money(masterTotals.acc)}</span></div>
<div class="summary-item-master"><span class="summary-item-label-master">PMC</span><span class="summary-item-amount-master">${money(masterTotals.pmc)}</span></div>
<div class="summary-item-master"><span class="summary-item-label-master">CLEANING FEE</span><span class="summary-item-amount-master">${money(masterTotals.clean)}</span></div>
<div class="summary-item-master"><span class="summary-item-label-master">WEBSITE FEE</span><span class="summary-item-amount-master">${money(masterTotals.websiteFee)}</span></div>
<div class="summary-item-master"><span class="summary-item-label-master">EXPENSES</span><span class="summary-item-amount-master">${money(masterTotals.expenses)}</span></div>
<div class="summary-item-master"><span class="summary-item-label-master">PAYOUT</span><span class="summary-item-amount-master" id="masterBal">${money(masterTotals.draft-masterTotals.expenses)}</span></div>
`
:`
<div class="summary-item-master"><span class="summary-item-label-master">NET ACCOMMODATION</span><span class="summary-item-amount-master">${money(masterTotals.acc)}</span></div>
<div class="summary-item-master"><span class="summary-item-label-master">PMC</span><span class="summary-item-amount-master">${money(masterTotals.pmc)}</span></div>
<div class="summary-item-master"><span class="summary-item-label-master">EXPENSES</span><span class="summary-item-amount-master">${money(masterTotals.expenses)}</span></div>
<div class="summary-item-master"><span class="summary-item-label-master">PAYOUT</span><span class="summary-item-amount-master" id="masterBal">${money(masterTotals.owner-masterTotals.expenses)}</span></div>
`}
</div>
</div>

<div class="page-break"></div>
`;

Object.keys(grouped).forEach(listing=>{

let p=propertyTotals[listing];
const propExpenses=getExpensesForProperty(listing);
const finalPayout=type==="draft"?p.draft-p.expenses:p.owner-p.expenses;

reportHTML+=`
<div class="property">
<div class="property-title">${listing}</div>
<div class="property-period"><strong>PERIOD:</strong> ${month}/1/${year} - ${month}/${endDay}/${year}</div>

${propExpenses.length>0?`
<div class="property-notes">
<strong>üìù Expenses:</strong><br>
${propExpenses.map(e=>`${e.type} - ${e.vendor}: $${e.amount.toFixed(2)}${e.notes?` (${e.notes})`:''}`).join('<br>')}
</div>
`:""}

<div class="summary-box">
<div class="summary-header">SUMMARY</div>
<div class="summary">
${type==="draft"
?`
<div class="summary-item"><span class="summary-item-label">GROSS PAYOUT</span><span class="summary-item-amount">${money(p.gross)}</span></div>
<div class="summary-item"><span class="summary-item-label">NET ACCOMMODATION</span><span class="summary-item-amount">${money(p.acc)}</span></div>
<div class="summary-item"><span class="summary-item-label">PMC</span><span class="summary-item-amount">${money(p.pmc)}</span></div>
<div class="summary-item"><span class="summary-item-label">CLEANING FEE</span><span class="summary-item-amount">${money(p.clean)}</span></div>
<div class="summary-item"><span class="summary-item-label">WEBSITE FEE</span><span class="summary-item-amount">${money(p.websiteFee)}</span></div>
<div class="summary-item"><span class="summary-item-label">EXPENSES</span><span class="summary-item-amount">${money(p.expenses)}</span></div>
<div class="summary-item"><span class="summary-item-label">PAYOUT</span><span class="summary-item-amount" id="bal-${listing}">${money(finalPayout)}</span></div>
`
:`
<div class="summary-item"><span class="summary-item-label">NET ACCOMMODATION</span><span class="summary-item-amount">${money(p.acc)}</span></div>
<div class="summary-item"><span class="summary-item-label">PMC</span><span class="summary-item-amount">${money(p.pmc)}</span></div>
<div class="summary-item"><span class="summary-item-label">EXPENSES</span><span class="summary-item-amount">${money(p.expenses)}</span></div>
<div class="summary-item"><span class="summary-item-label">PAYOUT</span><span class="summary-item-amount" id="bal-${listing}">${money(finalPayout)}</span></div>
`}
</div>
</div>

<table>
<tr>
<th>Reservation</th>
<th>Stay</th>
<th>Platform</th>
<th>Accommodation</th>
<th>PMC</th>
${type==="draft"?"<th>Cleaning Fee</th><th>Website Fee</th><th>Payout</th>":"<th>Owner</th>"}
</tr>
`;

grouped[listing].forEach(r=>{
let acc=num(r["ACCOMMODATION FARE"])-num(r["MARKUP"]);
let clean=num(r["CLEANING FARE"]);
let payout=num(r["TOTAL PAYOUT"]);
let pmc=acc*percent;
let draft=pmc+clean;
let ownerPay=acc-pmc;
let platform=r["PLATFORM"]||"N/A";
let confirmationCode=r["CONFIRMATION CODE"]||"N/A";

let isVRBO=confirmationCode.toUpperCase().startsWith("HA");
let displayPlatform=isVRBO?"VRBO":platform;

let websiteFee=0;
if(type==="draft"){
let platformLower=platform.toLowerCase();
if(!isVRBO && platformLower.includes("website")){
websiteFee=payout*0.01;
}
}

if(payout===0 && clean===0){
return;
}

let draftDisplay=draft+websiteFee;

reportHTML+=`
<tr>
<td>${confirmationCode.substring(0,8)}</td>
<td>${stay(r["CHECK-IN DATE"],r["CHECK-OUT DATE"])}</td>
<td style="max-width:80px;word-wrap:break-word;">${displayPlatform}</td>
<td>${money(acc)}</td>
<td>${money(pmc)}</td>
${type==="draft"
?`<td>${money(clean)}</td><td>${money(websiteFee)}</td><td>${money(draftDisplay)}</td>`
:`<td>${money(ownerPay)}</td>`}
</tr>
`;
});

reportHTML+=`
</table>
</div>

<div class="page-break"></div>
`;
});

document.getElementById("report").innerHTML=reportHTML;
}

function runSummary(){
const owner=ownerSelect.value;
const ownerData=owners[owner];
const type=ownerData.type;
const salesFeePercent=ownerData.salesFeePercent;
const percent=ownerData.percent;
const month=parseInt(monthSelect.value);
const year=parseInt(yearSelect.value);
const endDay=lastDay(year,month);

const salesFeeAmount=masterTotals.pmc*(salesFeePercent/100);
const finalPayout=type==="draft"?masterTotals.draft-masterTotals.expenses:masterTotals.owner-masterTotals.expenses;

let taxByProperty={};
let hasTaxes=false;

if(type==="payout"){
csvData.forEach(r=>{
if(!r["CHECK-IN DATE"])return;
let m=parseInt(r["CHECK-IN DATE"].split("-")[1]);
let y=parseInt(r["CHECK-IN DATE"].split("-")[0]);
if(m!==month||y!==year)return;

let cityTax=num(r["CITY TAX"])||0;
let stateTax=num(r["STATE TAX"])||0;
let countyTax=num(r["COUNTY TAX"])||0;
let occupancyTax=num(r["OCCUPANCY TAX"])||0;
let totalTax=cityTax+stateTax+countyTax+occupancyTax;

if(totalTax>0){
hasTaxes=true;
let payout=num(r["TOTAL PAYOUT"])||0;
let property=r["LISTING'S NICKNAME"]||"Unknown";

if(!taxByProperty[property]){
taxByProperty[property]={payout:0};
}
taxByProperty[property].payout+=payout;
}
});
}

let selectedMunicipalities=[];
if(ownerData.municipalities){
Object.entries(ownerData.municipalities).forEach(([mun,checked])=>{
if(checked) selectedMunicipalities.push(mun);
});
}

let summaryHTML=`
<button class="back-btn" onclick="goBackToStatement()">‚Üê Back to Statement</button>
<button class="print-btn" onclick="printSummary()" style="position:absolute;top:20px;right:20px;padding:8px 15px">üñ®Ô∏è Print this page</button>

<div class="summary-page-header">SUMMARY REPORT</div>
<div class="summary-page-period"><strong>OWNER:</strong> ${owner} | <strong>PERIOD:</strong> ${month}/1/${year} - ${month}/${endDay}/${year}</div>

<div class="summary-section">
<div class="summary-section-title">üí∞ ACCOMMODATION & SALES PERSON FEE</div>
<div class="summary-line">
<span>Total Accommodation:</span>
<span class="summary-line-value">${money(masterTotals.acc)}</span>
</div>
<div class="summary-line">
<span>PMC Amount (Base):</span>
<span class="summary-line-value">${money(masterTotals.pmc)}</span>
</div>
<div class="summary-line">
<span>Sales Person Fee Rate:</span>
<span class="summary-line-value">${salesFeePercent.toFixed(2)}%</span>
</div>
<div class="summary-line" style="border-bottom:2px solid #000;padding-top:8px;padding-bottom:8px">
<span style="font-size:13px"><strong>Sales Person Amount Due:</strong></span>
<span class="summary-line-value" style="font-size:13px">${money(salesFeeAmount)}</span>
</div>
</div>

${type==="draft"?`
<div class="summary-section">
<div class="summary-section-title">üåê WEBSITE BOOKING FEE & EXPENSES</div>
<div class="summary-line">
<span>Total Website Booking Fee (1.00%):</span>
<span class="summary-line-value">${money(masterTotals.websiteFee)}</span>
</div>
<div class="summary-line">
<span>Cleaning Fee:</span>
<span class="summary-line-value">${money(masterTotals.clean)}</span>
</div>
<div class="summary-line" style="border-bottom:2px solid #000;padding-top:8px;padding-bottom:8px">
<span>Total Expenses/Credits:</span>
<span class="summary-line-value">${money(masterTotals.expenses)}</span>
</div>
</div>
`:""}

<div class="summary-section">
<div class="summary-section-title">üí≥ PAYMENT INFORMATION</div>
<div class="summary-line">
<span>Owner Name:</span>
<span class="summary-line-value">${owner}</span>
</div>
<div class="summary-line">
<span>Owner Type:</span>
<span class="summary-line-value">${type.toUpperCase()}</span>
</div>
<div class="summary-line">
<span>Gross Payout:</span>
<span class="summary-line-value">${money(masterTotals.gross)}</span>
</div>
<div class="summary-line" style="border-bottom:2px solid #000;padding-top:8px;padding-bottom:8px">
<span style="font-size:13px"><strong>Net Payout Amount:</strong></span>
<span class="summary-line-value" style="font-size:13px;color:#000;font-weight:bold;font-size:14px">${money(finalPayout)}</span>
</div>
</div>

<div class="summary-section">
<div class="summary-section-title">üè¶ PMC TRANSFER</div>
<div class="summary-line">
<span>Transfer to PMC Account:</span>
<span class="summary-line-value">${money(masterTotals.pmc)}</span>
</div>
<div style="font-size:10px;color:#666;margin-top:10px">
This amount needs to be transferred to the PMC bank account
</div>
</div>

${type==="payout" && hasTaxes && selectedMunicipalities.length>0?`
<div class="warning-section">
<div class="warning-title">‚ö†Ô∏è TAX REPORTING REQUIRED - CITY/STATE TAXES COLLECTED</div>
<div style="font-size:11px;margin-bottom:10px;color:#333"><strong>Municipalities:</strong> ${selectedMunicipalities.join(', ')}</div>
<table class="tax-table">
<tr>
<th>Property Name</th>
<th>Total Payout Amount to Report</th>
</tr>
${Object.entries(taxByProperty).map(([property, data])=>`
<tr>
<td>${property}</td>
<td class="tax-amount">${money(data.payout)}</td>
</tr>
`).join("")}
<tr style="background:#ffc104;font-weight:bold">
<td>TOTAL</td>
<td class="tax-amount">${money(Object.values(taxByProperty).reduce((sum, p) => sum + p.payout, 0))}</td>
</tr>
</table>
<p style="font-size:11px;margin-top:15px;color:#333">
üìù This is the total payout from reservations with taxes withheld, broken down by property. Report these amounts to your ${selectedMunicipalities.join(', ')} tax authorities.
</p>
</div>
`:""}
`;

lastSummaryHTML=summaryHTML;

statementHistory.push({
id:Date.now(),
owner:owner,
month:month,
year:year,
date:new Date().toISOString(),
payout:finalPayout
});
saveStatementHistory();

document.getElementById("report").classList.add("hidden");
document.getElementById("summaryPage").classList.remove("hidden");
document.getElementById("summaryPage").innerHTML=summaryHTML;
}

function goBackToStatement(){
document.getElementById("report").classList.remove("hidden");
document.getElementById("summaryPage").classList.add("hidden");
document.getElementById("historyPage").classList.add("hidden");
}

function printSummary(){
const printWindow=window.open('','','width=800,height=600');
printWindow.document.write(lastSummaryHTML);
printWindow.document.close();
setTimeout(()=>printWindow.print(),250);
}

function downloadPDF(){
html2pdf().set({margin:5,jsPDF:{unit:"mm",format:"a4"}})
.from(document.getElementById("report")).save("Reservation_Report.pdf");
}

window.addEventListener('DOMContentLoaded',async()=>{
await initDB();
await loadFromDB();
updateSettingsDisplay();
});

</script>

</body>
</html>
