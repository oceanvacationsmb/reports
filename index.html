<!DOCTYPE html>
<html>
<head>
<title>Ocean Vacations</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial;background:#f5f5f5;display:flex}.sidebar{width:280px;background:#333;color:#fff;padding:20px;height:100vh;overflow-y:auto;position:fixed}.sidebar h3{margin-bottom:20px;font-size:16px;border-bottom:2px solid #fff;padding-bottom:10px}.section{margin-bottom:20px}.label{font-size:11px;font-weight:bold;color:#aaa;margin-bottom:5px;display:block}select,input{width:100%;padding:8px;margin:5px 0;border:1px solid #555;background:#444;color:#fff;border-radius:3px;font-size:11px}.btn{width:100%;padding:12px;margin:8px 0;border:none;font-weight:bold;border-radius:3px;cursor:pointer;font-size:12px;color:#fff}.btn-primary{background:#000}.btn-success{background:#28a745}.btn-warning{background:#ff9800}.btn-info{background:#17a2b8}.btn-danger{background:#dc3545}.main{margin-left:280px;padding:20px;width:calc(100% - 280px)}.page{background:#fff;padding:40px;border-radius:5px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}table{width:100%;border-collapse:collapse;margin:20px 0;font-size:11px}th,td{border:1px solid #e0e0e0;padding:12px;text-align:left}th{background:#f5f5f5;font-weight:bold;text-align:center;text-transform:uppercase}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5)}.modal-content{background:#fff;margin:5% auto;padding:20px;width:80%;max-width:600px;border-radius:5px;max-height:80vh;overflow-y:auto}.modal-close{float:right;font-size:28px;font-weight:bold;cursor:pointer}.status-msg{padding:10px;margin:10px 0;border-radius:3px;font-size:11px}.status-success{background:#d4edda;color:#155724}.status-error{background:#f8d7da;color:#721c24}
</style>
</head>
<body>
<div class="sidebar"><h3>üéØ OCEAN VACATIONS</h3>
<div id="statusMessage" class="status-msg status-success" style="display:block">‚úì Ready</div>
<div class="section"><label class="label">Select Owner</label><select id="ownerSelect" onchange="onOwnerChange()"><option>-- Select Owner --</option></select></div>
<div class="section"><label class="label">Month</label><select id="monthSelect"></select></div>
<div class="section"><label class="label">Year</label><select id="yearSelect"></select></div>
<div class="section"><label class="label">Upload CSV</label><input type="file" id="csvFile" accept=".csv"></div>
<button class="btn btn-primary" onclick="generateStatement()">‚ñ∂ STATEMENT</button>
<button class="btn btn-success" onclick="generateSummary()">üìä View Summary</button>
<button class="btn btn-warning" onclick="generateAnnual()">üìà Annual Report</button>
<button class="btn btn-info" onclick="downloadPDF()">üì• Download PDF</button>
<button class="btn btn-info" onclick="viewHistory()">üìã View History</button>
<hr style="border:1px solid #555;margin:20px 0">
<h4 style="color:#fff;margin-bottom:10px">üí∞ Add Expense</h4>
<select id="expenseType"><option>Maintenance</option><option>Repair</option><option>Purchase</option><option>Supplies</option><option>Service</option></select>
<select id="expenseProperty"></select>
<select id="expenseVendor"></select>
<input type="number" id="expenseAmount" placeholder="Amount" step="0.01">
<input type="text" id="expenseNotes" placeholder="Notes">
<button class="btn btn-success" onclick="addExpense()">Add Expense</button>
<hr style="border:1px solid #555;margin:20px 0">
<h4 style="color:#fff;margin-bottom:10px">üè¢ Vendors</h4>
<input type="text" id="vendorName" placeholder="Name">
<input type="text" id="vendorPhone" placeholder="Phone">
<button class="btn btn-success" onclick="addVendor()">Add Vendor</button>
<button class="btn btn-warning" onclick="showVendorModal()">Manage</button>
<hr style="border:1px solid #555;margin:20px 0">
<button class="btn btn-info" onclick="setupGitHub()">üîë GitHub Setup</button>
</div>

<div id="vendorModal" class="modal"><div class="modal-content"><span class="modal-close" onclick="closeVendorModal()">&times;</span><h2>Vendors</h2><div id="vendorListModal"></div></div></div>

<div class="main"><div class="page"><h1>Ocean Vacations - Reservation Report</h1><div id="mainContent"><p style="text-align:center;padding:40px;color:#666">Select owner, upload CSV, and click STATEMENT</p></div></div></div>

<script>
const GITHUB_URL="https://raw.githubusercontent.com/oceanvacationsmb/reports/main/data.json";
let gitHubData={},vendors=[],expenses=[],csvData=[],properties=[],currentOwner="",masterTotals={},propertyTotals={};
const OWNERS={"ERAN":{percent:0.12,type:"draft",salesFeePercent:5},"GHO":{percent:0.10,type:"payout",salesFeePercent:5},"1463 Basin Trail":{percent:0.12,type:"payout",salesFeePercent:5},"113B-15S Surfside Beach":{percent:0.12,type:"payout",salesFeePercent:5}};

async function loadData(){try{const r=await fetch(GITHUB_URL+"?t="+Date.now());if(!r.ok)throw new Error("Failed");gitHubData=await r.json();vendors=gitHubData.vendors||[];expenses=gitHubData.expenses||[];buildOwnerDropdown();buildMonthDropdown();buildYearDropdown();updateVendorList()}catch(e){console.error(e);buildOwnerDropdown();buildMonthDropdown();buildYearDropdown()}}

function buildOwnerDropdown(){const e=document.getElementById("ownerSelect");e.innerHTML='<option>-- Select Owner --</option>';Object.keys(OWNERS).sort().forEach(n=>{const t=document.createElement("option");t.value=n;t.textContent=n;e.appendChild(t)})}
function buildMonthDropdown(){const e=document.getElementById("monthSelect");["January","February","March","April","May","June","July","August","September","October","November","December"].forEach((n,t)=>{const a=document.createElement("option");a.value=t+1;a.textContent=n;e.appendChild(a)});e.value=new Date().getMonth()+1}
function buildYearDropdown(){const e=document.getElementById("yearSelect");const n=new Date().getFullYear();for(let t=n-2;t<=n+2;t++){const a=document.createElement("option");a.value=t;a.textContent=t;e.appendChild(a)}e.value=n}
function onOwnerChange(){currentOwner=document.getElementById("ownerSelect").value;updatePropertySelect()}
function updateVendorList(){const e=document.getElementById("expenseVendor");e.innerHTML="<option>-- Select --</option>";vendors.forEach(n=>{const t=document.createElement("option");t.value=n.name;t.textContent=n.name;e.appendChild(t)})}
function updatePropertySelect(){const e=document.getElementById("expenseProperty");e.innerHTML="<option>-- Select --</option>";properties.forEach(n=>{const t=document.createElement("option");t.value=n;t.textContent=n;e.appendChild(t)})}
function setupGitHub(){const e=localStorage.getItem("github_token")||"";const n=prompt("GitHub Token:",e);if(n&&n.trim()){localStorage.setItem("github_token",n.trim());loadData()}}
async function saveToGitHub(e){const n=localStorage.getItem("github_token");if(!n){alert("No token");return false}try{const t=JSON.stringify(e,null,2);const a=btoa(unescape(encodeURIComponent(t)));const s=await fetch("https://api.github.com/repos/oceanvacationsmb/reports/contents/data.json",{headers:{"Authorization":"token "+n}});if(!s.ok)throw new Error("fetch");const r=await s.json();const o=await fetch("https://api.github.com/repos/oceanvacationsmb/reports/contents/data.json",{method:"PUT",headers:{"Authorization":"token "+n,"Content-Type":"application/json"},body:JSON.stringify({message:"Update: "+new Date().toLocaleString(),content:a,sha:r.sha,branch:"main"})});if(!o.ok)throw new Error("save");alert("‚úì Saved!");gitHubData=e;return true}catch(e){alert("Error: "+e.message);return false}}

async function addVendor(){const e=document.getElementById("vendorName").value.trim();const n=document.getElementById("vendorPhone").value.trim();if(!e){alert("Enter name");return}vendors.push({id:Date.now(),name:e,phone:n});updateVendorList();document.getElementById("vendorName").value="";document.getElementById("vendorPhone").value="";await saveToGitHub({...gitHubData,vendors})}
async function deleteVendor(e){vendors=vendors.filter(n=>n.id!==e);updateVendorList();await saveToGitHub({...gitHubData,vendors})}
function showVendorModal(){const e=document.getElementById("vendorListModal");if(vendors.length===0){e.innerHTML="<p>No vendors</p>"}else{let n="";vendors.forEach(t=>{n+="<div style='background:#f0f0f0;padding:10px;margin:10px 0;display:flex;justify-content:space-between'><div><strong>"+t.name+"</strong><br>"+t.phone+"</div><button onclick='deleteVendor("+t.id+")' class='btn btn-danger' style='width:60px'>Delete</button></div>"});e.innerHTML=n}document.getElementById("vendorModal").style.display="block"}
function closeVendorModal(){document.getElementById("vendorModal").style.display="none"}

async function addExpense(){const e=document.getElementById("expenseType").value;const n=document.getElementById("expenseProperty").value;const t=document.getElementById("expenseVendor").value;const a=parseFloat(document.getElementById("expenseAmount").value);if(!currentOwner||!n||!t||!a){alert("Fill all fields");return}expenses.push({id:Date.now(),owner:currentOwner,type:e,property:n,vendor:t,amount:a,notes:document.getElementById("expenseNotes").value});document.getElementById("expenseAmount").value="";document.getElementById("expenseNotes").value="";await saveToGitHub({...gitHubData,expenses});alert("‚úì Added")}

function money(e){return"$"+(Number(e)||0).toFixed(2)}
function num(e){return parseFloat((e||"0").toString().replace(/[$,]/g,""))||0}

async function generateStatement(){const e=document.getElementById("csvFile").files[0];if(!e){alert("Upload CSV");return}if(!currentOwner){alert("Select owner");return}const n=new FileReader();n.onload=t=>{csvData=Papa.parse(t.target.result,{header:true,skipEmptyLines:true}).data;processData();displayStatement()};n.readAsText(e)}

function processData(){const e=parseInt(document.getElementById("monthSelect").value);const n=parseInt(document.getElementById("yearSelect").value);const t=OWNERS[currentOwner]||{percent:0.12};propertyTotals={};masterTotals={gross:0,acc:0,clean:0,pmc:0,expenses:0,owner:0};properties=[];let a={};csvData.forEach(t=>{if(!t["CHECK-IN DATE"])return;let s=parseInt(t["CHECK-IN DATE"].split("-")[1]);let r=parseInt(t["CHECK-IN DATE"].split("-")[0]);if(s!==e||r!==n)return;let o=t["LISTING'S NICKNAME"]||"Unknown";if(!properties.includes(o))properties.push(o);if(!a[o])a[o]=[];a[o].push(t)});updatePropertySelect();Object.keys(a).forEach(e=>{let n=0,s=0,r=0,o=0,i=0;a[e].forEach(a=>{let c=num(a["TOTAL PAYOUT"]);let d=num(a["ACCOMMODATION FARE"])-num(a["MARKUP"]);let l=d*t.percent;n+=c;s+=d;r+=l});let c=expenses.filter(n=>n.property===e&&n.owner===currentOwner).reduce((e,n)=>e+n.amount,0);propertyTotals[e]={gross:n,acc:s,pmc:r,expenses:c,reservations:a[e]};masterTotals.gross+=n;masterTotals.acc+=s;masterTotals.pmc+=r;masterTotals.expenses+=c;masterTotals.owner+=s-r-c})}

function displayStatement(){let e="<h2>"+currentOwner.toUpperCase()+"</h2>";e+="<table><tr><th>Property</th><th>Accommodation</th><th>PMC</th><th>Expenses</th><th>Net</th></tr>";Object.keys(propertyTotals).forEach(n=>{const t=propertyTotals[n];e+="<tr><td>"+n+"</td><td>"+money(t.acc)+"</td><td>"+money(t.pmc)+"</td><td>"+money(t.expenses)+"</td><td>"+money(t.acc-t.pmc-t.expenses)+"</td></tr>"});e+="<tr style='background:#000;color:#fff'><td><strong>TOTAL</strong></td><td><strong>"+money(masterTotals.acc)+"</strong></td><td><strong>"+money(masterTotals.pmc)+"</strong></td><td><strong>"+money(masterTotals.expenses)+"</strong></td><td><strong>"+money(masterTotals.owner)+"</strong></td></tr></table>";document.getElementById("mainContent").innerHTML=e}

async function generateSummary(){if(!csvData||csvData.length===0){alert("Generate statement first");return}let e="<h2>Summary</h2><p>Total: "+money(masterTotals.owner)+"</p>";document.getElementById("mainContent").innerHTML=e}
async function generateAnnual(){if(!csvData||csvData.length===0){alert("Generate statement first");return}let e="<h2>Annual</h2><p>Total: "+money(masterTotals.owner)+"</p>";document.getElementById("mainContent").innerHTML=e}
async function viewHistory(){let e="<h2>History</h2><p>Saved reports will appear here</p>";document.getElementById("mainContent").innerHTML=e}
function downloadPDF(){html2pdf().from(document.querySelector(".page")).save("Report.pdf")}

loadData();
</script>
</body>
</html>
