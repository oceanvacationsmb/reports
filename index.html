<!DOCTYPE html>
<html>
<head>
<title>Ocean Vacations - Reservation Report</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial;background:#f5f5f5;color:#000;display:flex}
.sidebar{width:280px;background:#333;color:#fff;padding:20px;height:100vh;overflow-y:auto;position:fixed;left:0;top:0}
.sidebar h3{margin-bottom:20px;font-size:16px;border-bottom:2px solid #fff;padding-bottom:10px}
.section{margin-bottom:20px}
.label{font-size:11px;font-weight:bold;color:#aaa;margin-bottom:5px;display:block}
select,input{width:100%;padding:8px;margin:5px 0;border:1px solid #555;background:#444;color:#fff;border-radius:3px;font-size:11px}
.btn{width:100%;padding:12px;margin:8px 0;border:none;font-weight:bold;border-radius:3px;cursor:pointer;font-size:12px;color:#fff;transition:all 0.3s}
.btn-primary{background:#000}.btn-primary:hover{background:#222}
.btn-success{background:#28a745}.btn-success:hover{background:#218838}
.btn-warning{background:#ff9800}.btn-warning:hover{background:#e68900}
.btn-info{background:#17a2b8}.btn-info:hover{background:#138496}
.btn-danger{background:#dc3545}.btn-danger:hover{background:#c82333}
.main{margin-left:280px;padding:20px;width:calc(100% - 280px)}
.page{background:#fff;padding:30px;border-radius:5px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
.hidden{display:none}
.header{text-align:center;margin-bottom:30px;border-bottom:3px solid #000;padding-bottom:20px}
.title{font-size:28px;font-weight:bold;margin:10px 0}
.subtitle{font-size:12px;color:#666}
.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin:20px 0}
.summary-card{background:#f9f9f9;border:2px solid #333;padding:15px;text-align:center;border-radius:5px}
.summary-label{font-size:11px;color:#666;font-weight:bold}
.summary-value{font-size:18px;font-weight:bold;color:#000;margin-top:8px}
table{width:100%;border-collapse:collapse;margin:20px 0;font-size:11px}
th,td{border:1px solid #ddd;padding:10px;text-align:left}
th{background:#333;color:#fff}
tr:nth-child(even){background:#f9f9f9}
.back-btn{margin:20px 0;background:#666}
.back-btn:hover{background:#555}
.print-btn{background:#e74c3c}
.print-btn:hover{background:#c0392b}
@media print{.sidebar,.back-btn,.print-btn{display:none}.main{margin-left:0;width:100%}}
</style>
</head>
<body>

<div class="sidebar">
<h3>üéØ OCEAN VACATIONS</h3>

<div class="section">
<label class="label">Select Owner</label>
<select id="ownerSelect" onchange="onOwnerChange()">
<option value="">-- Loading --</option>
</select>
</div>

<div class="section">
<label class="label">Month</label>
<select id="monthSelect"></select>
</div>

<div class="section">
<label class="label">Year</label>
<select id="yearSelect"></select>
</div>

<div class="section">
<label class="label">Upload CSV</label>
<input type="file" id="csvFile" accept=".csv">
</div>

<button class="btn btn-primary" onclick="generateReport()">‚ñ∂ Run Report</button>
<button class="btn btn-success" onclick="generateSummary()">üìä View Summary</button>
<button class="btn btn-warning" onclick="generateAnnual()">üìà Annual Report</button>
<button class="btn btn-info" onclick="downloadPDF()">üì• Download PDF</button>

<hr style="border:1px solid #555;margin:20px 0">

<div class="section">
<h4 style="color:#fff;margin-bottom:10px">üè¢ Vendors</h4>
<input type="text" id="vendorName" placeholder="Vendor name">
<input type="text" id="vendorPhone" placeholder="Phone/Email">
<button class="btn btn-success" onclick="addVendor()" style="font-size:11px">Add Vendor</button>
<div id="vendorList" style="margin-top:10px;max-height:150px;overflow-y:auto"></div>
</div>

<div class="section">
<h4 style="color:#fff;margin-bottom:10px">üí∞ Add Expense</h4>
<select id="expenseType">
<option>Maintenance</option>
<option>Repair</option>
<option>Purchase</option>
<option>Supplies</option>
<option>Service</option>
<option>Pool Cleaning</option>
<option>Pest Control</option>
<option>Credit</option>
<option>Adjustment</option>
</select>
<select id="expenseProperty"></select>
<select id="expenseVendor"></select>
<input type="number" id="expenseAmount" placeholder="Amount" step="0.01">
<input type="text" id="expenseNotes" placeholder="Notes">
<button class="btn btn-success" onclick="addExpense()" style="font-size:11px">Add Expense</button>
</div>

</div>

<div class="main">
<div id="content" class="page">
<div class="header">
<div style="font-size:12px;color:#666">Welcome to</div>
<div class="title">OCEAN VACATIONS</div>
<div class="subtitle">Select an owner and upload a CSV file to get started</div>
</div>
</div>
</div>

<script>

// DATA
const OWNERS = {
  "ERAN": { percent: 0.12, type: "draft", salesFeePercent: 5 },
  "GHO": { percent: 0.10, type: "payout", salesFeePercent: 5 },
  "1463 Basin Trail": { percent: 0.12, type: "payout", salesFeePercent: 5 },
  "113B-15S Surfside Beach": { percent: 0.12, type: "payout", salesFeePercent: 5 },
  "113B-13N Surfside Beach": { percent: 0.12, type: "payout", salesFeePercent: 5 },
  "115C-15N Surfside Beach": { percent: 0.12, type: "payout", salesFeePercent: 5 },
  "2131 Sanibel Myrtle Beach": { percent: 0.15, type: "payout", salesFeePercent: 5 },
  "1552 Elizabeth Ln Myrtle Beach": { percent: 0.15, type: "payout", salesFeePercent: 5 }
};

let vendors = [];
let expenses = [];
let csvData = [];
let properties = [];
let currentOwner = "";
let masterTotals = {};
let propertyTotals = {};

// INIT
document.addEventListener("DOMContentLoaded", function() {
  console.log("Initializing app...");
  initOwners();
  initMonths();
  initYears();
  loadVendors();
  updateVendorList();
});

function initOwners() {
  const select = document.getElementById("ownerSelect");
  select.innerHTML = '<option value="">-- Select Owner --</option>';
  Object.keys(OWNERS).forEach(owner => {
    const opt = document.createElement("option");
    opt.value = owner;
    opt.textContent = owner;
    select.appendChild(opt);
  });
  console.log("Owners loaded:", Object.keys(OWNERS));
}

function initMonths() {
  const select = document.getElementById("monthSelect");
  const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  months.forEach((m, i) => {
    const opt = document.createElement("option");
    opt.value = i + 1;
    opt.textContent = m;
    select.appendChild(opt);
  });
  select.value = new Date().getMonth() + 1;
}

function initYears() {
  const select = document.getElementById("yearSelect");
  const year = new Date().getFullYear();
  for (let y = year - 2; y <= year + 2; y++) {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    select.appendChild(opt);
  }
  select.value = year;
}

function onOwnerChange() {
  currentOwner = document.getElementById("ownerSelect").value;
  if (currentOwner) {
    console.log("Selected owner:", currentOwner);
    updatePropertySelect();
  }
}

// VENDORS
function loadVendors() {
  const saved = localStorage.getItem("vendors");
  vendors = saved ? JSON.parse(saved) : [];
  console.log("Vendors loaded:", vendors.length);
}

function saveVendors() {
  localStorage.setItem("vendors", JSON.stringify(vendors));
}

function addVendor() {
  const name = document.getElementById("vendorName").value.trim();
  const phone = document.getElementById("vendorPhone").value.trim();
  if (!name) { alert("Enter vendor name"); return; }
  vendors.push({ id: Date.now(), name, phone });
  saveVendors();
  updateVendorList();
  document.getElementById("vendorName").value = "";
  document.getElementById("vendorPhone").value = "";
  console.log("Vendor added:", name);
}

function deleteVendor(id) {
  vendors = vendors.filter(v => v.id !== id);
  saveVendors();
  updateVendorList();
  updateExpenseVendorSelect();
}

function updateVendorList() {
  const list = document.getElementById("vendorList");
  if (vendors.length === 0) {
    list.innerHTML = '<div style="color:#aaa;font-size:10px">No vendors yet</div>';
    return;
  }
  list.innerHTML = vendors.map(v => `
    <div style="background:#555;padding:8px;margin:5px 0;border-radius:3px;display:flex;justify-content:space-between;align-items:center;font-size:10px">
      <div><strong>${v.name}</strong><br><span style="color:#aaa">${v.phone}</span></div>
      <button onclick="deleteVendor(${v.id})" class="btn btn-danger" style="width:auto;padding:3px 8px;margin:0;font-size:9px">Del</button>
    </div>
  `).join("");
  updateExpenseVendorSelect();
}

function updateExpenseVendorSelect() {
  const select = document.getElementById("expenseVendor");
  select.innerHTML = '<option value="">-- Select Vendor --</option>';
  vendors.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v.name;
    opt.textContent = v.name;
    select.appendChild(opt);
  });
}

function updatePropertySelect() {
  const select = document.getElementById("expenseProperty");
  select.innerHTML = '<option value="">-- Select Property --</option>';
  properties.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    select.appendChild(opt);
  });
}

// EXPENSES
function addExpense() {
  const type = document.getElementById("expenseType").value;
  const property = document.getElementById("expenseProperty").value;
  const vendor = document.getElementById("expenseVendor").value;
  const amount = parseFloat(document.getElementById("expenseAmount").value);
  const notes = document.getElementById("expenseNotes").value;

  if (!currentOwner || !property || !vendor || !amount) { alert("Fill all fields"); return; }

  expenses.push({ id: Date.now(), owner: currentOwner, type, property, vendor, amount, notes });
  localStorage.setItem("expenses", JSON.stringify(expenses));
  document.getElementById("expenseAmount").value = "";
  document.getElementById("expenseNotes").value = "";
  alert("Expense added!");
  console.log("Expense added:", vendor, amount);
}

// UTILS
function money(x) { return "$" + (Number(x) || 0).toFixed(2); }
function num(v) { return parseFloat((v || "0").toString().replace(/[$,]/g, "")) || 0; }

// REPORTS
function generateReport() {
  const file = document.getElementById("csvFile").files[0];
  if (!file) { alert("Upload CSV"); return; }
  if (!currentOwner) { alert("Select owner"); return; }

  const reader = new FileReader();
  reader.onload = (e) => {
    csvData = Papa.parse(e.target.result, { header: true, skipEmptyLines: true }).data;
    processData();
    displayReport();
  };
  reader.readAsText(file);
}

function processData() {
  const month = parseInt(document.getElementById("monthSelect").value);
  const year = parseInt(document.getElementById("yearSelect").value);
  const ownerData = OWNERS[currentOwner];
  const percent = ownerData.percent;
  const type = ownerData.type;

  propertyTotals = {};
  masterTotals = { gross: 0, acc: 0, clean: 0, pmc: 0, expenses: 0, draft: 0, owner: 0, websiteFee: 0 };
  properties = [];

  let grouped = {};

  csvData.forEach(row => {
    if (!row["CHECK-IN DATE"]) return;
    let m = parseInt(row["CHECK-IN DATE"].split("-")[1]);
    let y = parseInt(row["CHECK-IN DATE"].split("-")[0]);
    if (m !== month || y !== year) return;

    let listing = row["LISTING'S NICKNAME"] || "Unknown";
    if (!properties.includes(listing)) properties.push(listing);
    if (!grouped[listing]) grouped[listing] = [];
    grouped[listing].push(row);
  });

  updatePropertySelect();

  Object.keys(grouped).forEach(listing => {
    let pGross = 0, pAcc = 0, pClean = 0, pPMC = 0, pDraft = 0, pOwner = 0, pWebsiteFee = 0, pExpenses = 0;

    grouped[listing].forEach(row => {
      let payout = num(row["TOTAL PAYOUT"]);
      let acc = num(row["ACCOMMODATION FARE"]) - num(row["MARKUP"]);
      let clean = num(row["CLEANING FARE"]);
      let pmc = acc * percent;
      let draft = pmc + clean;
      let ownerPay = acc - pmc;

      let websiteFee = 0;
      if (type === "draft") {
        let code = row["CONFIRMATION CODE"] || "";
        let platform = row["PLATFORM"] || "";
        if (!code.toUpperCase().startsWith("HA") && platform.toLowerCase().includes("website")) {
          websiteFee = payout * 0.01;
        }
      }

      pGross += payout;
      pAcc += acc;
      pClean += clean;
      pPMC += pmc;
      pDraft += draft + websiteFee;
      pOwner += ownerPay;
      pWebsiteFee += websiteFee;
    });

    let propExpenses = expenses.filter(e => e.property === listing && e.owner === currentOwner).reduce((s, e) => s + e.amount, 0);
    pExpenses = propExpenses;

    propertyTotals[listing] = { gross: pGross, acc: pAcc, clean: pClean, pmc: pPMC, draft: pDraft, owner: pOwner, websiteFee: pWebsiteFee, expenses: pExpenses };

    masterTotals.gross += pGross;
    masterTotals.acc += pAcc;
    masterTotals.clean += pClean;
    masterTotals.pmc += pPMC;
    masterTotals.draft += pDraft;
    masterTotals.owner += pOwner;
    masterTotals.websiteFee += pWebsiteFee;
    masterTotals.expenses += pExpenses;
  });
}

function displayReport() {
  const month = parseInt(document.getElementById("monthSelect").value);
  const year = parseInt(document.getElementById("yearSelect").value);
  const type = OWNERS[currentOwner].type;

  let html = `
    <div class="header">
      <div>OCEAN VACATIONS</div>
      <div class="title">RESERVATION REPORT</div>
      <div style="font-size:13px;font-weight:bold">${currentOwner} (${type.toUpperCase()})</div>
      <div class="subtitle">Period: ${month}/1/${year}</div>
    </div>

    <div class="summary-grid">
      <div class="summary-card"><div class="summary-label">Gross Payout</div><div class="summary-value">${money(masterTotals.gross)}</div></div>
      <div class="summary-card"><div class="summary-label">Net Accommodation</div><div class="summary-value">${money(masterTotals.acc)}</div></div>
      <div class="summary-card"><div class="summary-label">PMC</div><div class="summary-value">${money(masterTotals.pmc)}</div></div>
      <div class="summary-card"><div class="summary-label">Cleaning Fee</div><div class="summary-value">${money(masterTotals.clean)}</div></div>
      ${type === "draft" ? `<div class="summary-card"><div class="summary-label">Website Fee</div><div class="summary-value">${money(masterTotals.websiteFee)}</div></div>` : ""}
      <div class="summary-card"><div class="summary-label">Expenses</div><div class="summary-value">${money(masterTotals.expenses)}</div></div>
      <div class="summary-card" style="background:#0066cc;color:#fff;border-color:#0066cc"><div class="summary-label" style="color:#fff">TOTAL PAYOUT</div><div class="summary-value" style="color:#fff">${money(type === "draft" ? masterTotals.draft - masterTotals.expenses : masterTotals.owner - masterTotals.expenses)}</div></div>
    </div>
  `;

  Object.keys(propertyTotals).forEach(prop => {
    let p = propertyTotals[prop];
    let finalPayout = type === "draft" ? p.draft - p.expenses : p.owner - p.expenses;

    html += `
      <div style="margin-top:30px;border:1px solid #ddd;padding:20px;border-radius:5px">
        <h3>${prop}</h3>
        <table>
          <tr><td>Gross Payout</td><td style="text-align:right;font-weight:bold">${money(p.gross)}</td></tr>
          <tr><td>Net Accommodation</td><td style="text-align:right;font-weight:bold">${money(p.acc)}</td></tr>
          <tr><td>PMC</td><td style="text-align:right;font-weight:bold">${money(p.pmc)}</td></tr>
          ${type === "draft" ? `<tr><td>Cleaning Fee</td><td style="text-align:right;font-weight:bold">${money(p.clean)}</td></tr>` : ""}
          ${type === "draft" ? `<tr><td>Website Fee</td><td style="text-align:right;font-weight:bold">${money(p.websiteFee)}</td></tr>` : ""}
          <tr><td>Expenses</td><td style="text-align:right;font-weight:bold">${money(p.expenses)}</td></tr>
          <tr style="background:#333;color:#fff"><td><strong>TOTAL PAYOUT</strong></td><td style="text-align:right"><strong>${money(finalPayout)}</strong></td></tr>
        </table>
      </div>
    `;
  });

  document.getElementById("content").innerHTML = html;
  console.log("Report displayed");
}

function generateSummary() {
  if (!csvData || csvData.length === 0) { alert("Run report first"); return; }

  const month = parseInt(document.getElementById("monthSelect").value);
  const year = parseInt(document.getElementById("yearSelect").value);
  const type = OWNERS[currentOwner].type;
  const salesPercent = OWNERS[currentOwner].salesFeePercent;
  const finalPayout = type === "draft" ? masterTotals.draft - masterTotals.expenses : masterTotals.owner - masterTotals.expenses;
  const salesAmount = masterTotals.pmc * (salesPercent / 100);

  let html = `
    <button class="btn back-btn" onclick="generateReport()">‚Üê Back</button>
    <div class="header">
      <div class="title">SUMMARY REPORT</div>
      <div class="subtitle">${currentOwner} (${type.toUpperCase()}) | ${month}/${year}</div>
    </div>

    <div style="background:#f9f9f9;border:2px solid #333;padding:20px;border-radius:5px;margin:20px 0">
      <h3 style="margin-bottom:15px">üí∞ Accommodation & Sales</h3>
      <table>
        <tr><td style="font-weight:bold">Total Accommodation</td><td style="text-align:right;font-weight:bold">${money(masterTotals.acc)}</td></tr>
        <tr><td style="font-weight:bold">PMC Amount</td><td style="text-align:right;font-weight:bold">${money(masterTotals.pmc)}</td></tr>
        <tr><td style="font-weight:bold">Sales Fee Rate</td><td style="text-align:right;font-weight:bold">${salesPercent}%</td></tr>
        <tr style="background:#333;color:#fff"><td><strong>Sales Amount Due</strong></td><td style="text-align:right"><strong>${money(salesAmount)}</strong></td></tr>
      </table>
    </div>

    <div style="background:#f9f9f9;border:2px solid #333;padding:20px;border-radius:5px;margin:20px 0">
      <h3 style="margin-bottom:15px">üí≥ Payment Info</h3>
      <table>
        <tr><td>Owner</td><td style="text-align:right;font-weight:bold">${currentOwner}</td></tr>
        <tr><td>Type</td><td style="text-align:right;font-weight:bold">${type.toUpperCase()}</td></tr>
        <tr><td>Gross Payout</td><td style="text-align:right;font-weight:bold">${money(masterTotals.gross)}</td></tr>
        <tr><td>Expenses</td><td style="text-align:right;font-weight:bold">${money(masterTotals.expenses)}</td></tr>
        <tr style="background:#0066cc;color:#fff;font-size:13px"><td><strong>NET PAYOUT</strong></td><td style="text-align:right"><strong>${money(finalPayout)}</strong></td></tr>
      </table>
    </div>

    <button class="btn print-btn" onclick="window.print()">üñ®Ô∏è Print</button>
  `;

  document.getElementById("content").innerHTML = html;
}

function generateAnnual() {
  const type = OWNERS[currentOwner].type;
  if (type !== "payout") { alert("Annual Report for PAYOUT owners only"); return; }

  const year = parseInt(document.getElementById("yearSelect").value);

  let html = `
    <button class="btn back-btn" onclick="generateReport()">‚Üê Back</button>
    <div class="header">
      <div class="title">ANNUAL REPORT - ${year}</div>
      <div class="subtitle">${currentOwner}</div>
    </div>

    <div style="background:#f9f9f9;border:2px solid #333;padding:20px;border-radius:5px;margin:20px 0">
      <h3 style="margin-bottom:15px">üìä Annual Summary</h3>
      <table>
        <tr><td>Total Accommodation</td><td style="text-align:right;font-weight:bold">${money(masterTotals.acc)}</td></tr>
        <tr><td>PMC Charged</td><td style="text-align:right;font-weight:bold">${money(masterTotals.pmc)}</td></tr>
        <tr><td>Total Expenses</td><td style="text-align:right;font-weight:bold">${money(masterTotals.expenses)}</td></tr>
        <tr style="background:#0066cc;color:#fff;font-size:13px"><td><strong>NET ANNUAL AMOUNT</strong></td><td style="text-align:right"><strong>${money(masterTotals.owner - masterTotals.expenses)}</strong></td></tr>
      </table>
    </div>

    <button class="btn print-btn" onclick="window.print()">üñ®Ô∏è Print</button>
  `;

  document.getElementById("content").innerHTML = html;
}

function downloadPDF() {
  if (!csvData || csvData.length === 0) { alert("Run report first"); return; }
  html2pdf().set({ margin: 10, jsPDF: { unit: "mm", format: "a4" } }).from(document.getElementById("content")).save("Report.pdf");
}

</script>

</body>
</html>
