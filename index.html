<!DOCTYPE html>
<html>
<head>
<title>Ocean Vacations - Reservation Report</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial;background:#f5f5f5;color:#000;display:flex}
.sidebar{width:280px;background:#333;color:#fff;padding:20px;height:100vh;overflow-y:auto;position:fixed;left:0;top:0}
.sidebar h3{margin-bottom:20px;font-size:16px;border-bottom:2px solid #fff;padding-bottom:10px}
.section{margin-bottom:20px}
.label{font-size:11px;font-weight:bold;color:#aaa;margin-bottom:5px;display:block}
select,input{width:100%;padding:8px;margin:5px 0;border:1px solid #555;background:#444;color:#fff;border-radius:3px;font-size:11px}
.btn{width:100%;padding:12px;margin:8px 0;border:none;font-weight:bold;border-radius:3px;cursor:pointer;font-size:12px;color:#fff;transition:all 0.3s}
.btn-primary{background:#000}.btn-primary:hover{background:#222}
.btn-success{background:#28a745}.btn-success:hover{background:#218838}
.btn-warning{background:#ff9800}.btn-warning:hover{background:#e68900}
.btn-info{background:#17a2b8}.btn-info:hover{background:#138496}
.btn-danger{background:#dc3545}.btn-danger:hover{background:#c82333}
.main{margin-left:280px;padding:20px;width:calc(100% - 280px)}
.page{background:#fff;padding:40px;border-radius:5px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
.hidden{display:none}
.invoice-header{display:flex;justify-content:space-between;margin-bottom:40px;border-bottom:2px solid #000;padding-bottom:30px}
.company-info{font-size:11px;line-height:1.8}
.company-name{font-size:20px;font-weight:bold;margin-bottom:5px}
.right-header{text-align:right;font-size:11px;line-height:1.8}
.statement-date{margin-bottom:20px;font-weight:bold}
.period-date{margin-top:10px}
.report-title{text-align:center;font-size:32px;font-weight:bold;margin:40px 0 10px 0;letter-spacing:2px}
.owner-name{text-align:center;font-size:16px;margin-bottom:40px}
table{width:100%;border-collapse:collapse;margin:20px 0;font-size:11px}
th,td{border:1px solid #e0e0e0;padding:12px;text-align:left}
th{background:#f5f5f5;color:#000;font-weight:bold;text-align:center;text-transform:uppercase}
tr:nth-child(even){background:#fafafa}
.back-btn{margin:20px 0;background:#666}
.back-btn:hover{background:#555}
.print-btn{background:#e74c3c}
.print-btn:hover{background:#c0392b}
.property-section{margin:40px 0;padding:20px;border:1px solid #ddd;border-radius:5px;background:#fff}
.property-title{font-size:14px;font-weight:bold;margin-bottom:15px;display:flex;align-items:center;text-transform:uppercase;text-align:center;justify-content:center}
.property-icon{font-size:18px;margin-right:10px}
.summary-title{font-size:12px;font-weight:bold;text-transform:uppercase;text-align:center;margin:20px 0}
.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin:20px 0}
.summary-card{background:#f9f9f9;border:1px solid #ddd;padding:12px;text-align:center;border-radius:5px}
.summary-label{font-size:10px;color:#666;font-weight:bold;text-transform:uppercase}
.summary-value{font-size:14px;font-weight:bold;color:#000;margin-top:6px}
.attachment{background:#f0f0f0;padding:10px;margin:10px 0;border-radius:3px;font-size:10px;display:flex;justify-content:space-between;align-items:center}
.attachment-left{flex:1}
.attachment-link{color:#0066cc;cursor:pointer;text-decoration:underline;margin-right:10px}
.attachment-file{background:#e8f4f8;padding:8px;margin:8px 0;border-left:3px solid #17a2b8;border-radius:3px;display:flex;justify-content:space-between;align-items:center}
.file-info{flex:1}
.file-name{font-weight:bold;color:#0c5460}
.file-download{color:#0066cc;cursor:pointer;text-decoration:underline;font-size:9px}
.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5)}
.modal-content{background:#fff;margin:10% auto;padding:20px;border:1px solid #888;width:80%;max-width:600px;border-radius:5px;max-height:80vh;overflow-y:auto}
.modal-close{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}
.modal-close:hover{color:#000}
.tax-table{width:100%;border-collapse:collapse;font-size:11px;margin-top:10px}
.tax-table th,.tax-table td{border:1px solid #000;padding:8px;text-align:left}
.tax-table th{background:#333;color:#fff;font-weight:bold;text-align:center;text-transform:uppercase}
.tax-table tr:nth-child(even){background:#f9f9f9}
.tax-table .tax-amount{text-align:right;font-weight:bold}
.tax-info{background:#e8f4f8;border:2px solid #17a2b8;padding:15px;margin:15px 0;border-radius:5px}
.tax-info-title{font-size:14px;font-weight:bold;color:#0c5460;margin-bottom:10px;text-transform:uppercase;text-align:center}
.history-row{display:flex;justify-content:space-between;align-items:center;background:#f0f0f0;padding:12px;margin:8px 0;border-radius:3px}
.history-info{flex:1;font-size:11px}
.history-actions{display:flex;gap:8px}
.history-actions button{padding:5px 10px;font-size:9px;cursor:pointer;border:none;border-radius:3px;color:#fff}
.section-title{font-size:12px;font-weight:bold;text-transform:uppercase;margin-top:20px;margin-bottom:10px;color:#000}
.property-settings-box{margin-bottom:20px;padding:15px;background:#f0f0f0;border-radius:3px;border-left:4px solid #17a2b8}
.property-name-label{font-weight:bold;color:#000;margin-bottom:10px;display:block;text-transform:uppercase}
.checkbox-group{display:flex;flex-wrap:wrap;gap:15px;align-items:center}
.checkbox-item{display:flex;align-items:center;gap:8px}
.checkbox-item input[type="checkbox"]{width:18px;height:18px;cursor:pointer;accent-color:#17a2b8}
.checkbox-item label{color:#000;font-weight:bold;cursor:pointer;margin:0}
@media print{.sidebar,.back-btn,.print-btn{display:none}.main{margin-left:0;width:100%}.page{padding:20px}}
</style>
</head>
<body>

<div class="sidebar">
<h3>üéØ OCEAN VACATIONS</h3>

<div class="section">
<label class="label">Select Owner</label>
<select id="ownerSelect" onchange="onOwnerChange()">
<option value="">-- Select Owner --</option>
</select>
</div>

<div class="section">
<label class="label">Month</label>
<select id="monthSelect"></select>
</div>

<div class="section">
<label class="label">Year</label>
<select id="yearSelect"></select>
</div>

<div class="section">
<label class="label">Upload CSV</label>
<input type="file" id="csvFile" accept=".csv">
</div>

<button class="btn btn-primary" onclick="generateStatement()">‚ñ∂ STATEMENT</button>
<button class="btn btn-success" onclick="generateSummary()">üìä View Summary</button>
<button class="btn btn-warning" onclick="generateAnnual()">üìà Annual Report</button>
<button class="btn btn-info" onclick="downloadPDF()">üì• Download PDF</button>
<button class="btn btn-info" onclick="viewHistory()">üìã View History</button>

<hr style="border:1px solid #555;margin:20px 0">

<button class="btn btn-info" onclick="openPropertySettings()" style="font-size:11px">‚öôÔ∏è Property Tax Settings</button>

<hr style="border:1px solid #555;margin:20px 0">

<h4 style="color:#fff;margin-bottom:10px">üè¢ Vendors</h4>
<input type="text" id="vendorName" placeholder="Vendor name">
<input type="text" id="vendorPhone" placeholder="Phone/Email">
<button class="btn btn-success" onclick="addVendor()" style="font-size:11px">Add Vendor</button>
<button class="btn btn-warning" onclick="showVendorModal()" style="font-size:11px">View/Manage</button>

<hr style="border:1px solid #555;margin:20px 0">

<h4 style="color:#fff;margin-bottom:10px">üí∞ Add Expense</h4>
<select id="expenseType">
<option>Maintenance</option>
<option>Repair</option>
<option>Purchase</option>
<option>Supplies</option>
<option>Service</option>
<option>Pool Cleaning</option>
<option>Pest Control</option>
<option>Credit</option>
<option>Adjustment</option>
</select>
<select id="expenseProperty"></select>
<select id="expenseVendor"></select>
<input type="number" id="expenseAmount" placeholder="Amount" step="0.01">
<input type="text" id="expenseNotes" placeholder="Notes">
<label class="label" style="margin-top:10px">Attachment (JPG/PDF)</label>
<input type="file" id="expenseFile" accept=".jpg,.jpeg,.pdf">
<button class="btn btn-success" onclick="addExpense()" style="font-size:11px">Add Expense</button>

</div>

<!-- VENDOR MODAL -->
<div id="vendorModal" class="modal">
<div class="modal-content">
<span class="modal-close" onclick="closeVendorModal()">&times;</span>
<h2>Manage Vendors</h2>
<div id="vendorListModal" style="margin-top:20px;max-height:400px;overflow-y:auto"></div>
</div>
</div>

<!-- PROPERTY SETTINGS MODAL -->
<div id="propertySettingsModal" class="modal">
<div class="modal-content">
<span class="modal-close" onclick="closePropertySettings()">&times;</span>
<h2 style="text-transform:uppercase;text-align:center">PROPERTY TAX SETTINGS</h2>
<div id="propertySettingsContent" style="margin-top:20px;max-height:600px;overflow-y:auto"></div>
</div>
</div>

<div class="main">
<div id="content" class="page">
<div class="invoice-header">
<div class="company-info">
<div class="company-name">OCEAN VACATIONS</div>
<div>www.oceanvacationsmb.com</div>
<div>oceanvacationsmb@gmail.com</div>
<div>843-222-6516</div>
</div>
<div class="right-header">
<div class="statement-date" id="statementDate"></div>
<div class="period-date" id="periodDate"></div>
</div>
</div>

<div class="report-title">RESERVATION REPORT</div>
<div class="owner-name" id="ownerTitle"></div>

<div id="mainContent">
<div style="text-align:center;padding:40px;color:#666">
Select an owner and upload a CSV file to get started
</div>
</div>
</div>
</div>

<script>

// DATABASE
let db;

function initDB() {
  return new Promise((resolve) => {
    const request = indexedDB.open("OceanVacationsDB", 1);
    request.onupgradeneeded = (e) => {
      db = e.target.result;
      if (!db.objectStoreNames.contains("vendors")) db.createObjectStore("vendors", { keyPath: "id" });
      if (!db.objectStoreNames.contains("expenses")) db.createObjectStore("expenses", { keyPath: "id" });
      if (!db.objectStoreNames.contains("statements")) db.createObjectStore("statements", { keyPath: "id" });
      if (!db.objectStoreNames.contains("properties")) db.createObjectStore("properties", { keyPath: "name" });
    };
    request.onsuccess = () => {
      db = request.result;
      resolve();
    };
  });
}

function saveDB(store, data) {
  const tx = db.transaction([store], "readwrite");
  tx.objectStore(store).put(data);
}

function getDB(store) {
  return new Promise((resolve) => {
    const tx = db.transaction([store], "readonly");
    const request = tx.objectStore(store).getAll();
    request.onsuccess = () => resolve(request.result);
  });
}

function deleteDB(store, id) {
  const tx = db.transaction([store], "readwrite");
  tx.objectStore(store).delete(id);
}

// DATA - ALL 13 OWNERS
const OWNERS = {
  "ERAN": { percent: 0.12, type: "draft", salesFeePercent: 5 },
  "GHO": { percent: 0.10, type: "payout", salesFeePercent: 5 },
  "1463 Basin Trail": { percent: 0.12, type: "payout", salesFeePercent: 5 },
  "113B-15S Surfside Beach": { percent: 0.12, type: "payout", salesFeePercent: 5 },
  "113B-13N Surfside Beach": { percent: 0.12, type: "payout", salesFeePercent: 5 },
  "115C-15N Surfside Beach": { percent: 0.12, type: "payout", salesFeePercent: 5 },
  "2131 Sanibel Myrtle Beach": { percent: 0.15, type: "payout", salesFeePercent: 5 },
  "1552 Elizabeth Ln Myrtle Beach": { percent: 0.15, type: "payout", salesFeePercent: 5 },
  "469C White River RD Myrtle Beach": { percent: 0.12, type: "payout", salesFeePercent: 5 },
  "4631-301 Wild Iris Drive Myrtle Beach": { percent: 0.12, type: "payout", salesFeePercent: 5 },
  "4679-204 Wild Iris Drive Myrtle Beach": { percent: 0.12, type: "payout", salesFeePercent: 5 },
  "508-1/2 33rd Ave North Myrtle Beach": { percent: 0.15, type: "payout", salesFeePercent: 10 },
  "214-2S 2nd Ave S. North Myrtle Beach": { percent: 0.12, type: "payout", salesFeePercent: 10 }
};

let vendors = [];
let expenses = [];
let csvData = [];
let properties = [];
let propertySettings = {};
let currentOwner = "";
let masterTotals = {};
let propertyTotals = {};
let taxByProperty = {};

const municipalities = ["SC", "MB", "NMB", "SSB", "HC"];

// INIT
document.addEventListener("DOMContentLoaded", async function() {
  await initDB();
  await loadPropertySettings();
  await loadVendors();
  await loadExpenses();
  initOwners();
  initMonths();
  initYears();
  updateVendorList();
});

async function loadPropertySettings() {
  const saved = await getDB("properties");
  saved.forEach(prop => {
    propertySettings[prop.name] = prop;
  });
}

function savePropertySettings() {
  Object.entries(propertySettings).forEach(([name, data]) => {
    saveDB("properties", { name, ...data });
  });
}

function initOwners() {
  const select = document.getElementById("ownerSelect");
  select.innerHTML = '<option value="">-- Select Owner --</option>';
  Object.keys(OWNERS).sort().forEach(owner => {
    const opt = document.createElement("option");
    opt.value = owner;
    opt.textContent = owner;
    select.appendChild(opt);
  });
}

function initMonths() {
  const select = document.getElementById("monthSelect");
  const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  months.forEach((m, i) => {
    const opt = document.createElement("option");
    opt.value = i + 1;
    opt.textContent = m;
    select.appendChild(opt);
  });
  select.value = new Date().getMonth() + 1;
}

function initYears() {
  const select = document.getElementById("yearSelect");
  const year = new Date().getFullYear();
  for (let y = year - 2; y <= year + 2; y++) {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    select.appendChild(opt);
  }
  select.value = year;
}

function onOwnerChange() {
  currentOwner = document.getElementById("ownerSelect").value;
  if (currentOwner) updatePropertySelect();
}

function getNextMonth(month, year) {
  let nextMonth = month + 1;
  let nextYear = year;
  if (nextMonth > 12) {
    nextMonth = 1;
    nextYear++;
  }
  return { month: nextMonth, year: nextYear };
}

function getMonthName(month) {
  const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  return months[month - 1];
}

function updateHeaderDates() {
  const month = parseInt(document.getElementById("monthSelect").value);
  const year = parseInt(document.getElementById("yearSelect").value);
  const next = getNextMonth(month, year);
  const daysInMonth = new Date(year, month, 0).getDate();

  document.getElementById("statementDate").innerHTML = `Statement Date:<br><strong>${getMonthName(next.month)} 1st ${next.year}</strong>`;
  document.getElementById("periodDate").innerHTML = `Period: ${getMonthName(month)} 1st - ${daysInMonth}th ${year}`;
  document.getElementById("ownerTitle").textContent = currentOwner.toUpperCase();
}

// PROPERTY SETTINGS
function openPropertySettings() {
  const modal = document.getElementById("propertySettingsModal");
  const content = document.getElementById("propertySettingsContent");

  let html = `<div>`;
  
  Object.keys(OWNERS).sort().forEach(propName => {
    const settings = propertySettings[propName] || { name: propName, municipalities: {} };
    
    html += `
      <div class="property-settings-box">
        <span class="property-name-label">${propName}</span>
        <div class="checkbox-group">
          ${municipalities.map(mun => `
            <div class="checkbox-item">
              <input type="checkbox" 
                id="mun_${propName}_${mun}" 
                ${settings.municipalities && settings.municipalities[mun] ? 'checked' : ''} 
                onchange="
                  if(!propertySettings['${propName}']) propertySettings['${propName}'] = {name: '${propName}', municipalities: {}};
                  if(!propertySettings['${propName}'].municipalities) propertySettings['${propName}'].municipalities = {};
                  propertySettings['${propName}'].municipalities['${mun}'] = this.checked;
                  savePropertySettings();
                ">
              <label for="mun_${propName}_${mun}">${mun}</label>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  });

  html += `</div>`;
  content.innerHTML = html;
  modal.style.display = "block";
}

function closePropertySettings() {
  document.getElementById("propertySettingsModal").style.display = "none";
}

// VENDORS
async function loadVendors() {
  vendors = await getDB("vendors");
}

async function addVendor() {
  const name = document.getElementById("vendorName").value.trim();
  const phone = document.getElementById("vendorPhone").value.trim();
  if (!name) { alert("Enter vendor name"); return; }
  const vendor = { id: Date.now(), name, phone };
  vendors.push(vendor);
  saveDB("vendors", vendor);
  updateVendorList();
  document.getElementById("vendorName").value = "";
  document.getElementById("vendorPhone").value = "";
}

async function deleteVendor(id) {
  vendors = vendors.filter(v => v.id !== id);
  deleteDB("vendors", id);
  updateVendorList();
  updateExpenseVendorSelect();
}

function updateVendorList() {
  const select = document.getElementById("expenseVendor");
  select.innerHTML = '<option value="">-- Select Vendor --</option>';
  vendors.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v.name;
    opt.textContent = v.name;
    select.appendChild(opt);
  });
}

function showVendorModal() {
  const modal = document.getElementById("vendorModal");
  const list = document.getElementById("vendorListModal");
  if (vendors.length === 0) {
    list.innerHTML = '<p>No vendors yet</p>';
  } else {
    list.innerHTML = vendors.map(v => `
      <div style="background:#f0f0f0;padding:15px;margin:10px 0;border-radius:3px;display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>${v.name}</strong><br>
          <span style="color:#666;font-size:11px">${v.phone}</span>
        </div>
        <button onclick="deleteVendor(${v.id})" class="btn btn-danger" style="width:80px;margin:0;padding:5px">Delete</button>
      </div>
    `).join("");
  }
  modal.style.display = "block";
}

function closeVendorModal() {
  document.getElementById("vendorModal").style.display = "none";
}

function updateExpenseVendorSelect() {
  const select = document.getElementById("expenseVendor");
  select.innerHTML = '<option value="">-- Select Vendor --</option>';
  vendors.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v.name;
    opt.textContent = v.name;
    select.appendChild(opt);
  });
}

function updatePropertySelect() {
  const select = document.getElementById("expenseProperty");
  select.innerHTML = '<option value="">-- Select Property --</option>';
  properties.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    select.appendChild(opt);
  });
}

// EXPENSES
async function loadExpenses() {
  expenses = await getDB("expenses");
}

async function addExpense() {
  const type = document.getElementById("expenseType").value;
  const property = document.getElementById("expenseProperty").value;
  const vendor = document.getElementById("expenseVendor").value;
  const amount = parseFloat(document.getElementById("expenseAmount").value);
  const notes = document.getElementById("expenseNotes").value;
  const fileInput = document.getElementById("expenseFile");

  if (!currentOwner || !property || !vendor || !amount) { alert("Fill all required fields"); return; }

  const expense = { 
    id: Date.now(), 
    owner: currentOwner, 
    type, 
    property, 
    vendor, 
    amount, 
    notes,
    file: null
  };

  if (fileInput.files.length > 0) {
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = (e) => {
      expense.file = {
        name: file.name,
        type: file.type,
        data: e.target.result
      };
      expenses.push(expense);
      saveDB("expenses", expense);
      resetExpenseForm();
    };
    reader.readAsArrayBuffer(file);
  } else {
    expenses.push(expense);
    saveDB("expenses", expense);
    resetExpenseForm();
  }
}

async function deleteExpense(id) {
  if (confirm("Delete this expense?")) {
    expenses = expenses.filter(e => e.id !== id);
    deleteDB("expenses", id);
    generateStatement();
  }
}

function resetExpenseForm() {
  document.getElementById("expenseAmount").value = "";
  document.getElementById("expenseNotes").value = "";
  document.getElementById("expenseFile").value = "";
  document.getElementById("expenseProperty").value = "";
}

function downloadExpenseFile(expenseId) {
  const expense = expenses.find(e => e.id === expenseId);
  if (expense && expense.file) {
    const blob = new Blob([expense.file.data], { type: expense.file.type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = expense.file.name;
    a.click();
    URL.revokeObjectURL(url);
  }
}

// UTILS
function money(x) { return "$" + (Number(x) || 0).toFixed(2); }
function num(v) { return parseFloat((v || "0").toString().replace(/[$,]/g, "")) || 0; }

// STATEMENTS
async function generateStatement() {
  const file = document.getElementById("csvFile").files[0];
  if (!file) { alert("Upload CSV"); return; }
  if (!currentOwner) { alert("Select owner"); return; }

  updateHeaderDates();

  const reader = new FileReader();
  reader.onload = (e) => {
    csvData = Papa.parse(e.target.result, { header: true, skipEmptyLines: true }).data;
    processData();
    displayStatement();
  };
  reader.readAsText(file);
}

function processData() {
  const month = parseInt(document.getElementById("monthSelect").value);
  const year = parseInt(document.getElementById("yearSelect").value);
  const ownerData = OWNERS[currentOwner];
  const percent = ownerData.percent;
  const type = ownerData.type;

  propertyTotals = {};
  masterTotals = { gross: 0, acc: 0, clean: 0, pmc: 0, expenses: 0, draft: 0, owner: 0, websiteFee: 0 };
  taxByProperty = {};
  properties = [];

  let grouped = {};

  csvData.forEach(row => {
    if (!row["CHECK-IN DATE"]) return;
    let m = parseInt(row["CHECK-IN DATE"].split("-")[1]);
    let y = parseInt(row["CHECK-IN DATE"].split("-")[0]);
    if (m !== month || y !== year) return;

    let listing = row["LISTING'S NICKNAME"] || "Unknown";
    if (!properties.includes(listing)) properties.push(listing);
    if (!grouped[listing]) grouped[listing] = [];
    grouped[listing].push(row);
  });

  updatePropertySelect();

  Object.keys(grouped).forEach(listing => {
    let pGross = 0, pAcc = 0, pClean = 0, pPMC = 0, pWebsiteFee = 0, pExpenses = 0;

    grouped[listing].forEach(row => {
      let payout = num(row["TOTAL PAYOUT"]);
      let acc = num(row["ACCOMMODATION FARE"]) - num(row["MARKUP"]);
      let status = (row["STATUS"] || "").toLowerCase();
      let isCancelled = status.includes("cancelled");
      
      let clean = isCancelled ? 0 : num(row["CLEANING FARE"]);
      let pmc = acc * percent;

      let websiteFee = 0;
      if (type === "draft" && acc > 0) {
        let code = row["CONFIRMATION CODE"] || "";
        let platform = row["PLATFORM"] || "";
        if (!code.toUpperCase().startsWith("HA") && (platform.toLowerCase().includes("website") || platform.toLowerCase().includes("manual"))) {
          websiteFee = payout * 0.01;
        }
      }

      pGross += payout;
      pAcc += acc;
      pClean += clean;
      pPMC += pmc;
      pWebsiteFee += websiteFee;

      if (type === "payout") {
        let cityTax = num(row["CITY TAX"]) || 0;
        let stateTax = num(row["STATE TAX"]) || 0;
        let countyTax = num(row["COUNTY TAX"]) || 0;
        let occupancyTax = num(row["OCCUPANCY TAX"]) || 0;
        if (cityTax > 0 || stateTax > 0 || countyTax > 0 || occupancyTax > 0) {
          if (!taxByProperty[listing]) taxByProperty[listing] = 0;
          taxByProperty[listing] += payout;
        }
      }
    });

    let propExpenses = expenses.filter(e => e.property === listing && e.owner === currentOwner).reduce((s, e) => s + e.amount, 0);
    pExpenses = propExpenses;

    let draftAmount = pPMC + pClean + pWebsiteFee + pExpenses;
    let payoutAmount = pAcc - pPMC - pExpenses;

    propertyTotals[listing] = { 
      gross: pGross,
      acc: pAcc, 
      clean: pClean, 
      pmc: pPMC, 
      websiteFee: pWebsiteFee, 
      expenses: pExpenses, 
      draft: draftAmount,
      owner: payoutAmount,
      reservations: grouped[listing] 
    };

    masterTotals.gross += pGross;
    masterTotals.acc += pAcc;
    masterTotals.clean += pClean;
    masterTotals.pmc += pPMC;
    masterTotals.websiteFee += pWebsiteFee;
    masterTotals.expenses += pExpenses;
    masterTotals.draft += draftAmount;
    masterTotals.owner += payoutAmount;
  });
}

function displayStatement() {
  const type = OWNERS[currentOwner].type;

  let html = `
    <div class="summary-title">FINANCIAL SUMMARY</div>
    <div class="summary-grid">
      ${type === "draft" ? `
        <div class="summary-card"><div class="summary-label">Gross Payout</div><div class="summary-value">${money(masterTotals.gross)}</div></div>
        <div class="summary-card"><div class="summary-label">Accommodation</div><div class="summary-value">${money(masterTotals.acc)}</div></div>
        <div class="summary-card"><div class="summary-label">PMC</div><div class="summary-value">${money(masterTotals.pmc)}</div></div>
        <div class="summary-card"><div class="summary-label">Cleaning Fee</div><div class="summary-value">${money(masterTotals.clean)}</div></div>
        <div class="summary-card"><div class="summary-label">Website (1%)</div><div class="summary-value">${money(masterTotals.websiteFee)}</div></div>
        <div class="summary-card"><div class="summary-label">Expenses</div><div class="summary-value">${money(masterTotals.expenses)}</div></div>
        <div class="summary-card" style="background:#000;color:#fff;border-color:#000"><div class="summary-label" style="color:#fff">OWNER DUE</div><div class="summary-value" style="color:#fff">${money(masterTotals.draft)}</div></div>
      ` : `
        <div class="summary-card"><div class="summary-label">Accommodation</div><div class="summary-value">${money(masterTotals.acc)}</div></div>
        <div class="summary-card"><div class="summary-label">PMC</div><div class="summary-value">${money(masterTotals.pmc)}</div></div>
        <div class="summary-card"><div class="summary-label">Expenses</div><div class="summary-value">${money(masterTotals.expenses)}</div></div>
        <div class="summary-card" style="background:#000;color:#fff;border-color:#000"><div class="summary-label" style="color:#fff">OWNER PAYOUT</div><div class="summary-value" style="color:#fff">${money(masterTotals.owner)}</div></div>
      `}
    </div>
  `;

  Object.keys(propertyTotals).forEach(prop => {
    let p = propertyTotals[prop];
    let finalPayout = type === "draft" ? p.draft : p.owner;
    let propExpenseList = expenses.filter(e => e.property === prop && e.owner === currentOwner);

    html += `
      <div class="property-section">
        <div class="property-title">
          <span class="property-icon">üè†</span>
          ${prop.toUpperCase()}
        </div>
        
        <div class="summary-grid">
          ${type === "draft" ? `
            <div class="summary-card"><div class="summary-label">Gross Payout</div><div class="summary-value">${money(p.gross)}</div></div>
            <div class="summary-card"><div class="summary-label">Accommodation</div><div class="summary-value">${money(p.acc)}</div></div>
            <div class="summary-card"><div class="summary-label">PMC</div><div class="summary-value">${money(p.pmc)}</div></div>
            <div class="summary-card"><div class="summary-label">Cleaning Fee</div><div class="summary-value">${money(p.clean)}</div></div>
            <div class="summary-card"><div class="summary-label">Website (1%)</div><div class="summary-value">${money(p.websiteFee)}</div></div>
            <div class="summary-card"><div class="summary-label">Expenses</div><div class="summary-value">${money(p.expenses)}</div></div>
            <div class="summary-card" style="background:#000;color:#fff;border-color:#000"><div class="summary-label" style="color:#fff">OWNER DUE</div><div class="summary-value" style="color:#fff">${money(finalPayout)}</div></div>
          ` : `
            <div class="summary-card"><div class="summary-label">Accommodation</div><div class="summary-value">${money(p.acc)}</div></div>
            <div class="summary-card"><div class="summary-label">PMC</div><div class="summary-value">${money(p.pmc)}</div></div>
            <div class="summary-card"><div class="summary-label">Expenses</div><div class="summary-value">${money(p.expenses)}</div></div>
            <div class="summary-card" style="background:#000;color:#fff;border-color:#000"><div class="summary-label" style="color:#fff">OWNER PAYOUT</div><div class="summary-value" style="color:#fff">${money(finalPayout)}</div></div>
          `}
        </div>

        ${propExpenseList.length > 0 ? `
        <div style="margin-top:15px">
          <div class="section-title">EXPENSES & ATTACHMENTS</div>
          ${propExpenseList.map(e => `
            <div class="attachment">
              <div class="attachment-left">
                <strong>${e.type}</strong> - ${e.vendor}: ${money(e.amount)}
                ${e.notes ? `<br><span style="color:#666">Notes: ${e.notes}</span>` : ""}
                ${e.file ? `
                  <div class="attachment-file">
                    <div class="file-info">
                      <div class="file-name">üìé ${e.file.name}</div>
                    </div>
                    <span class="file-download" onclick="downloadExpenseFile(${e.id})">Download</span>
                  </div>
                ` : ""}
              </div>
              <button onclick="deleteExpense(${e.id})" class="btn btn-danger" style="width:60px;margin:0;padding:3px;font-size:9px">Delete</button>
            </div>
          `).join("")}
        </div>
        ` : ""}

        <div style="margin-top:15px">
          <div class="section-title">RESERVATIONS</div>
          <table style="margin-top:10px">
            ${type === "draft" ? `
            <tr><th>Confirmation</th><th>Stay</th><th>Platform</th><th>Gross Payout</th><th>Accommodation</th><th>PMC</th><th>Cleaning Fee</th><th>Website (1%)</th><th>Owner Due</th></tr>
            ${p.reservations.map(r => {
              let acc = num(r["ACCOMMODATION FARE"]) - num(r["MARKUP"]);
              let payout = num(r["TOTAL PAYOUT"]);
              let status = (r["STATUS"] || "").toLowerCase();
              let isCancelled = status.includes("cancelled");
              let clean = isCancelled ? 0 : num(r["CLEANING FARE"]);
              let percent = OWNERS[currentOwner].percent;
              let pmc = acc * percent;
              let code = r["CONFIRMATION CODE"] || "";
              let platform = r["PLATFORM"] || "";
              let isVRBO = code.toUpperCase().startsWith("HA");
              
              let displayPlat = isVRBO ? "VRBO" : platform;
              if (displayPlat.toLowerCase().includes("manual")) {
                displayPlat = displayPlat.replace(/manual/gi, "Website (1%)");
              } else if (displayPlat.toLowerCase().includes("website") && !isVRBO) {
                displayPlat = "Website (1%)";
              }
              
              let websiteFee = 0;
              if (acc > 0) {
                if (!isVRBO && (platform.toLowerCase().includes("website") || platform.toLowerCase().includes("manual"))) {
                  websiteFee = payout * 0.01;
                }
              }
              
              let totalDue = pmc + clean + websiteFee;
              
              let checkin = r["CHECK-IN DATE"] ? r["CHECK-IN DATE"].split("-").slice(1).join("/") : "";
              let checkout = r["CHECK-OUT DATE"] ? r["CHECK-OUT DATE"].split("-").slice(1).join("/") : "";

              if (payout === 0 && clean === 0) return "";

              return `
                <tr>
                  <td>${code.substring(0,8)}</td>
                  <td>${checkin} - ${checkout}</td>
                  <td>${displayPlat}</td>
                  <td>${money(payout)}</td>
                  <td>${money(acc)}</td>
                  <td>${money(pmc)}</td>
                  <td>${money(clean)}</td>
                  <td>${money(websiteFee)}</td>
                  <td>${money(totalDue)}</td>
                </tr>
              `;
            }).join("")}
            ` : `
            <tr><th>Confirmation</th><th>Platform</th><th>Stay</th><th>Accommodation</th><th>PMC</th><th>Expenses</th><th>Owner Payout</th></tr>
            ${p.reservations.map(r => {
              let acc = num(r["ACCOMMODATION FARE"]) - num(r["MARKUP"]);
              let payout = num(r["TOTAL PAYOUT"]);
              let status = (r["STATUS"] || "").toLowerCase();
              let isCancelled = status.includes("cancelled");
              let percent = OWNERS[currentOwner].percent;
              let pmc = acc * percent;
              let code = r["CONFIRMATION CODE"] || "";
              let platform = r["PLATFORM"] || "";
              let isVRBO = code.toUpperCase().startsWith("HA");
              
              let displayPlat = isVRBO ? "VRBO" : platform;
              if (displayPlat.toLowerCase().includes("manual")) {
                displayPlat = displayPlat.replace(/manual/gi, "website");
              }
              
              let reservationExpenses = 0;
              let ownerPayoutPerReservation = acc - pmc - reservationExpenses;
              
              let checkin = r["CHECK-IN DATE"] ? r["CHECK-IN DATE"].split("-").slice(1).join("/") : "";
              let checkout = r["CHECK-OUT DATE"] ? r["CHECK-OUT DATE"].split("-").slice(1).join("/") : "";

              if (payout === 0) return "";

              return `
                <tr>
                  <td>${code.substring(0,8)}</td>
                  <td>${displayPlat}</td>
                  <td>${checkin} - ${checkout}</td>
                  <td>${money(acc)}</td>
                  <td>${money(pmc)}</td>
                  <td>${money(reservationExpenses)}</td>
                  <td>${money(ownerPayoutPerReservation)}</td>
                </tr>
              `;
            }).join("")}
            `}
          </table>
        </div>
      </div>
    `;
  });

  document.getElementById("mainContent").innerHTML = html;
}

async function generateSummary() {
  if (!csvData || csvData.length === 0) { alert("Generate statement first"); return; }

  updateHeaderDates();

  const type = OWNERS[currentOwner].type;
  const salesPercent = OWNERS[currentOwner].salesFeePercent;
  const finalPayout = type === "draft" ? masterTotals.draft : masterTotals.owner;
  const salesAmount = masterTotals.pmc * (salesPercent / 100);

  const statement = {
    id: Date.now(),
    owner: currentOwner,
    month: parseInt(document.getElementById("monthSelect").value),
    year: parseInt(document.getElementById("yearSelect").value),
    type: type,
    amount: finalPayout,
    date: new Date().toISOString()
  };
  const tx = db.transaction(["statements"], "readwrite");
  tx.objectStore("statements").put(statement);

  let html = `
    <button class="btn back-btn" onclick="generateStatement()">‚Üê Back</button>
    
    <div class="summary-title">ACCOMMODATION & SALES</div>
    <div style="background:#f9f9f9;border:1px solid #ddd;padding:20px;border-radius:5px;margin:20px 0">
      <table>
        <tr><td style="font-weight:bold;text-transform:uppercase">Total Accommodation</td><td style="text-align:right;font-weight:bold">${money(masterTotals.acc)}</td></tr>
        <tr><td style="font-weight:bold;text-transform:uppercase">PMC Amount</td><td style="text-align:right;font-weight:bold">${money(masterTotals.pmc)}</td></tr>
        <tr><td style="font-weight:bold;text-transform:uppercase">Sales Fee Rate</td><td style="text-align:right;font-weight:bold">${salesPercent}%</td></tr>
        <tr><td style="font-weight:bold;text-transform:uppercase">Sales Amount Due</td><td style="text-align:right;font-weight:bold">${money(salesAmount)}</td></tr>
      </table>
    </div>

    <div class="summary-title">PAYMENT INFO</div>
    <div style="background:#f9f9f9;border:1px solid #ddd;padding:20px;border-radius:5px;margin:20px 0">
      <table>
        <tr><td style="text-transform:uppercase;font-weight:bold">Owner</td><td style="text-align:right;font-weight:bold">${currentOwner}</td></tr>
        ${type === "draft" ? `
          <tr><td style="font-weight:bold;text-transform:uppercase">AMOUNT TO DRAFT</td><td style="text-align:right;font-weight:bold">${money(finalPayout)}</td></tr>
        ` : `
          <tr><td style="font-weight:bold;text-transform:uppercase">NET AMOUNT TO SEND</td><td style="text-align:right;font-weight:bold">${money(finalPayout)}</td></tr>
        `}
      </table>
    </div>

    ${type === "payout" && Object.entries(propertyTotals).some(([prop]) => propertySettings[prop]?.municipalities && Object.values(propertySettings[prop].municipalities).some(v => v)) ? `
    <div class="tax-info">
      <div class="tax-info-title">‚ö†Ô∏è TAX REPORTING - PAYMENT REQUIRED BY MUNICIPALITY</div>
      <table class="tax-table">
        <tr>
          <th>PROPERTY</th>
          <th>MUNICIPALITIES</th>
          <th>TAX AMOUNT</th>
        </tr>
        ${Object.entries(propertyTotals).map(([prop, data]) => {
          const settings = propertySettings[prop];
          if (!settings || !settings.municipalities || !Object.values(settings.municipalities).some(v => v)) return "";
          const munis = Object.keys(settings.municipalities || {}).filter(m => settings.municipalities[m]).join(", ");
          return `
            <tr>
              <td style="text-transform:uppercase">${prop}</td>
              <td>${munis}</td>
              <td class="tax-amount">${money(taxByProperty[prop] || 0)}</td>
            </tr>
          `;
        }).join('')}
      </table>
      <p style="font-size:11px;margin-top:15px;color:#333;text-align:center">
        üìù <strong>PAYMENT REQUIRED:</strong> You must pay taxes on these amounts to the municipalities listed above.
      </p>
    </div>
    ` : ""}

    <button class="btn print-btn" onclick="window.print()">üñ®Ô∏è Print</button>
  `;

  document.getElementById("mainContent").innerHTML = html;
}

async function generateAnnual() {
  const type = OWNERS[currentOwner].type;
  if (type !== "payout") { alert("Annual Report for PAYOUT owners only"); return; }

  updateHeaderDates();

  let html = `
    <button class="btn back-btn" onclick="generateStatement()">‚Üê Back</button>
    
    <div class="summary-title">ANNUAL SUMMARY</div>
    <div style="background:#f9f9f9;border:1px solid #ddd;padding:20px;border-radius:5px;margin:20px 0">
      <table>
        <tr><td style="font-weight:bold;text-transform:uppercase">Total Accommodation</td><td style="text-align:right;font-weight:bold">${money(masterTotals.acc)}</td></tr>
        <tr><td style="font-weight:bold;text-transform:uppercase">PMC Charged</td><td style="text-align:right;font-weight:bold">${money(masterTotals.pmc)}</td></tr>
        <tr><td style="font-weight:bold;text-transform:uppercase">Total Expenses</td><td style="text-align:right;font-weight:bold">${money(masterTotals.expenses)}</td></tr>
        <tr style="background:#000;color:#fff"><td style="color:#fff;font-weight:bold;text-transform:uppercase"><strong>NET ANNUAL AMOUNT</strong></td><td style="text-align:right;color:#fff;font-weight:bold"><strong>${money(masterTotals.owner)}</strong></td></tr>
      </table>
    </div>

    <button class="btn print-btn" onclick="window.print()">üñ®Ô∏è Print</button>
  `;

  document.getElementById("mainContent").innerHTML = html;
}

async function viewHistory() {
  if (!currentOwner) { alert("Select owner"); return; }

  const allStatements = await getDB("statements");
  const ownerStatements = allStatements.filter(s => s.owner === currentOwner).sort((a, b) => new Date(b.date) - new Date(a.date));

  updateHeaderDates();

  let html = `
    <button class="btn back-btn" onclick="generateStatement()">‚Üê Back</button>
    
    <div class="summary-title">STATEMENT HISTORY</div>
    ${ownerStatements.map(s => `
      <div class="history-row">
        <div class="history-info">
          <strong>${getMonthName(s.month)} ${s.year}</strong> - ${s.type.toUpperCase()} - ${money(s.amount)}<br>
          <span style="color:#666">${new Date(s.date).toLocaleString()}</span>
        </div>
        <div class="history-actions">
          <button onclick="downloadStatementPDF(${s.id})" style="background:#17a2b8">üì• PDF</button>
          <button onclick="deleteStatement(${s.id})" style="background:#dc3545">üóëÔ∏è Delete</button>
        </div>
      </div>
    `).join("")}
  `;

  document.getElementById("mainContent").innerHTML = html;
}

async function deleteStatement(id) {
  if (confirm("Delete this statement from history?")) {
    deleteDB("statements", id);
    viewHistory();
  }
}

async function downloadStatementPDF(id) {
  const allStatements = await getDB("statements");
  const statement = allStatements.find(s => s.id === id);
  if (!statement) { alert("Statement not found"); return; }
  
  updateHeaderDates();
  
  const type = statement.type;
  const finalPayout = statement.amount;
  const salesPercent = OWNERS[statement.owner].salesFeePercent;
  
  let html = `
    <div style="padding:20px;background:#fff">
      <h2 style="text-align:center;text-transform:uppercase">${statement.owner}</h2>
      <p style="text-align:center;text-transform:uppercase">${getMonthName(statement.month)} ${statement.year}</p>
      <table style="width:100%;margin-top:20px">
        <tr><td style="font-weight:bold;text-transform:uppercase">Owner</td><td style="text-align:right;text-transform:uppercase">${statement.owner}</td></tr>
        <tr><td style="font-weight:bold;text-transform:uppercase">Type</td><td style="text-align:right;font-weight:bold;text-transform:uppercase">${statement.type}</td></tr>
        ${type === "draft" ? `
          <tr><td style="font-weight:bold;text-transform:uppercase">AMOUNT TO DRAFT</td><td style="text-align:right;font-weight:bold">${money(finalPayout)}</td></tr>
        ` : `
          <tr><td style="font-weight:bold;text-transform:uppercase">NET AMOUNT TO SEND</td><td style="text-align:right;font-weight:bold">${money(finalPayout)}</td></tr>
        `}
      </table>
    </div>
  `;
  
  html2pdf().set({ margin: 10, jsPDF: { unit: "mm", format: "a4" } }).from(document.createElement("div")).set({ html: html }).save(`Statement-${statement.owner}-${statement.month}-${statement.year}.pdf`);
}

function downloadPDF() {
  html2pdf().set({ margin: 10, jsPDF: { unit: "mm", format: "a4" } }).from(document.getElementById("content")).save("Report.pdf");
}

window.onclick = function(event) {
  const modal = document.getElementById("vendorModal");
  if (event.target == modal) modal.style.display = "none";
  const settingsModal = document.getElementById("propertySettingsModal");
  if (event.target == settingsModal) settingsModal.style.display = "none";
};

</script>

</body>
</html>
