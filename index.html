<!DOCTYPE html>
<html>
<head>
<title>Ocean Vacations - Reservation Report</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial;background:#f5f5f5;color:#000;display:flex}.sidebar{width:280px;background:#333;color:#fff;padding:20px;height:100vh;overflow-y:auto;position:fixed;left:0;top:0}.sidebar h3{margin-bottom:20px;font-size:16px;border-bottom:2px solid #fff;padding-bottom:10px}.section{margin-bottom:20px}.label{font-size:11px;font-weight:bold;color:#aaa;margin-bottom:5px;display:block}select,input{width:100%;padding:8px;margin:5px 0;border:1px solid #555;background:#444;color:#fff;border-radius:3px;font-size:11px}.btn{width:100%;padding:12px;margin:8px 0;border:none;font-weight:bold;border-radius:3px;cursor:pointer;font-size:12px;color:#fff;transition:all 0.3s}.btn-primary{background:#000}.btn-primary:hover{background:#222}.btn-success{background:#28a745}.btn-success:hover{background:#218838}.btn-warning{background:#ff9800}.btn-warning:hover{background:#e68900}.btn-info{background:#17a2b8}.btn-info:hover{background:#138496}.btn-danger{background:#dc3545}.btn-danger:hover{background:#c82333}.main{margin-left:280px;padding:20px;width:calc(100% - 280px)}.page{background:#fff;padding:40px;border-radius:5px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}.invoice-header{display:flex;justify-content:space-between;margin-bottom:40px;border-bottom:2px solid #000;padding-bottom:30px}.company-info{font-size:11px;line-height:1.8}.company-name{font-size:20px;font-weight:bold;margin-bottom:5px}.right-header{text-align:right;font-size:11px;line-height:1.8}.statement-date{margin-bottom:20px;font-weight:bold}.period-date{margin-top:10px}.report-title{text-align:center;font-size:32px;font-weight:bold;margin:40px 0 10px 0;letter-spacing:2px}.owner-name{text-align:center;font-size:28px;margin-bottom:40px;font-weight:bold;color:#000}table{width:100%;border-collapse:collapse;margin:20px 0;font-size:11px}th,td{border:1px solid #e0e0e0;padding:12px;text-align:left}th{background:#f5f5f5;color:#000;font-weight:bold;text-align:center;text-transform:uppercase}tr:nth-child(even){background:#fafafa}.action-buttons{display:flex;gap:10px;margin:20px 0;justify-content:center;flex-wrap:wrap}.action-buttons button{padding:10px 20px;font-size:12px;cursor:pointer;border:none;border-radius:3px;color:#fff;font-weight:bold}.back-btn{background:#666}.back-btn:hover{background:#555}.print-btn{background:#e74c3c}.print-btn:hover{background:#c0392b}.save-btn{background:#28a745}.save-btn:hover{background:#218838}.property-section{margin:40px 0;padding:20px;border:1px solid #ddd;border-radius:5px;background:#fff}.property-title{font-size:14px;font-weight:bold;margin-bottom:15px;display:flex;align-items:center;text-transform:uppercase;text-align:center;justify-content:center}.property-icon{font-size:18px;margin-right:10px}.summary-title{font-size:12px;font-weight:bold;text-transform:uppercase;text-align:center;margin:20px 0}.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin:20px 0}.summary-card{background:#f9f9f9;border:1px solid #ddd;padding:12px;text-align:center;border-radius:5px}.summary-label{font-size:10px;color:#666;font-weight:bold;text-transform:uppercase}.summary-value{font-size:14px;font-weight:bold;color:#000;margin-top:6px}.attachment{background:#f0f0f0;padding:10px;margin:10px 0;border-radius:3px;font-size:10px;display:flex;justify-content:space-between;align-items:center;gap:10px}.attachment-left{flex:1}.attachment-actions{display:flex;gap:5px}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5)}.modal-content{background:#fff;margin:10% auto;padding:20px;border:1px solid #888;width:80%;max-width:600px;border-radius:5px;max-height:80vh;overflow-y:auto}.modal-close{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}.modal-close:hover{color:#000}.tax-table{width:100%;border-collapse:collapse;font-size:11px;margin-top:10px}.tax-table th{background:#333;color:#fff;font-weight:bold;text-align:center;text-transform:uppercase;border:1px solid #000;padding:8px}.tax-table td{border:1px solid #000;padding:8px;text-align:left}.tax-table tr:nth-child(even){background:#f9f9f9}.tax-amount{text-align:right;font-weight:bold}.tax-info{background:#e8f4f8;border:2px solid #17a2b8;padding:15px;margin:15px 0;border-radius:5px}.tax-info-title{font-size:14px;font-weight:bold;color:#0c5460;margin-bottom:10px;text-transform:uppercase;text-align:center}.history-row{display:flex;justify-content:space-between;align-items:center;background:#f0f0f0;padding:12px;margin:8px 0;border-radius:3px}.history-info{flex:1;font-size:11px}.history-actions{display:flex;gap:8px}.history-actions button{padding:5px 10px;font-size:9px;cursor:pointer;border:none;border-radius:3px;color:#fff}.section-title{font-size:12px;font-weight:bold;text-transform:uppercase;margin-top:20px;margin-bottom:10px;color:#000}.property-settings-box{margin-bottom:20px;padding:15px;background:#f0f0f0;border-radius:3px;border-left:4px solid #17a2b8}.property-name-label{font-weight:bold;color:#000;margin-bottom:10px;display:block;text-transform:uppercase;font-size:12px}.checkbox-group{display:flex;flex-wrap:wrap;gap:15px;align-items:center}.checkbox-item{display:flex;align-items:center;gap:8px}.checkbox-item input{width:18px;height:18px;cursor:pointer}.checkbox-item label{color:#000;font-weight:bold;cursor:pointer;margin:0;font-size:12px}.btn-small{padding:5px 10px;font-size:9px;width:auto;margin:0;display:inline-block}.owner-settings-box{background:#f0f0f0;padding:15px;margin-bottom:15px;border-radius:3px;border-left:4px solid #17a2b8}.owner-settings-label{font-weight:bold;color:#000;margin-bottom:8px;display:block;text-transform:uppercase;font-size:11px}.owner-settings-input{width:100%;padding:8px;border:1px solid #ddd;border-radius:3px;font-size:11px;margin-bottom:10px}.status-msg{padding:10px;margin:10px 0;border-radius:3px;font-size:11px;display:block}.status-success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}.status-error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}.calc-box{background:#f0f0f0;border:1px solid #ddd;padding:15px;margin:15px 0;border-radius:5px}.calc-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #ddd}.calc-row-total{display:flex;justify-content:space-between;padding:12px;background:#000;color:#fff;font-weight:bold}.commission-box{background:#fff3cd;border:2px solid #ffc107;padding:15px;margin:15px 0;border-radius:5px}.commission-box-title{font-size:14px;font-weight:bold;color:#856404;margin-bottom:10px;text-transform:uppercase;text-align:center}@media print{.sidebar,.back-btn,.print-btn,.save-btn,.action-buttons,.history-actions,.attachment-actions{display:none}.main{margin-left:0;width:100%}.page{padding:20px}}
</style>
</head>
<body>
<div class="sidebar"><h3>üéØ OCEAN VACATIONS</h3>
<div id="statusMessage" class="status-msg status-success" style="display:block">‚è≥ Loading...</div>
<div class="section"><label class="label">Select Owner</label><select id="ownerSelect" onchange="onOwnerChange()"><option value="">-- Select Owner --</option></select></div>
<div class="section"><label class="label">Month</label><select id="monthSelect"></select></div>
<div class="section"><label class="label">Year</label><select id="yearSelect"></select></div>
<div class="section"><label class="label">Upload CSV</label><input type="file" id="csvFile" accept=".csv"></div>
<button class="btn btn-primary" onclick="generateStatement()">‚ñ∂ STATEMENT</button>
<button class="btn btn-success" onclick="saveReport()">üíæ Save Report</button>
<button class="btn btn-success" onclick="generateSummary()">üìä View Summary</button>
<button class="btn btn-warning" onclick="generateAnnual()">üìà Annual Report</button>
<button class="btn btn-info" onclick="downloadPDF()">üì• Download PDF</button>
<button class="btn btn-info" onclick="viewHistory()">üìã View History</button>
<hr style="border:1px solid #555;margin:20px 0">
<h4 style="color:#fff;margin-bottom:10px">üí∞ Add Expense</h4>
<select id="expenseType"><option>Maintenance</option><option>Repair</option><option>Purchase</option><option>Supplies</option><option>Service</option><option>Pool Cleaning</option><option>Pest Control</option><option>Credit</option><option>Adjustment</option></select>
<select id="expenseProperty"></select>
<select id="expenseVendor"></select>
<input type="number" id="expenseAmount" placeholder="Amount" step="0.01">
<input type="text" id="expenseNotes" placeholder="Notes">
<button class="btn btn-success" onclick="addExpense()" style="font-size:11px">Add Expense</button>
<hr style="border:1px solid #555;margin:20px 0">
<h4 style="color:#fff;margin-bottom:10px">üè¢ Vendors</h4>
<input type="text" id="vendorName" placeholder="Vendor name">
<input type="text" id="vendorPhone" placeholder="Phone/Email">
<button class="btn btn-success" onclick="addVendor()" style="font-size:11px">Add Vendor</button>
<button class="btn btn-warning" onclick="showVendorModal()" style="font-size:11px">View/Manage</button>
<hr style="border:1px solid #555;margin:20px 0">
<button class="btn btn-info" onclick="openOwnerSettings()" style="font-size:11px">‚öôÔ∏è Owner Settings</button>
<button class="btn btn-info" onclick="openPropertySettings()" style="font-size:11px">‚öôÔ∏è Tax Settings</button>
<button class="btn btn-warning" onclick="setupGitHub()" style="font-size:11px">üîë GitHub Setup</button>
</div>

<div id="vendorModal" class="modal"><div class="modal-content"><span class="modal-close" onclick="closeVendorModal()">&times;</span><h2>Manage Vendors</h2><div id="vendorListModal" style="margin-top:20px;max-height:400px;overflow-y:auto"></div></div></div>
<div id="ownerSettingsModal" class="modal"><div class="modal-content"><span class="modal-close" onclick="closeOwnerSettings()">&times;</span><h2 style="text-transform:uppercase;text-align:center">OWNER SETTINGS</h2><div id="ownerSettingsContent" style="margin-top:20px;max-height:600px;overflow-y:auto"></div><button class="btn btn-success" onclick="saveOwnerSettingsToGitHub()" style="margin-top:20px">üíæ Save to GitHub</button></div></div>
<div id="propertySettingsModal" class="modal"><div class="modal-content"><span class="modal-close" onclick="closePropertySettings()">&times;</span><h2 style="text-transform:uppercase;text-align:center">PROPERTY TAX SETTINGS</h2><div id="propertySettingsContent" style="margin-top:20px;max-height:600px;overflow-y:auto"></div><button class="btn btn-success" onclick="savePropertySettingsToGitHub()" style="margin-top:20px">üíæ Save to GitHub</button></div></div>
<div id="editExpenseModal" class="modal"><div class="modal-content"><span class="modal-close" onclick="closeEditExpense()">&times;</span><h2>Edit Expense</h2><div style="margin-top:20px"><label class="label">Type</label><select id="editExpenseType"><option>Maintenance</option><option>Repair</option><option>Purchase</option><option>Supplies</option><option>Service</option><option>Pool Cleaning</option><option>Pest Control</option><option>Credit</option><option>Adjustment</option></select><label class="label" style="margin-top:10px">Vendor</label><select id="editExpenseVendor"></select><label class="label" style="margin-top:10px">Amount</label><input type="number" id="editExpenseAmount" placeholder="Amount" step="0.01"><label class="label" style="margin-top:10px">Notes</label><input type="text" id="editExpenseNotes" placeholder="Notes"><div style="margin-top:20px;display:flex;gap:10px"><button class="btn btn-success" onclick="saveEditedExpense()" style="flex:1">Save Changes</button><button class="btn btn-danger" onclick="closeEditExpense()" style="flex:1">Cancel</button></div></div></div></div>

<div class="main"><div id="content" class="page"><div class="invoice-header"><div class="company-info"><div class="company-name">OCEAN VACATIONS</div><div>www.oceanvacationsmb.com</div><div>oceanvacationsmb@gmail.com</div><div>843-222-6516</div></div><div class="right-header"><div class="statement-date" id="statementDate"></div><div class="period-date" id="periodDate"></div></div></div><div class="report-title">RESERVATION REPORT</div><div class="owner-name" id="ownerTitle"></div><div id="mainContent"><div style="text-align:center;padding:40px;color:#666">Ready to use! Select an owner and upload CSV to begin.</div></div></div></div>

<script>
const GITHUB_URL="https://raw.githubusercontent.com/oceanvacationsmb/reports/main/data.json";
let gitHubData={},vendors=[],expenses=[],csvData=[],properties=[],propertySettings={},ownerSettings={},currentOwner="",masterTotals={},propertyTotals={},taxByProperty={},savedReports=[],editingExpenseId=null;
const municipalities=["SC","MB","NMB","SSB","HC"];
const OWNERS={"ERAN":{percent:0.12,type:"draft",salesFeePercent:5},"GHO":{percent:0.10,type:"payout",salesFeePercent:5},"1463 Basin Trail":{percent:0.12,type:"payout",salesFeePercent:5},"113B-15S Surfside Beach":{percent:0.12,type:"payout",salesFeePercent:5},"113B-13N Surfside Beach":{percent:0.12,type:"payout",salesFeePercent:5},"115C-15N Surfside Beach":{percent:0.12,type:"payout",salesFeePercent:5},"2131 Sanibel Myrtle Beach":{percent:0.15,type:"payout",salesFeePercent:5},"1552 Elizabeth Ln Myrtle Beach":{percent:0.15,type:"payout",salesFeePercent:5},"469C White River RD Myrtle Beach":{percent:0.12,type:"payout",salesFeePercent:5},"4631-301 Wild Iris Drive Myrtle Beach":{percent:0.12,type:"payout",salesFeePercent:5},"4679-204 Wild Iris Drive Myrtle Beach":{percent:0.12,type:"payout",salesFeePercent:5},"508-1/2 33rd Ave North Myrtle Beach":{percent:0.15,type:"payout",salesFeePercent:10},"214-2S 2nd Ave S. North Myrtle Beach":{percent:0.12,type:"payout",salesFeePercent:10}};

function showStatus(m,e){const s=document.getElementById("statusMessage");s.textContent=m;s.className="status-msg "+(e?"status-error":"status-success");s.style.display="block";setTimeout(()=>{s.style.display="none"},4000)}
async function loadDataFromGitHub(){try{const r=await fetch(GITHUB_URL+"?t="+Date.now());if(!r.ok)throw new Error("HTTP "+r.status);gitHubData=await r.json();gitHubData.owners&&Object.keys(gitHubData.owners).forEach(e=>{ownerSettings[e]=gitHubData.owners[e];if(gitHubData.owners[e].percent)OWNERS[e].percent=gitHubData.owners[e].percent;if(gitHubData.owners[e].type)OWNERS[e].type=gitHubData.owners[e].type;if(gitHubData.owners[e].salesFeePercent)OWNERS[e].salesFeePercent=gitHubData.owners[e].salesFeePercent});gitHubData.vendors&&(vendors=gitHubData.vendors);gitHubData.properties&&Object.keys(gitHubData.properties).forEach(e=>{propertySettings[e]=gitHubData.properties[e]});gitHubData.expenses&&(expenses=gitHubData.expenses);gitHubData.reports&&(savedReports=gitHubData.reports);buildOwnerDropdown();buildMonthDropdown();buildYearDropdown();updateVendorList();showStatus("‚úì Data loaded!",false)}catch(e){console.error(e);buildOwnerDropdown();buildMonthDropdown();buildYearDropdown();showStatus("Error: "+e.message,true)}}
function setupGitHub(){const t=localStorage.getItem("github_token")||"";const n=prompt("GitHub Token:",t);if(n&&n.trim()){localStorage.setItem("github_token",n.trim());showStatus("‚úì Token saved!",false);loadDataFromGitHub()}}
async function saveToGitHub(a){const t=localStorage.getItem("github_token");if(!t){showStatus("‚úó No token",true);return false}try{const n=JSON.stringify(a,null,2);const e=btoa(unescape(encodeURIComponent(n)));const i=await fetch("https://api.github.com/repos/oceanvacationsmb/reports/contents/data.json",{headers:{"Authorization":"token "+t}});if(!i.ok)throw new Error("fetch fail");const s=await i.json();const r=await fetch("https://api.github.com/repos/oceanvacationsmb/reports/contents/data.json",{method:"PUT",headers:{"Authorization":"token "+t,"Content-Type":"application/json"},body:JSON.stringify({message:"Update: "+new Date().toLocaleString(),content:e,sha:s.sha,branch:"main"})});if(!r.ok)throw new Error("save fail");showStatus("‚úì Saved!",false);gitHubData=a;return true}catch(e){showStatus("‚úó Error: "+e.message,true);return false}}
function buildOwnerDropdown(){const e=document.getElementById("ownerSelect");e.innerHTML='<option value="">-- Select Owner --</option>';Object.keys(OWNERS).sort().forEach(n=>{const t=document.createElement("option");t.value=n;t.textContent=n;e.appendChild(t)})}
function buildMonthDropdown(){const e=document.getElementById("monthSelect");const n=["January","February","March","April","May","June","July","August","September","October","November","December"];n.forEach((t,a)=>{const s=document.createElement("option");s.value=a+1;s.textContent=t;e.appendChild(s)});e.value=new Date().getMonth()+1}
function buildYearDropdown(){const e=document.getElementById("yearSelect");const n=new Date().getFullYear();for(let t=n-2;t<=n+2;t++){const a=document.createElement("option");a.value=t;a.textContent=t;e.appendChild(a)}e.value=n}
function onOwnerChange(){currentOwner=document.getElementById("ownerSelect").value;if(currentOwner)updatePropertySelect()}
function getMonthName(e){const n=["January","February","March","April","May","June","July","August","September","October","November","December"];return n[e-1]}
function getNextMonth(e,n){let t=e+1;let a=n;if(t>12){t=1;a++}return{month:t,year:a}}
function updateHeaderDates(){const e=parseInt(document.getElementById("monthSelect").value);const n=parseInt(document.getElementById("yearSelect").value);const t=getNextMonth(e,n);const a=new Date(n,e,0).getDate();document.getElementById("statementDate").innerHTML="Statement Date:<br><strong>"+getMonthName(t.month)+" 1st "+t.year+"</strong>";document.getElementById("periodDate").innerHTML="Period: "+getMonthName(e)+" 1st - "+a+"th "+n;document.getElementById("ownerTitle").textContent=currentOwner.toUpperCase()}
function openOwnerSettings(){const e=document.getElementById("ownerSettingsModal");const n=document.getElementById("ownerSettingsContent");let t="";Object.keys(OWNERS).sort().forEach(a=>{const s=ownerSettings[a]||{name:a,percent:OWNERS[a].percent,salesFeePercent:OWNERS[a].salesFeePercent,type:OWNERS[a].type};const r=s.type==="draft";t+="<div class='owner-settings-box'><span class='property-name-label'>"+a+"</span><label class='owner-settings-label'>Commission %:</label><input type='number' step='0.01' value='"+(s.percent*100).toFixed(2)+"' onchange=\"updateOwnerSettingLocal('"+a+"','percent',this.value/100)\" class='owner-settings-input'><label class='owner-settings-label'>Sales Fee %:</label><input type='number' step='0.01' value='"+s.salesFeePercent.toFixed(2)+"' onchange=\"updateOwnerSettingLocal('"+a+"','salesFeePercent',parseFloat(this.value))\" class='owner-settings-input'><label class='owner-settings-label'>Type:</label><select onchange=\"updateOwnerSettingLocal('"+a+"','type',this.value)\" class='owner-settings-input'><option value='draft' "+(r?"selected":"")+">Draft</option><option value='payout' "+(r?"":"selected")+">Payout</option></select></div>"});n.innerHTML=t;e.style.display="block"}
function updateOwnerSettingLocal(e,n,t){if(!ownerSettings[e]){ownerSettings[e]={name:e,percent:OWNERS[e].percent,salesFeePercent:OWNERS[e].salesFeePercent,type:OWNERS[e].type}}ownerSettings[e][n]=t;OWNERS[e][n]=t}
async function saveOwnerSettingsToGitHub(){const e=Object.assign({},gitHubData,{owners:ownerSettings});const n=await saveToGitHub(e);if(n){gitHubData=e;closeOwnerSettings()}}
function closeOwnerSettings(){document.getElementById("ownerSettingsModal").style.display="none"}
function openPropertySettings(){const e=document.getElementById("propertySettingsModal");const n=document.getElementById("propertySettingsContent");let t="";Object.keys(OWNERS).sort().forEach(a=>{const s=propertySettings[a]||{name:a,municipalities:{}};t+="<div class='property-settings-box'><span class='property-name-label'>"+a+"</span><div class='checkbox-group'>";municipalities.forEach(r=>{t+="<div class='checkbox-item'><input type='checkbox' id='mun_"+a+"_"+r+"' "+(s.municipalities&&s.municipalities[r]?"checked":"")+` onchange="updateMunicipalityLocal('`+a+`','`+r+`',this.checked)"><label for='mun_`+a+`_`+r+`'>`+r+"</label></div>"});t+="</div></div>"});n.innerHTML=t;e.style.display="block"}
function updateMunicipalityLocal(e,n,t){if(!propertySettings[e])propertySettings[e]={name:e,municipalities:{}};if(!propertySettings[e].municipalities)propertySettings[e].municipalities={};propertySettings[e].municipalities[n]=t}
async function savePropertySettingsToGitHub(){const e=Object.assign({},gitHubData,{properties:propertySettings});const n=await saveToGitHub(e);if(n){gitHubData=e;closePropertySettings()}}
function closePropertySettings(){document.getElementById("propertySettingsModal").style.display="none"}
async function addVendor(){const e=document.getElementById("vendorName").value.trim();const n=document.getElementById("vendorPhone").value.trim();if(!e){alert("Enter name");return}const t={id:Date.now(),name:e,phone:n};vendors.push(t);updateVendorList();document.getElementById("vendorName").value="";document.getElementById("vendorPhone").value="";const a=Object.assign({},gitHubData,{vendors:vendors});await saveToGitHub(a)}
async function deleteVendor(e){vendors=vendors.filter(n=>n.id!==e);updateVendorList();const n=Object.assign({},gitHubData,{vendors:vendors});await saveToGitHub(n)}
function updateVendorList(){const e=document.getElementById("expenseVendor");const n=document.getElementById("editExpenseVendor");e.innerHTML="<option value=''>-- Select Vendor --</option>";n.innerHTML="<option value=''>-- Select Vendor --</option>";vendors.forEach(t=>{const a=document.createElement("option");a.value=t.name;a.textContent=t.name;const s=a.cloneNode(true);e.appendChild(a);n.appendChild(s)})}
function showVendorModal(){const e=document.getElementById("vendorModal");const n=document.getElementById("vendorListModal");if(vendors.length===0){n.innerHTML="<p>No vendors</p>"}else{let t="";vendors.forEach(a=>{t+="<div style='background:#f0f0f0;padding:15px;margin:10px 0;border-radius:3px;display:flex;justify-content:space-between;align-items:center'><div><strong>"+a.name+"</strong><br><span style='color:#666;font-size:11px'>"+a.phone+"</span></div><button onclick='deleteVendor("+a.id+")' class='btn btn-danger btn-small'>Delete</button></div>"});n.innerHTML=t}e.style.display="block"}
function closeVendorModal(){document.getElementById("vendorModal").style.display="none"}
function updatePropertySelect(){const e=document.getElementById("expenseProperty");e.innerHTML="<option value=''>-- Select Property --</option>";properties.forEach(n=>{const t=document.createElement("option");t.value=n;t.textContent=n;e.appendChild(t)})}
async function addExpense(){const e=document.getElementById("expenseType").value;const n=document.getElementById("expenseProperty").value;const t=document.getElementById("expenseVendor").value;const a=parseFloat(document.getElementById("expenseAmount").value);const s=document.getElementById("expenseNotes").value;if(!currentOwner||!n||!t||!a){alert("Fill all fields");return}const r={id:Date.now(),owner:currentOwner,type:e,property:n,vendor:t,amount:a,notes:s};expenses.push(r);document.getElementById("expenseAmount").value="";document.getElementById("expenseNotes").value="";document.getElementById("expenseProperty").value="";const i=Object.assign({},gitHubData,{expenses:expenses});await saveToGitHub(i);if(csvData&&csvData.length>0){processData();displayStatement()}showStatus("‚úì Expense added!",false)}
function openEditExpense(e){const n=expenses.find(n=>n.id===e);if(!n)return;editingExpenseId=e;document.getElementById("editExpenseType").value=n.type;document.getElementById("editExpenseVendor").value=n.vendor;document.getElementById("editExpenseAmount").value=n.amount;document.getElementById("editExpenseNotes").value=n.notes;document.getElementById("editExpenseModal").style.display="block"}
async function saveEditedExpense(){if(editingExpenseId===null)return;const e=expenses.findIndex(n=>n.id===editingExpenseId);if(e===-1)return;expenses[e].type=document.getElementById("editExpenseType").value;expenses[e].vendor=document.getElementById("editExpenseVendor").value;expenses[e].amount=parseFloat(document.getElementById("editExpenseAmount").value);expenses[e].notes=document.getElementById("editExpenseNotes").value;const n=Object.assign({},gitHubData,{expenses:expenses});await saveToGitHub(n);closeEditExpense();if(csvData&&csvData.length>0){processData();displayStatement()}showStatus("‚úì Expense updated!",false)}
function closeEditExpense(){document.getElementById("editExpenseModal").style.display="none";editingExpenseId=null}
async function deleteExpense(e){if(confirm("Delete?")){expenses=expenses.filter(n=>n.id!==e);const n=Object.assign({},gitHubData,{expenses:expenses});await saveToGitHub(n);if(csvData&&csvData.length>0){processData();displayStatement()}}}
function money(e){return"$"+(Number(e)||0).toFixed(2)}
function num(e){return parseFloat((e||"0").toString().replace(/[$,]/g,""))||0}
async function generateStatement(){const e=document.getElementById("csvFile").files[0];if(!e){alert("Upload CSV");return}if(!currentOwner){alert("Select owner");return}updateHeaderDates();const n=new FileReader();n.onload=t=>{csvData=Papa.parse(t.target.result,{header:true,skipEmptyLines:true}).data;processData();displayStatement()};n.readAsText(e)}
function processData(){const e=parseInt(document.getElementById("monthSelect").value);const n=parseInt(document.getElementById("yearSelect").value);const t=ownerSettings[currentOwner]||OWNERS[currentOwner];const a=t.percent;const s=t.type;propertyTotals={};masterTotals={gross:0,acc:0,clean:0,pmc:0,expenses:0,draft:0,owner:0,websiteFee:0};taxByProperty={};properties=[];let r={};csvData.forEach(t=>{if(!t["CHECK-IN DATE"])return;let a=parseInt(t["CHECK-IN DATE"].split("-")[1]);let s=parseInt(t["CHECK-IN DATE"].split("-")[0]);if(a!==e||s!==n)return;let i=t["LISTING'S NICKNAME"]||"Unknown";if(!properties.includes(i))properties.push(i);if(!r[i])r[i]=[];r[i].push(t)});updatePropertySelect();Object.keys(r).forEach(e=>{let n=0,t=0,i=0,d=0,c=0,o=0;r[e].forEach(r=>{let f=num(r["TOTAL PAYOUT"]);let l=num(r["ACCOMMODATION FARE"])-num(r["MARKUP"]);let h=(r["STATUS"]||"").toLowerCase();let u=h.includes("cancelled")?0:num(r["CLEANING FARE"]);let b=l*a;let m=0;if(s==="draft"&&l>0){let g=r["CONFIRMATION CODE"]||"";let p=r["PLATFORM"]||"";if(!g.toUpperCase().startsWith("HA")&&(p.toLowerCase().includes("website")||p.toLowerCase().includes("manual"))){m=f*0.01}}n+=f;t+=l;i+=u;d+=b;c+=m;if(s==="payout"){let g=num(r["CITY TAX"])||0;let p=num(r["STATE TAX"])||0;let S=num(r["COUNTY TAX"])||0;let y=num(r["OCCUPANCY TAX"])||0;if(g>0||p>0||S>0||y>0){if(!taxByProperty[e])taxByProperty[e]=0;taxByProperty[e]+=f}}});let f=expenses.filter(n=>n.property===e&&n.owner===currentOwner).reduce((e,n)=>e+n.amount,0);let l=d+i+c+f;let h=t-d-f;propertyTotals[e]={gross:n,acc:t,clean:i,pmc:d,websiteFee:c,expenses:f,draft:l,owner:h,reservations:r[e]};masterTotals.gross+=n;masterTotals.acc+=t;masterTotals.clean+=i;masterTotals.pmc+=d;masterTotals.websiteFee+=c;masterTotals.expenses+=f;masterTotals.draft+=l;masterTotals.owner+=h})}
function displayStatement(){const e=ownerSettings[currentOwner]||OWNERS[currentOwner];const n=e.type;let t="<div class='summary-title'>FINANCIAL SUMMARY</div><div class='summary-grid'>";if(n==="draft"){t+="<div class='summary-card'><div class='summary-label'>Gross Payout</div><div class='summary-value'>"+money(masterTotals.gross)+"</div></div><div class='summary-card'><div class='summary-label'>Accommodation</div><div class='summary-value'>"+money(masterTotals.acc)+"</div></div><div class='summary-card'><div class='summary-label'>PMC</div><div class='summary-value'>"+money(masterTotals.pmc)+"</div></div><div class='summary-card'><div class='summary-label'>Cleaning Fee</div><div class='summary-value'>"+money(masterTotals.clean)+"</div></div><div class='summary-card'><div class='summary-label'>Website (1%)</div><div class='summary-value'>"+money(masterTotals.websiteFee)+"</div></div><div class='summary-card'><div class='summary-label'>Expenses</div><div class='summary-value'>"+money(masterTotals.expenses)+"</div></div><div class='summary-card' style='background:#000;color:#fff;border-color:#000'><div class='summary-label' style='color:#fff'>AMOUNT DUE</div><div class='summary-value' style='color:#fff'>"+money(masterTotals.draft)+"</div></div>"}else{t+="<div class='summary-card'><div class='summary-label'>Accommodation</div><div class='summary-value'>"+money(masterTotals.acc)+"</div></div><div class='summary-card'><div class='summary-label'>PMC</div><div class='summary-value'>"+money(masterTotals.pmc)+"</div></div><div class='summary-card'><div class='summary-label'>Expenses</div><div class='summary-value'>"+money(masterTotals.expenses)+"</div></div><div class='summary-card' style='background:#000;color:#fff;border-color:#000'><div class='summary-label' style='color:#fff'>OWNER PAYOUT</div><div class='summary-value' style='color:#fff'>"+money(masterTotals.owner)+"</div></div>"}t+="</div>";Object.keys(propertyTotals).forEach(a=>{let s=propertyTotals[a];let r=n==="draft"?s.draft:s.owner;let i=expenses.filter(e=>e.property===a&&e.owner===currentOwner);t+="<div class='property-section'><div class='property-title'><span class='property-icon'>üè†</span>"+a.toUpperCase()+"</div><div class='summary-grid'>";if(n==="draft"){t+="<div class='summary-card'><div class='summary-label'>Gross Payout</div><div class='summary-value'>"+money(s.gross)+"</div></div><div class='summary-card'><div class='summary-label'>Accommodation</div><div class='summary-value'>"+money(s.acc)+"</div></div><div class='summary-card'><div class='summary-label'>PMC</div><div class='summary-value'>"+money(s.pmc)+"</div></div><div class='summary-card'><div class='summary-label'>Cleaning Fee</div><div class='summary-value'>"+money(s.clean)+"</div></div><div class='summary-card'><div class='summary-label'>Website (1%)</div><div class='summary-value'>"+money(s.websiteFee)+"</div></div><div class='summary-card'><div class='summary-label'>Expenses</div><div class='summary-value'>"+money(s.expenses)+"</div></div><div class='summary-card' style='background:#000;color:#fff;border-color:#000'><div class='summary-label' style='color:#fff'>AMOUNT DUE</div><div class='summary-value' style='color:#fff'>"+money(r)+"</div></div>"}else{t+="<div class='summary-card'><div class='summary-label'>Accommodation</div><div class='summary-value'>"+money(s.acc)+"</div></div><div class='summary-card'><div class='summary-label'>PMC</div><div class='summary-value'>"+money(s.pmc)+"</div></div><div class='summary-card'><div class='summary-label'>Expenses</div><div class='summary-value'>"+money(s.expenses)+"</div></div><div class='summary-card' style='background:#000;color:#fff;border-color:#000'><div class='summary-label' style='color:#fff'>OWNER PAYOUT</div><div class='summary-value' style='color:#fff'>"+money(r)+"</div></div>"}t+="</div><div style='margin-top:15px'><div class='section-title'>RESERVATIONS</div><table style='margin-top:10px'>";if(n==="draft"){t+="<tr><th>Code</th><th>Stay</th><th>Accommodation</th><th>PMC</th><th>Cleaning</th><th>Website</th><th>Amount Due</th></tr>";s.reservations.forEach(a=>{let r=num(a["ACCOMMODATION FARE"])-num(a["MARKUP"]);let i=num(a["TOTAL PAYOUT"]);let d=(a["STATUS"]||"").toLowerCase();let c=d.includes("cancelled")?0:num(a["CLEANING FARE"]);let o=e.percent;let f=r*o;let l=a["CONFIRMATION CODE"]||"";let h=a["PLATFORM"]||"";let u=l.toUpperCase().startsWith("HA");let b=r>0&&!u&&(h.toLowerCase().includes("website")||h.toLowerCase().includes("manual"))?i*0.01:0;let m=a["CHECK-IN DATE"]?a["CHECK-IN DATE"].split("-").slice(1).join("/"):"";let g=a["CHECK-OUT DATE"]?a["CHECK-OUT DATE"].split("-").slice(1).join("/"):"";if(i===0)return;t+="<tr><td>"+l.substring(0,8)+"</td><td>"+m+"-"+g+"</td><td>"+money(r)+"</td><td>"+money(f)+"</td><td>"+money(c)+"</td><td>"+money(b)+"</td><td>"+money(f+c+b)+"</td></tr>"})}else{t+="<tr><th>Code</th><th>Stay</th><th>Accommodation</th><th>PMC</th><th>Owner Payout</th></tr>";s.reservations.forEach(a=>{let r=num(a["ACCOMMODATION FARE"])-num(a["MARKUP"]);let i=num(a["TOTAL PAYOUT"]);let d=e.percent;let c=r*d;let o=a["CONFIRMATION CODE"]||"";let f=a["CHECK-IN DATE"]?a["CHECK-IN DATE"].split("-").slice(1).join("/"):"";let l=a["CHECK-OUT DATE"]?a["CHECK-OUT DATE"].split("-").slice(1).join("/"):"";if(i===0)return;t+="<tr><td>"+o.substring(0,8)+"</td><td>"+f+"-"+l+"</td><td>"+money(r)+"</td><td>"+money(c)+"</td><td>"+money(r-c)+"</td></tr>"})}t+="</table></div>";if(i.length>0){t+="<div style='margin-top:15px'><div class='section-title'>EXPENSES</div>";i.forEach(e=>{t+="<div class='attachment'><div class='attachment-left'><strong>"+e.type+"</strong> - "+e.vendor+": "+money(e.amount);if(e.notes)t+="<br><span style='color:#666'>Notes: "+e.notes+"</span>";t+="</div><div class='attachment-actions'><button onclick='openEditExpense("+e.id+")' class='btn btn-info btn-small'>‚úèÔ∏è Edit</button><button onclick='deleteExpense("+e.id+")' class='btn btn-danger btn-small'>Delete</button></div></div>"});t+="</div>"}t+="</div>"});document.getElementById("mainContent").innerHTML=t}
async function saveReport(){if(!currentOwner||!csvData||csvData.length===0){alert("Generate statement first");return}const e=parseInt(document.getElementById("monthSelect").value);const n=parseInt(document.getElementById("yearSelect").value);const t=ownerSettings[currentOwner]||OWNERS[currentOwner];const a=t.type;const s=a==="draft"?masterTotals.draft:masterTotals.owner;const r={id:Date.now(),owner:currentOwner,month:e,year:n,type:a,amount:s,date:new Date().toLocaleString(),masterTotals:masterTotals,propertyTotals:propertyTotals,taxByProperty:taxByProperty,fullStatement:true};if(!savedReports)savedReports=[];savedReports.push(r);const i=Object.assign({},gitHubData,{reports:savedReports});const d=await saveToGitHub(i);if(d)showStatus("‚úì Full statement saved!",false)}
async function generateSummary(){if(!csvData||csvData.length===0){alert("Generate statement first");return}updateHeaderDates();const e=ownerSettings[currentOwner]||OWNERS[currentOwner];const n=e.type;const t=e.salesFeePercent;const a=masterTotals.pmc*(t/100);let s="<div class='action-buttons'><button class='back-btn' onclick='generateStatement()'>‚Üê Back</button><button class='save-btn' onclick='saveReport()'>üíæ Save Report</button><button class='print-btn' onclick='window.print()'>üñ®Ô∏è Print</button></div><div class='summary-title'>SUMMARY & CALCULATIONS</div>";if(n==="draft"){s+="<div class='commission-box'><div class='commission-box-title'>Sales Commission Calculation</div><div class='calc-row'><span>Total Accommodation</span><span>"+money(masterTotals.acc)+"</span></div><div class='calc-row'><span>Commission Rate</span><span>"+(e.percent*100).toFixed(2)+"%</span></div><div class='calc-row' style='background:#fff;font-weight:bold'><span>PMC</span><span>"+money(masterTotals.pmc)+"</span></div><div class='calc-row'><span>Cleaning Fees</span><span>"+money(masterTotals.clean)+"</span></div><div class='calc-row'><span>Website Fee (1%)</span><span>"+money(masterTotals.websiteFee)+"</span></div><div class='calc-row'><span>Expenses</span><span>"+money(masterTotals.expenses)+"</span></div><div class='calc-row-total'><span>TOTAL AMOUNT DUE</span><span>"+money(masterTotals.draft)+"</span></div></div>"}else{s+="<div class='calc-box'><div style='font-weight:bold;font-size:12px;margin-bottom:10px'>PAYOUT CALCULATION</div><div class='calc-row'><span>Total Accommodation</span><span>"+money(masterTotals.acc)+"</span></div><div class='calc-row'><span>Commission Rate</span><span>"+(e.percent*100).toFixed(2)+"%</span></div><div class='calc-row' style='background:#f0f0f0;font-weight:bold'><span>PMC</span><span>"+money(masterTotals.pmc)+"</span></div><div class='calc-row'><span>Expenses</span><span>"+money(masterTotals.expenses)+"</span></div><div class='calc-row-total'><span>NET PAYOUT</span><span>"+money(masterTotals.owner)+"</span></div></div><div class='commission-box'><div class='commission-box-title'>Sales Commission Due</div><div class='calc-row'><span>PMC Amount</span><span>"+money(masterTotals.pmc)+"</span></div><div class='calc-row'><span>Sales Fee Rate</span><span>"+t+"%</span></div><div class='calc-row-total'><span>Commission Amount</span><span>"+money(a)+"</span></div></div>"}if(n==="payout"&&Object.keys(propertyTotals).some(e=>propertySettings[e]&&propertySettings[e].municipalities&&Object.values(propertySettings[e].municipalities).some(e=>e))){s+="<div class='tax-info'><div class='tax-info-title'>‚ö†Ô∏è TAX PAYMENT REQUIRED BY MUNICIPALITY</div><table class='tax-table'><tr><th>PROPERTY</th><th>MUNICIPALITIES</th><th>AMOUNT</th></tr>";Object.keys(propertyTotals).forEach(e=>{const n=propertySettings[e];if(!n||!n.municipalities||!Object.values(n.municipalities).some(e=>e))return;const t=Object.keys(n.municipalities||{}).filter(e=>n.municipalities[e]).join(", ");s+="<tr><td>"+e+"</td><td>"+t+"</td><td class='tax-amount'>"+money(taxByProperty[e]||0)+"</td></tr>"});s+="</table></div>"}document.getElementById("mainContent").innerHTML=s}
async function generateAnnual(){const e=ownerSettings[currentOwner]||OWNERS[currentOwner];if(e.type!=="payout"){alert("Payout only");return}updateHeaderDates();let n="<div class='action-buttons'><button class='back-btn' onclick='generateStatement()'>‚Üê Back</button><button class='save-btn' onclick='saveReport()'>üíæ Save Report</button><button class='print-btn' onclick='window.print()'>üñ®Ô∏è Print</button></div><div class='summary-title'>ANNUAL SUMMARY</div><div style='background:#f9f9f9;padding:20px;border-radius:5px'><table><tr><td style='font-weight:bold'>Total Accommodation</td><td style='text-align:right'>"+money(masterTotals.acc)+"</td></tr><tr><td style='font-weight:bold'>PMC Charged</td><td style='text-align:right'>"+money(masterTotals.pmc)+"</td></tr><tr><td style='font-weight:bold'>Total Expenses</td><td style='text-align:right'>"+money(masterTotals.expenses)+"</td></tr><tr style='background:#000;color:#fff'><td style='font-weight:bold;color:#fff'>NET ANNUAL</td><td style='text-align:right;color:#fff'>"+money(masterTotals.owner)+"</td></tr></table></div>";document.getElementById("mainContent").innerHTML=n}
async function viewHistory(){if(!currentOwner){alert("Select owner");return}updateHeaderDates();let e="<button class='back-btn' onclick='generateStatement()'>‚Üê Back</button><div class='summary-title'>SAVED REPORTS</div>";if(!savedReports||savedReports.length===0){e+="<p style='text-align:center;padding:20px;color:#666'>No reports</p>"}else{const n=savedReports.filter(e=>e.owner===currentOwner).sort((e,n)=>n.id-e.id);if(n.length===0){e+="<p style='text-align:center;padding:20px;color:#666'>No reports for this owner</p>"}else{n.forEach(n=>{e+="<div class='history-row'><div class='history-info'><strong>"+getMonthName(n.month)+" "+n.year+"</strong> ("+n.type.toUpperCase()+") - "+money(n.amount)+"<br><span style='color:#666;font-size:10px'>"+n.date+"</span></div><div class='history-actions'><button onclick='downloadReportPDF("+n.id+")' class='btn btn-info btn-small'>üì• PDF</button><button onclick='deleteReport("+n.id+")' class='btn btn-danger btn-small'>üóëÔ∏è Delete</button></div></div>"})}}document.getElementById("mainContent").innerHTML=e}
async function deleteReport(e){if(confirm("Delete?")){savedReports=savedReports.filter(n=>n.id!==e);const n=Object.assign({},gitHubData,{reports:savedReports});await saveToGitHub(n);viewHistory()}}
async function downloadReportPDF(e){const n=savedReports.find(n=>n.id===e);if(!n)return;const t=ownerSettings[n.owner]||OWNERS[n.owner];let a="<div style='padding:20px'><h2>"+n.owner+" - "+getMonthName(n.month)+" "+n.year+"</h2>";Object.keys(n.propertyTotals).forEach(e=>{const s=n.propertyTotals[e];a+="<h3>"+e+"</h3><table style='width:100%;border-collapse:collapse;font-size:11px'><tr><td style='border:1px solid #ddd;padding:8px'>Accommodation</td><td style='text-align:right;border:1px solid #ddd;padding:8px'>"+money(s.acc)+"</td></tr><tr><td style='border:1px solid #ddd;padding:8px'>PMC</td><td style='text-align:right;border:1px solid #ddd;padding:8px'>"+money(s.pmc)+"</td></tr><tr><td style='border:1px solid #ddd;padding:8px'>Expenses</td><td style='text-align:right;border:1px solid #ddd;padding:8px'>"+money(s.expenses)+"</td></tr></table>"});a+="</div>";const s=document.createElement("div");s.innerHTML=a;html2pdf().set({margin:10,jsPDF:{unit:"mm",format:"a4"}}).from(s).save("Report_"+n.owner+"_"+n.month+"_"+n.year+".pdf")}
function downloadPDF(){html2pdf().set({margin:10,jsPDF:{unit:"mm",format:"a4"}}).from(document.getElementById("content")).save("Report.pdf")}
window.onclick=e=>{if(e.target===document.getElementById("vendorModal"))document.getElementById("vendorModal").style.display="none";if(e.target===document.getElementById("ownerSettingsModal"))document.getElementById("ownerSettingsModal").style.display="none";if(e.target===document.getElementById("propertySettingsModal"))document.getElementById("propertySettingsModal").style.display="none";if(e.target===document.getElementById("editExpenseModal"))document.getElementById("editExpenseModal").style.display="none"}
loadDataFromGitHub();
</script>
</body>
</html>
