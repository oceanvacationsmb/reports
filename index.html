<!DOCTYPE html>
<html>
<head>
<title>Ocean Vacations - Reservation Report</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial;background:#f5f5f5;color:#000;display:flex}.sidebar{width:280px;background:#333;color:#fff;padding:20px;height:100vh;overflow-y:auto;position:fixed;left:0;top:0}.sidebar h3{margin-bottom:20px;font-size:16px;border-bottom:2px solid #fff;padding-bottom:10px}.section{margin-bottom:20px}.label{font-size:11px;font-weight:bold;color:#aaa;margin-bottom:5px;display:block}select,input{width:100%;padding:8px;margin:5px 0;border:1px solid #555;background:#444;color:#fff;border-radius:3px;font-size:11px}.btn{width:100%;padding:12px;margin:8px 0;border:none;font-weight:bold;border-radius:3px;cursor:pointer;font-size:12px;color:#fff;transition:all 0.3s}.btn-primary{background:#000}.btn-success{background:#28a745}.btn-warning{background:#ff9800}.btn-info{background:#17a2b8}.btn-danger{background:#dc3545}.main{margin-left:280px;padding:20px;width:calc(100% - 280px)}.page{background:#fff;padding:40px;border-radius:5px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}.invoice-header{display:flex;justify-content:space-between;margin-bottom:40px;border-bottom:2px solid #000;padding-bottom:30px}.company-info{font-size:11px;line-height:1.8}.company-name{font-size:20px;font-weight:bold;margin-bottom:5px}.report-title{text-align:center;font-size:32px;font-weight:bold;margin:40px 0 10px 0}.owner-name{text-align:center;font-size:28px;margin-bottom:40px;font-weight:bold}table{width:100%;border-collapse:collapse;margin:20px 0;font-size:11px}th,td{border:1px solid #e0e0e0;padding:12px;text-align:left}th{background:#f5f5f5;font-weight:bold;text-transform:uppercase}tr:nth-child(even){background:#fafafa}.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin:20px 0}.summary-card{background:#f9f9f9;border:1px solid #ddd;padding:12px;text-align:center;border-radius:5px}.summary-label{font-size:10px;color:#666;font-weight:bold}.summary-value{font-size:14px;font-weight:bold;margin-top:6px}.property-section{margin:40px 0;padding:20px;border:1px solid #ddd;border-radius:5px}.property-title{font-size:14px;font-weight:bold;margin-bottom:15px}.modal{display:none;position:fixed;z-index:1001;left:50%;top:50%;transform:translate(-50%,-50%);width:90%;max-width:500px;background:#333;color:#fff;border-radius:8px;padding:30px;box-shadow:0 4px 20px rgba(0,0,0,0.3);max-height:90vh;overflow-y:auto}.modal.show{display:block}.modal-title{font-size:20px;font-weight:bold;margin-bottom:20px;border-bottom:2px solid #fff;padding-bottom:15px}.modal-field{margin-bottom:15px}.modal-label{font-size:11px;font-weight:bold;color:#aaa;margin-bottom:8px;display:block}.modal-input{width:100%;padding:10px;border:1px solid #555;background:#444;color:#fff;border-radius:3px;font-size:11px}.modal-actions{display:flex;gap:10px;margin-top:25px}.modal-actions button{flex:1;padding:12px;border:none;font-weight:bold;border-radius:3px;cursor:pointer;font-size:12px;color:#fff}.btn-add{background:#28a745}.btn-cancel{background:#666}.modal-overlay{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.7)}.modal-overlay.show{display:block}.copy-link-btn{background:#0066cc;color:#fff;padding:10px 15px;border:none;border-radius:3px;cursor:pointer;margin:10px 0;width:100%}.back-btn{background:#666}@media print{.sidebar,.back-btn,.copy-link-btn{display:none}.main{margin-left:0;width:100%}}
</style>
</head>
<body>
<div class="sidebar"><h3>üéØ OCEAN VACATIONS</h3>
<div class="section"><label class="label">Select Owner</label><select id="ownerSelect" onchange="onOwnerChange()"><option value="">-- Select --</option></select></div>
<div class="section"><label class="label">Month</label><select id="monthSelect"></select></div>
<div class="section"><label class="label">Year</label><select id="yearSelect"></select></div>
<div class="section"><label class="label">Upload CSV</label><input type="file" id="csvFile" accept=".csv"></div>
<button class="btn btn-primary" onclick="generateStatement()">‚ñ∂ STATEMENT</button>
<button class="btn btn-success" onclick="generateSummary()">üìä Summary</button>
<button class="btn btn-warning" onclick="generateAnnual()">üìà Annual</button>
<hr style="border:1px solid #555;margin:20px 0">
<button class="btn btn-success" onclick="openAddExpense()" style="font-size:13px">üí∞ ADD EXPENSE</button>
<hr style="border:1px solid #555;margin:20px 0">
<h4 style="color:#fff;margin-bottom:10px">üè¢ Vendors</h4>
<input type="text" id="vendorName" placeholder="Name">
<input type="text" id="vendorPhone" placeholder="Phone">
<button class="btn btn-success" onclick="addVendor()" style="font-size:11px">Add</button>
<button class="btn btn-warning" onclick="showVendors()" style="font-size:11px">View</button>
<hr style="border:1px solid #555;margin:20px 0">
<button class="btn btn-info" onclick="openOwners()" style="font-size:11px">‚öôÔ∏è Owners</button>
<button class="btn btn-info" onclick="openTax()" style="font-size:11px">‚öôÔ∏è Tax</button>
<button class="btn btn-warning" onclick="setupGitHub()" style="font-size:11px">üîë GitHub</button>
<button class="btn btn-warning" onclick="setupDropbox()" style="font-size:11px">üìÅ Dropbox</button>
</div>

<div id="modalOverlay" class="modal-overlay" onclick="closeAll()"></div>

<div id="ownerModal" class="modal"><div><div class="modal-title">‚öôÔ∏è Owners</div>
<div class="modal-field"><label class="modal-label">Name</label><input type="text" id="ownerNameInput" class="modal-input"></div>
<div class="modal-field"><label class="modal-label">Email</label><input type="email" id="ownerEmailInput" class="modal-input"></div>
<div class="modal-field"><label class="modal-label">Commission %</label><input type="number" id="ownerCommInput" class="modal-input" step="0.01"></div>
<div class="modal-field"><label class="modal-label">Sales Fee %</label><input type="number" id="ownerSalesInput" class="modal-input" step="0.01"></div>
<div class="modal-field"><label class="modal-label">Type</label><select id="ownerTypeInput" class="modal-input"><option value="draft">Draft</option><option value="payout">Payout</option></select></div>
<button class="btn btn-success" onclick="addOwner()" style="width:100%;margin-bottom:20px">‚ûï Add</button>
<div id="ownersList" style="max-height:300px;overflow-y:auto;margin-bottom:20px;padding:15px;background:#444;border-radius:3px"></div>
<div class="modal-actions"><button class="btn-cancel" onclick="closeAll()">‚úó Close</button></div>
</div></div>

<div id="taxModal" class="modal"><div><div class="modal-title">‚öôÔ∏è Tax</div>
<div id="taxContent" style="max-height:400px;overflow-y:auto;padding:15px;background:#444;border-radius:3px;margin-bottom:20px"></div>
<div class="modal-actions"><button class="btn-cancel" onclick="closeAll()">‚úó Close</button></div>
</div></div>

<div id="vendorModal" class="modal"><div><div class="modal-title">üè¢ Vendors</div>
<div id="vendorsList" style="max-height:300px;overflow-y:auto;padding:15px;background:#444;border-radius:3px"></div>
<div class="modal-actions"><button class="btn-cancel" onclick="closeAll()">‚úó Close</button></div>
</div></div>

<div id="expenseModal" class="modal"><div><div class="modal-title">üí∞ Expense</div>
<div class="modal-field"><label class="modal-label">Type</label><select id="expenseType" class="modal-input"><option>Maintenance</option><option>Repair</option><option>Purchase</option></select></div>
<div class="modal-field"><label class="modal-label">Property</label><select id="expenseProperty" class="modal-input"></select></div>
<div class="modal-field"><label class="modal-label">Vendor</label><select id="expenseVendor" class="modal-input"></select></div>
<div class="modal-field"><label class="modal-label">Amount</label><input type="number" id="expenseAmount" class="modal-input" step="0.01"></div>
<div class="modal-field"><label class="modal-label">Notes</label><input type="text" id="expenseNotes" class="modal-input"></div>
<div class="modal-actions"><button class="btn-add" onclick="submitExpense()">Add</button><button class="btn-cancel" onclick="closeAll()">Close</button></div>
</div></div>

<div class="main"><div id="content" class="page"><div class="invoice-header"><div class="company-info"><div class="company-name">OCEAN VACATIONS</div><div>oceanvacationsmb@gmail.com</div><div>843-222-6516</div></div><div id="statementDate"></div><div id="periodDate"></div></div><div class="report-title">RESERVATION REPORT</div><div class="owner-name" id="ownerTitle"></div><div id="mainContent"><div style="text-align:center;padding:40px">Loading...</div></div></div></div>

<script>
const GITHUB_URL="https://raw.githubusercontent.com/oceanvacationsmb/reports/main/data.json";
let data={},OWNERS={},vendors=[],expenses=[],csvData=[],propertySettings={},currentOwner="",masterTotals={},propertyTotals={};
const municipalities=["SC","MB","NMB","SSB","HC"];

async function loadGitHub(){try{const e=await fetch(GITHUB_URL+"?t="+Date.now());if(!e.ok)throw new Error(e.status);data=await e.json();console.log("Loaded data:",data);if(data.owners)OWNERS=data.owners;if(data.vendors)vendors=data.vendors;if(data.properties)propertySettings=data.properties;if(data.expenses)expenses=data.expenses;buildUI()}catch(e){console.error("Error:",e);document.getElementById("mainContent").innerHTML="<p style='color:red'>Error loading: "+e.message+"</p>"}}

function buildUI(){buildOwners();buildMonths();buildYears();updateVendors();document.getElementById("mainContent").innerHTML="<div style='text-align:center;padding:40px'>Ready!"}

function buildOwners(){const e=document.getElementById("ownerSelect");e.innerHTML='<option value="">--Select--</option>';for(let n in OWNERS){e.innerHTML+="<option>"+n+"</option>"}}

function buildMonths(){const e=document.getElementById("monthSelect");const n=["January","February","March","April","May","June","July","August","September","October","November","December"];for(let t in n){e.innerHTML+="<option value='"+(parseInt(t)+1)+"'>"+n[t]+"</option>"}e.value=new Date().getMonth()+1}

function buildYears(){const e=document.getElementById("yearSelect");const n=new Date().getFullYear();for(let t=n-2;t<=n+2;t++){e.innerHTML+="<option>"+t+"</option>"}e.value=n}

function onOwnerChange(){currentOwner=document.getElementById("ownerSelect").value}

function openOwners(){const e=document.getElementById("ownersList");let n="";for(let t in OWNERS){const a=OWNERS[t];n+="<div style='background:#555;padding:10px;margin:8px 0'><strong>"+t+"</strong><br><span style='font-size:10px;color:#aaa'>Email: "+(a.email||"N/A")+"</span><br><span style='font-size:10px;color:#aaa'>"+a.percent*100+"% | "+a.type+"</span></div>"}e.innerHTML=n;openModal("ownerModal")}

function addOwner(){const e=document.getElementById("ownerNameInput").value;const n=document.getElementById("ownerEmailInput").value;const t=parseFloat(document.getElementById("ownerCommInput").value)/100;const a=parseFloat(document.getElementById("ownerSalesInput").value);const s=document.getElementById("ownerTypeInput").value;if(!e)return;OWNERS[e]={email:n,percent:t,salesFeePercent:a,type:s};document.getElementById("ownerNameInput").value="";buildOwners();saveGitHub();openOwners()}

function openTax(){const e=document.getElementById("taxContent");let n="";for(let t in OWNERS){n+="<div style='background:#555;padding:10px;margin:8px 0'><strong>"+t+"</strong><br>";for(let a in municipalities){const s=propertySettings[t]&&propertySettings[t][a]?"checked":"";n+="<label style='color:#fff'><input type='checkbox' "+s+" onchange=\"if(!propertySettings['"+t+"'])propertySettings['"+t+"']={};propertySettings['"+t+"']['"+a+"']=this.checked\"> "+a+"</label> "}n+="</div>"}e.innerHTML=n;openModal("taxModal")}

function updateVendors(){const e=document.getElementById("expenseVendor");e.innerHTML="";vendors.forEach(n=>{e.innerHTML+="<option>"+n.name+"</option>"})}

function addVendor(){const e=document.getElementById("vendorName").value;const n=document.getElementById("vendorPhone").value;if(!e)return;vendors.push({name:e,phone:n});document.getElementById("vendorName").value="";document.getElementById("vendorPhone").value="";updateVendors();saveGitHub()}

function showVendors(){const e=document.getElementById("vendorsList");let n="";vendors.forEach(t=>{n+="<div style='background:#555;padding:10px;margin:8px 0'><strong>"+t.name+"</strong><br><span style='font-size:10px;color:#aaa'>"+t.phone+"</span></div>"});e.innerHTML=n;openModal("vendorModal")}

function openAddExpense(){if(!currentOwner)return;const e=document.getElementById("expenseProperty");e.innerHTML="<option>--Select--</option>";for(let n in propertyTotals){e.innerHTML+="<option>"+n+"</option>"}openModal("expenseModal")}

function submitExpense(){const e=document.getElementById("expenseType").value;const n=document.getElementById("expenseProperty").value;const t=document.getElementById("expenseVendor").value;const a=parseFloat(document.getElementById("expenseAmount").value);expenses.push({owner:currentOwner,type:e,property:n,vendor:t,amount:a,notes:document.getElementById("expenseNotes").value});closeAll();saveGitHub()}

function setupGitHub(){const e=prompt("GitHub Token:");if(e)localStorage.setItem("github_token",e),loadGitHub()}

function setupDropbox(){const e=prompt("Dropbox Token:");if(e)localStorage.setItem("dropbox_token",e)}

async function saveGitHub(){const e=localStorage.getItem("github_token");if(!e)return;try{const n=JSON.stringify({owners:OWNERS,vendors:vendors,properties:propertySettings,expenses:expenses},null,2);const t=btoa(unescape(encodeURIComponent(n)));const a=await fetch("https://api.github.com/repos/oceanvacationsmb/reports/contents/data.json",{headers:{"Authorization":"token "+e}});const s=await a.json();await fetch("https://api.github.com/repos/oceanvacationsmb/reports/contents/data.json",{method:"PUT",headers:{"Authorization":"token "+e,"Content-Type":"application/json"},body:JSON.stringify({message:"Update",content:t,sha:s.sha})})}catch(e){console.error(e)}}

function generateStatement(){const e=document.getElementById("csvFile").files[0];if(!e||!currentOwner)return;const n=new FileReader();n.onload=t=>{csvData=Papa.parse(t.target.result,{header:true,skipEmptyLines:true}).data;const a=parseInt(document.getElementById("monthSelect").value);const s=parseInt(document.getElementById("yearSelect").value);const r=new Date(s,a,0).getDate();let i=a+1,o=s;if(i>12){i=1;o++}document.getElementById("statementDate").innerHTML="<strong>"+["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][i-1]+" 1, "+o+"</strong>";document.getElementById("periodDate").innerHTML="<strong>"+["January","February","March","April","May","June","July","August","September","October","November","December"][a-1]+" 1-"+r+", "+s+"</strong>";document.getElementById("ownerTitle").textContent=currentOwner;processData(a,s);displayStatement()};n.readAsText(e)}

function processData(e,n){const t=OWNERS[currentOwner];propertyTotals={};masterTotals={gross:0,acc:0,clean:0,pmc:0};let a={};csvData.forEach(t=>{if(!t["CHECK-IN DATE"])return;const s=parseInt(t["CHECK-IN DATE"].split("-")[1]),r=parseInt(t["CHECK-IN DATE"].split("-")[0]);if(s!==e||r!==n)return;const i=t["LISTING'S NICKNAME"]||"Unknown";if(!a[i])a[i]=[];a[i].push(t)});for(let e in a){let n=0,s=0,r=0,i=0;a[e].forEach(e=>{const a=parseFloat((e["TOTAL PAYOUT"]||"0").replace(/[$,]/g,""));const d=parseFloat((e["ACCOMMODATION FARE"]||"0").replace(/[$,]/g,""))-parseFloat((e["MARKUP"]||"0").replace(/[$,]/g,""));const c=(e["STATUS"]||"").toLowerCase().includes("cancelled")?0:parseFloat((e["CLEANING FARE"]||"0").replace(/[$,]/g,""));const o=d*t.percent;n+=a;s+=d;r+=c;i+=o});propertyTotals[e]={gross:n,acc:s,clean:r,pmc:i,reservations:a[e]};masterTotals.gross+=n;masterTotals.acc+=s;masterTotals.clean+=r;masterTotals.pmc+=i}}

function displayStatement(){let e="<button class='copy-link-btn' onclick='generateLink()'>üîó Generate Link</button>";e+="<div class='summary-grid'>";e+="<div class='summary-card'><div class='summary-label'>Accommodation</div><div class='summary-value'>$"+masterTotals.acc.toFixed(2)+"</div></div>";e+="<div class='summary-card'><div class='summary-label'>PMC</div><div class='summary-value'>$"+masterTotals.pmc.toFixed(2)+"</div></div>";e+="<div class='summary-card'><div class='summary-label'>Clean</div><div class='summary-value'>$"+masterTotals.clean.toFixed(2)+"</div></div>";e+="</div>";for(let n in propertyTotals){const t=propertyTotals[n];e+="<div class='property-section'><div class='property-title'>"+n+"</div><table><tr><th>Code</th><th>Check-in</th><th>Accommodation</th></tr>";t.reservations.forEach(n=>{e+="<tr><td>"+(n["CONFIRMATION CODE"]||"").substring(0,8)+"</td><td>"+(n["CHECK-IN DATE"]||"")+"</td><td>$"+(parseFloat((n["ACCOMMODATION FARE"]||"0").replace(/[$,]/g,""))-parseFloat((n["MARKUP"]||"0").replace(/[$,]/g,""))).toFixed(2)+"</td></tr>"});e+="</table></div>"}document.getElementById("mainContent").innerHTML=e}

function generateSummary(){document.getElementById("mainContent").innerHTML="<button class='back-btn' onclick='displayStatement()'>Back</button><h2>Commission: $"+masterTotals.pmc.toFixed(2)+"</h2>"}

function generateAnnual(){document.getElementById("mainContent").innerHTML="<button class='back-btn' onclick='displayStatement()'>Back</button><h2>Annual: $"+masterTotals.acc.toFixed(2)+"</h2>"}

async function generateLink(){const e=localStorage.getItem("dropbox_token");if(!e)return alert("Setup Dropbox");const n=currentOwner+"_"+new Date().getTime()+".html";const t=document.getElementById("content").innerHTML;try{const a=await fetch("https://content.dropboxapi.com/2/files/upload",{method:"POST",headers:{"Authorization":"Bearer "+e,"Dropbox-API-Arg":JSON.stringify({path:"/statements/"+n,mode:"add"})},body:t});if(a.ok){const s=await fetch("https://www.dropboxapi.com/2/sharing/create_shared_link_with_settings",{method:"POST",headers:{"Authorization":"Bearer "+e,"Content-Type":"application/json"},body:JSON.stringify({path:"/statements/"+n,settings:{requested_visibility:"public"}})});if(s.ok){const n=await s.json();const r=n.url.replace("?dl=0","?dl=1");document.getElementById("mainContent").innerHTML+="<div style='background:#d4edda;padding:15px;margin:20px 0;border-radius:5px'><button class='copy-link-btn' onclick=\"copyToClipboard('"+r+"')\">üìã Copy</button><p style='font-size:11px;word-break:break-all'>"+r+"</p></div>"}}else alert("Error")}catch(e){alert(e)}}

function copyToClipboard(e){navigator.clipboard.writeText(e).then(()=>alert("‚úì Copied"))}

function openModal(e){document.getElementById("modalOverlay").classList.add("show");document.getElementById(e).classList.add("show")}

function closeAll(){document.getElementById("modalOverlay").classList.remove("show");document.querySelectorAll(".modal").forEach(e=>e.classList.remove("show"))}

loadGitHub();
</script>
</body>
</html>
